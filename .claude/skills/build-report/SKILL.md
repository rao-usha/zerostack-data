---
name: build-report
description: Build or restyle a professional HTML report template for the Nexdata report system. Uses the shared design system with Chart.js visualizations, dark/light mode toggle, and flat design. Use when creating a new report, restyling an existing report, or the user asks about report design.
allowed-tools:
  - Bash
  - Read
  - Write
  - Edit
  - Glob
  - Grep
argument-hint: "<new|restyle> [template_name]"
---

Build or restyle Nexdata HTML report templates using the shared design system.

## Overview

Reports are self-contained HTML files generated by Python template classes. Each template has:
- `gather_data(db, params)` — SQL queries that return a data dict
- `render_html(data)` — builds the HTML string using design system helpers
- `render_excel(data)` — openpyxl workbook (not affected by this skill)

Templates live in `app/reports/templates/` and register in `app/reports/builder.py`.

## Design System

All visual components come from `app/reports/design_system.py`. **Never write inline CSS in templates.**

### Key Imports

```python
import json
from app.reports.design_system import (
    html_document, hero_header, kpi_card, kpi_grid,
    section_heading, data_table, pill_badge, profile_card,
    chart_container, chart_init_js, footer,
    build_doughnut_config, build_horizontal_bar_config,
    build_bar_fallback, CHART_COLORS,
)
```

### Component Reference

| Function | Purpose |
|----------|---------|
| `html_document(title, body, charts_js, extra_css)` | Full HTML wrapper with CSS, dark mode, Chart.js CDN |
| `hero_header(title, subtitle, website, pills)` | Dark navy banner; pills = `[{"label": "Type", "value": "PE Firm"}]` |
| `kpi_card(value, label, color)` | Single stat card; colors: `blue`, `emerald`, `slate`, `amber` |
| `kpi_grid(cards_html)` | Responsive grid wrapper for KPI cards |
| `section_heading(title, count)` | `<h2>` with optional count badge |
| `data_table(headers, rows, numeric_columns)` | Full table; `numeric_columns` = set of 0-based indices |
| `pill_badge(text, variant)` | Variants: `public`, `pe`, `sub`, `private`, `default` |
| `profile_card(name, title, initials, badges, bio, experience, education, linkedin)` | Team member card |
| `chart_container(chart_id, config_json, fallback_html)` | Canvas + fallback div |
| `chart_init_js(chart_id, config_json)` | JS snippet for chart init |
| `footer(generated_at, brand)` | Timestamp + brand footer |
| `build_doughnut_config(labels, values, colors)` | Doughnut chart config dict |
| `build_horizontal_bar_config(labels, values, colors, label)` | Horizontal bar config dict |
| `build_bar_fallback(labels, values, colors)` | CSS bar fallback HTML |

## Building a New Template

1. **Create template file** at `app/reports/templates/<name>.py`
2. **Define class** with `name`, `description`, `gather_data()`, `render_html()`, `render_excel()`
3. **In `render_html()`:**
   - Build hero header with `hero_header()`
   - Build KPI cards with `kpi_card()` + `kpi_grid()` — always at the top
   - Build sections with `section_heading()`, `data_table()`, charts, etc.
   - Build charts: create config with `build_doughnut_config()` or `build_horizontal_bar_config()`, serialize to JSON, pass to `chart_container()` + collect `chart_init_js()` snippets
   - Wrap everything with `html_document(title, body, charts_js)`
4. **Register** in `app/reports/builder.py` — import template class, add to `self.templates` dict
5. **Test:** restart API, POST to `/api/v1/reports/generate`, download, open in browser

## Restyling an Existing Template

1. **Read** the existing `render_html()` to understand what data it uses
2. **Add imports** from `app.reports.design_system`
3. **Replace** the method body — remove all inline `<style>` blocks, replace HTML construction with helper calls
4. **Do NOT modify** `gather_data()`, `_get_*()` methods, or `render_excel()`
5. **Test** both HTML and Excel exports after changes

## Chart.js Patterns

### Doughnut (allocation/composition)
```python
config = build_doughnut_config(
    labels=["Tech", "Healthcare", "Finance"],
    values=[12, 8, 5],
)
config_json = json.dumps(config)
body += chart_container("sectorChart", config_json, build_bar_fallback(labels, values))
charts_js += chart_init_js("sectorChart", config_json)
```

### Horizontal Bar (ranked breakdowns)
```python
config = build_horizontal_bar_config(
    labels=["Real Estate", "Credit", "PE"],
    values=[300000, 250000, 180000],
    dataset_label="AUM ($M)",
)
config_json = json.dumps(config)
body += chart_container("aumChart", config_json, build_bar_fallback(labels, values))
charts_js += chart_init_js("aumChart", config_json)
```

### Multiple Charts
Collect all `chart_init_js()` output into a single `charts_js` string. Pass to `html_document(charts_js=charts_js)`.

## Design Rules

- **Flat design:** rounded 12px corners, no card borders, shadow-only elevation
- **KPI cards at top** of every report, immediately after hero
- **Left-border accent** on KPI cards (not top-border)
- **No border-bottom** on section titles
- **Dark/light mode** — all colors use CSS variables; never hardcode colors in templates
- **Chart.js CDN fallback** — always provide `build_bar_fallback()` HTML so charts degrade gracefully
- **Print-friendly** — shadows removed, toggle hidden, charts sized for paper

## File Locations

```
app/reports/
├── design_system.py          # Shared CSS, JS, components (DO NOT DUPLICATE)
├── builder.py                # Template registry + generation engine
├── __init__.py
└── templates/
    ├── __init__.py
    ├── investor_profile.py   # PE firm profile report
    └── portfolio_detail.py   # Portfolio breakdown report
```

## Testing

```bash
# Restart after code changes
docker-compose restart api
# Wait ~25 seconds

# Generate HTML report
curl -s -X POST http://localhost:8001/api/v1/reports/generate \
  -H "Content-Type: application/json" \
  -d '{"template": "investor_profile", "format": "html", "params": {"investor_id": 3, "investor_type": "pe_firm"}}' | python -m json.tool

# Download the report (use the ID from the response)
curl -s http://localhost:8001/api/v1/reports/<ID>/download -o report.html

# Open in browser to verify:
# - Chart.js charts render
# - Dark/light toggle works (click button, refresh — persists)
# - Flat design: no card borders, rounded corners, shadow elevation
# - KPIs at top
# - Print: toggle hidden, shadows removed
```
