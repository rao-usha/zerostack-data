---
name: build-report
description: Build or restyle a professional HTML report template for the Nexdata report system. Uses the shared design system with Chart.js visualizations, dark/light mode toggle, and flat design. Use when creating a new report, restyling an existing report, or the user asks about report design.
allowed-tools:
  - Bash
  - Read
  - Write
  - Edit
  - Glob
  - Grep
argument-hint: "<new|restyle> [template_name]"
---

Build or restyle Nexdata HTML report templates using the shared design system.

## Important References

- **Report style guide:** `.claude/skills/report-style/SKILL.md` — structure, components, writing guidelines
- **CSS reference:** `.claude/skills/report-style/css_reference.md` — full CSS with dark mode
- **Chart.js conventions:** `.claude/skills/report-style/chartjs_conventions.md` — color palette, chart types, dark mode IIFE
- **Design system code:** `app/reports/design_system.py` — shared CSS, JS, and Python component helpers

## Overview

Reports are self-contained HTML files generated by Python template classes. Each template has:
- `gather_data(db, params)` — SQL queries that return a data dict
- `render_html(data)` — builds the HTML string using design system helpers
- `render_excel(data)` — openpyxl workbook (not affected by this skill)

Templates live in `app/reports/templates/` and register in `app/reports/builder.py`.

## Design System

All visual components come from `app/reports/design_system.py`. **Never write inline CSS in templates.**

### Key Imports

```python
import json
from app.reports.design_system import (
    html_document, page_header, kpi_strip, kpi_card,
    toc, section_start, section_end,
    data_table, pill_badge, profile_card, callout,
    chart_container, chart_init_js, page_footer,
    build_doughnut_config, build_horizontal_bar_config,
    build_bar_fallback, build_chart_legend, CHART_COLORS,
)
```

### Component Reference

| Function | Purpose |
|----------|---------|
| `html_document(title, body, charts_js, extra_css)` | Full HTML wrapper with CSS, dark mode, Chart.js CDN |
| `page_header(title, subtitle, badge)` | Gradient banner with dark mode toggle and optional badge |
| `kpi_strip(cards_html)` | KPI card grid that overlaps the header |
| `kpi_card(label, value, delta, delta_dir)` | Single KPI card; delta_dir: `up`, `down`, `neutral` |
| `toc(items)` | Table of contents; items = `[{"number": 1, "id": "sec-id", "title": "Title"}]` |
| `section_start(number, title, section_id)` | Open numbered section card |
| `section_end()` | Close numbered section card |
| `data_table(headers, rows, numeric_columns, footer_row)` | Table with `.data-table` styling |
| `callout(content, variant)` | Callout box; variants: `info`, `warn`, `good` |
| `pill_badge(text, variant)` | Variants: `public`, `pe`, `sub`, `private`, `default` |
| `profile_card(name, title, initials, badges, bio, experience, education, linkedin)` | Team member card |
| `chart_container(chart_id, config_json, fallback_html, size, title, height)` | Canvas + fallback; size: `tall`/`medium`/`short` |
| `chart_init_js(chart_id, config_json)` | JS snippet for chart init |
| `page_footer(notes, generated_line)` | Footer with data quality notes and generation stamp |
| `build_doughnut_config(labels, values, colors)` | Doughnut chart config dict |
| `build_horizontal_bar_config(labels, values, colors, label)` | Horizontal bar config dict |
| `build_bar_fallback(labels, values, color)` | CSS bar fallback HTML |
| `build_chart_legend(labels, values, colors, value_suffix, show_pct)` | Custom HTML legend for charts |

## Building a New Template

1. **Read** `.claude/skills/report-style/` for CSS reference, Chart.js conventions, and style guide
2. **Create template file** at `app/reports/templates/<name>.py`
3. **Define class** with `name`, `description`, `gather_data()`, `render_html()`, `render_excel()`
4. **In `render_html()`:**
   - `page_header()` — gradient banner with title, subtitle, badge
   - `kpi_strip()` + `kpi_card()` — 5 KPI cards overlapping header
   - `toc()` — table of contents linking to sections
   - `section_start()` / `section_end()` — numbered section cards
   - Inside sections: narrative `<p>`, `data_table()`, chart_row, `callout()`
   - Charts using `chart_container()` + `chart_init_js()`
   - `page_footer()` — data quality notes + generation stamp
   - Wrap everything with `html_document(title, body, charts_js)`
5. **Register** in `app/reports/builder.py` — import template class, add to `self.templates` dict
6. **Test:** restart API, POST to `/api/v1/reports/generate`, download, open in browser

## Restyling an Existing Template

1. **Read** the existing `render_html()` to understand what data it uses
2. **Update imports** from `app.reports.design_system` to use new function names
3. **Replace** the method body using the design system components
4. **Do NOT modify** `gather_data()`, `_get_*()` methods, or `render_excel()`
5. **Test** both HTML and Excel exports after changes

## Chart.js Patterns

Follow `.claude/skills/report-style/chartjs_conventions.md` for all Chart.js usage. Key rules:
- Color palette: BLUE (`#2b6cb0`) primary, GRAY (`#a0aec0`) comparison, ORANGE accent
- All charts: `responsive: true`, `maintainAspectRatio: false`
- Bar charts: `borderRadius: 4`, grid `#edf2f7`, hide legend for single datasets
- Doughnuts: `cutout: '50%'`, `borderWidth: 2`, `borderColor: '#ffffff'`
- Always format tooltips and axis ticks with proper units

### Doughnut (allocation/composition)
```python
config = build_doughnut_config(labels, values, colors)
config_json = json.dumps(config)
body += '<div class="chart-row">'
body += '<div>'
body += chart_container("sectorChart", config_json, build_bar_fallback(labels, values), size="medium", title="Sector Distribution")
charts_js += chart_init_js("sectorChart", config_json)
body += '</div>'
body += '<div>'
body += build_chart_legend(labels, values, colors, show_pct=True)
body += '</div>'
body += '</div>'
```

### Horizontal Bar (ranked breakdowns)
```python
config = build_horizontal_bar_config(labels, values, dataset_label="AUM ($M)")
config_json = json.dumps(config)
height = f"{max(len(labels) * 48 + 40, 140)}px"
body += chart_container("aumChart", config_json, build_bar_fallback(labels, values), title="AUM by Segment", height=height)
charts_js += chart_init_js("aumChart", config_json)
```

### Multiple Charts
Collect all `chart_init_js()` output into a single `charts_js` string. Pass to `html_document(charts_js=charts_js)`.

## Report Structure

Every report follows this anatomy (matching `.claude/skills/report-style/SKILL.md`):
1. **Page header** — gradient banner with title, subtitle, toggle, badge
2. **KPI strip** — 5 elevated cards overlapping the header
3. **Table of contents** — compact card with numbered section links
4. **Numbered sections** — white cards with circled numbers, containing narrative, charts, tables, callouts
5. **Footer** — data quality notes + generation stamp

## Design Rules

- **KPI cards overlap the header** via negative margin (`margin: -32px 0 32px 0`)
- **No border accents** on cards — clean white cards with shadow only
- **Dark/light mode** — CSS variables + toggle switch (pill style with sun/moon icons)
- **Chart.js CDN fallback** — always provide `build_bar_fallback()` HTML
- **Print-friendly** — shadows removed, toggle hidden
- **Sections are numbered** — circled numbers in headers, matching TOC

## File Locations

```
.claude/skills/
├── report-style/
│   ├── SKILL.md                 # Full style guide (structure, components, writing)
│   ├── css_reference.md         # CSS with dark mode (READ FIRST)
│   └── chartjs_conventions.md   # Chart.js palette, patterns, dark mode IIFE
├── build-report/
│   └── SKILL.md                 # This file (Nexdata template building guide)
app/reports/
├── design_system.py             # Shared CSS, JS, components (DO NOT DUPLICATE)
├── builder.py                   # Template registry + generation engine
├── __init__.py
└── templates/
    ├── __init__.py
    ├── investor_profile.py      # PE firm profile report
    └── portfolio_detail.py      # Portfolio breakdown report
```

## Testing

```bash
# Restart after code changes
docker-compose restart api
# Wait ~25 seconds

# Generate HTML report
curl -s -X POST http://localhost:8001/api/v1/reports/generate \
  -H "Content-Type: application/json" \
  -d '{"template": "investor_profile", "format": "html", "params": {"investor_id": 3, "investor_type": "pe_firm"}}' | python -m json.tool

# Download the report (use the ID from the response)
curl -s http://localhost:8001/api/v1/reports/<ID>/download -o report.html

# Open in browser to verify:
# - Chart.js charts render with correct palette
# - Dark/light toggle works (pill switch, persists)
# - Numbered sections with TOC navigation
# - KPIs overlapping header
# - Print: toggle hidden, shadows removed
```
