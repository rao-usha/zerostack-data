x-api-keys: &api-keys
  CENSUS_SURVEY_API_KEY: ${CENSUS_SURVEY_API_KEY:-}
  FRED_API_KEY: ${FRED_API_KEY:-}
  BLS_API_KEY: ${BLS_API_KEY:-}
  KAGGLE_USERNAME: ${KAGGLE_USERNAME:-}
  KAGGLE_KEY: ${KAGGLE_KEY:-}
  KAGGLE_DATA_DIR: /app/data/kaggle
  DATA_GOV_API: ${DATA_GOV_API:-}
  BEA_API_KEY: ${BEA_API_KEY:-}
  BTS_APP_TOKEN: ${BTS_APP_TOKEN:-}
  USDA_API_KEY: ${USDA_API_KEY:-}
  DATA_COMMONS_API_KEY: ${DATA_COMMONS_API_KEY:-}
  YELP_API_KEY: ${YELP_API_KEY:-}
  OPENAI_API_KEY: ${OPENAI_API_KEY:-}
  ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
  EIA_API_KEY: ${EIA_API_KEY:-}
  # AI / LLM providers
  GEMINI_API_KEY: ${GEMINI_API_KEY:-}
  XAI_API_KEY: ${XAI_API_KEY:-}
  DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
  GROQ_API_KEY: ${GROQ_API_KEY:-}
  MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
  COHERE_API_KEY: ${COHERE_API_KEY:-}
  PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
  # Search & Web
  GITHUB_TOKEN: ${GITHUB_TOKEN:-}
  GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
  GOOGLE_CSE_ID: ${GOOGLE_CSE_ID:-}
  SIMILARWEB_API_KEY: ${SIMILARWEB_API_KEY:-}
  OPENCORPORATES_API_KEY: ${OPENCORPORATES_API_KEY:-}
  PEERINGDB_API_KEY: ${PEERINGDB_API_KEY:-}
  # Business Intelligence
  CRUNCHBASE_API_KEY: ${CRUNCHBASE_API_KEY:-}
  NEWSAPI_KEY: ${NEWSAPI_KEY:-}
  LINKEDIN_API_KEY: ${LINKEDIN_API_KEY:-}
  # Financial & Market Data
  FMP_API_KEY: ${FMP_API_KEY:-}
  ALPHA_VANTAGE_API_KEY: ${ALPHA_VANTAGE_API_KEY:-}
  POLYGON_API_KEY: ${POLYGON_API_KEY:-}
  FINNHUB_API_KEY: ${FINNHUB_API_KEY:-}
  TIINGO_API_KEY: ${TIINGO_API_KEY:-}
  QUANDL_API_KEY: ${QUANDL_API_KEY:-}
  # Enrichment
  HUNTER_API_KEY: ${HUNTER_API_KEY:-}
  CLEARBIT_API_KEY: ${CLEARBIT_API_KEY:-}
  ZOOMINFO_API_KEY: ${ZOOMINFO_API_KEY:-}
  PITCHBOOK_API_KEY: ${PITCHBOOK_API_KEY:-}

services:
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_USER: nexdata
      POSTGRES_PASSWORD: nexdata_dev_password
      POSTGRES_DB: nexdata
    ports:
      - "5434:5432"  # Use port 5434 on host to avoid conflict
    volumes:
      - postgres_data:/var/lib/postgresql/data  # Named volume for data persistence
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nexdata"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build:
      context: .
      args:
        # Set to 1 to install Playwright browsers (~500MB) for JS-rendered page scraping
        INSTALL_BROWSERS: ${INSTALL_BROWSERS:-0}
    ports:
      - "8001:8000"  # Use port 8001 on host to avoid conflicts
    environment:
      DATABASE_URL: postgresql://nexdata:nexdata_dev_password@postgres:5432/nexdata
      <<: *api-keys
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-}
      MAX_CONCURRENCY: 4
      LOG_LEVEL: INFO
      BROWSER_HEADED: ${BROWSER_HEADED:-0}
      # Set to "1" to route jobs through the queue instead of BackgroundTasks
      WORKER_MODE: ${WORKER_MODE:-1}
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./app:/app/app
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
      - ./data/kaggle:/app/data/kaggle
      - ./data/seeds:/app/data/seeds
      - ./scripts:/app/scripts
      - ./.kaggle:/home/appuser/.kaggle:ro
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000

  worker:
    build:
      context: .
      args:
        INSTALL_BROWSERS: ${INSTALL_BROWSERS:-0}
    environment:
      DATABASE_URL: postgresql://nexdata:nexdata_dev_password@postgres:5432/nexdata
      <<: *api-keys
      WORKER_MODE: "1"
      WORKER_POLL_INTERVAL: "2.0"
      WORKER_MAX_CONCURRENT: "4"
      MAX_CONCURRENCY: 4
      LOG_LEVEL: INFO
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./app:/app/app
      - ./data/seeds:/app/data/seeds
    command: python -m app.worker.main
    # Scale with: docker-compose up --scale worker=4
    deploy:
      replicas: 2

  frontend:
    image: nginx:alpine
    ports:
      - "3001:80"
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api

volumes:
  postgres_data:
