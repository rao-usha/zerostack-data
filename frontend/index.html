<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexdata - Investment Intelligence</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --primary: #6366f1;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --accent: #06b6d4;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .tagline { color: var(--text-muted); font-size: 0.875rem; }
        .status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text-muted); }
        .health-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--error); }
        .health-dot.healthy { background: var(--success); }
        .tabs {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }
        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.875rem;
        }
        .tab:hover { background: var(--bg-input); color: var(--text); }
        .tab.active { background: var(--primary); border-color: var(--primary); color: white; }
        .content { padding: 2rem; max-width: 1400px; margin: 0 auto; padding-bottom: 5rem; }
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }
        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .search-input::placeholder { color: var(--text-muted); }
        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .btn:hover { background: #4f46e5; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--bg-input); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .stat-card { background: var(--bg-input); padding: 1rem; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .loading { text-align: center; padding: 2rem; color: var(--text-muted); }
        .empty { text-align: center; padding: 2rem; color: var(--text-muted); }
        .hidden { display: none; }
        .footer {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            font-size: 0.875rem;
            color: var(--text-muted);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        .footer a { color: var(--accent); text-decoration: none; }

        /* ===== Data Sources Styles ===== */
        .ds-hero { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .ds-hero-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; text-align: center; }
        .ds-hero-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .ds-hero-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-top: 0.25rem; }

        .ds-legend { display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1.5rem; padding: 1rem 1.25rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .ds-legend-section { display: flex; flex-direction: column; gap: 0.375rem; }
        .ds-legend-title { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); font-weight: 600; }
        .ds-legend-items { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .ds-legend-item { display: flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; color: var(--text-muted); }
        .ds-legend-item .ds-dot { margin-right: 0; }
        .ds-date-sub { font-size: 0.7rem; color: var(--text-muted); display: block; margin-top: 0.125rem; }

        .ds-alerts { background: rgba(239,68,68,0.1); border: 1px solid var(--error); border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1.5rem; }
        .ds-alert-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; padding: 0.25rem 0; }
        .ds-alert-sev { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; font-size: 0.65rem; font-weight: 700; flex-shrink: 0; }
        .ds-alert-sev.critical { background: var(--error); color: white; }
        .ds-alert-sev.warning { background: var(--warning); color: white; }
        .ds-alert-sev.info { background: var(--accent); color: white; }

        .ds-toolbar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; }

        .ds-category { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 1rem; overflow: hidden; }
        .ds-cat-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; cursor: pointer; user-select: none; transition: background 0.15s; }
        .ds-cat-header:hover { background: var(--bg-input); }
        .ds-cat-left { display: flex; align-items: center; gap: 0.75rem; }
        .ds-chevron { font-size: 0.75rem; color: var(--text-muted); width: 1rem; transition: transform 0.2s; }
        .ds-cat-title { font-weight: 600; font-size: 1rem; }
        .ds-cat-count { color: var(--text-muted); font-size: 0.875rem; }
        .ds-badge-active { background: rgba(34,197,94,0.15); color: var(--success); font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.625rem; border-radius: 10px; }
        .ds-cat-body { padding: 0 1.25rem 1.25rem; }

        .ds-table { width: 100%; border-collapse: collapse; }
        .ds-table th { text-align: left; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); font-weight: 500; }
        .ds-table td { padding: 0.625rem 0.5rem; border-bottom: 1px solid rgba(51,65,85,0.5); font-size: 0.875rem; }
        .ds-table tbody tr:last-child td { border-bottom: none; }
        .ds-table tbody tr:hover { background: rgba(99,102,241,0.04); }

        .ds-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 0.5rem; vertical-align: middle; }
        .ds-dot.ok { background: var(--success); }
        .ds-dot.stale { background: var(--warning); }
        .ds-dot.error { background: var(--error); }
        .ds-dot.idle { background: var(--text-muted); }

        .ds-status-text { font-size: 0.75rem; text-transform: capitalize; }
        .ds-status-text.ok { color: var(--success); }
        .ds-status-text.stale { color: var(--warning); }
        .ds-status-text.error { color: var(--error); }
        .ds-status-text.idle { color: var(--text-muted); }

        .ds-domain-group { background: var(--bg-input); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; }
        .ds-domain-header { font-weight: 600; font-size: 0.875rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; text-transform: capitalize; }
        .ds-domain-count { background: var(--bg-card); color: var(--text-muted); font-size: 0.7rem; font-weight: 500; padding: 0.125rem 0.5rem; border-radius: 8px; }

        .ds-activity { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-top: 1.5rem; }
        .ds-activity-header { font-weight: 600; font-size: 1rem; margin-bottom: 1rem; }
        .ds-act-item { display: flex; gap: 0.75rem; padding: 0.5rem 0; font-size: 0.875rem; border-bottom: 1px solid rgba(51,65,85,0.3); align-items: baseline; }
        .ds-act-item:last-child { border-bottom: none; }
        .ds-act-time { color: var(--text-muted); white-space: nowrap; min-width: 60px; font-size: 0.8rem; }
        .ds-act-trigger { background: var(--bg-input); padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.75rem; }
        .ds-act-job { color: var(--text-muted); font-size: 0.8rem; }

        .ds-table tbody tr { cursor: pointer; }
        .ds-table tbody tr:hover { background: rgba(99,102,241,0.08); }

        /* Detail view */
        .ds-detail-back { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--accent); cursor: pointer; font-size: 0.875rem; margin-bottom: 1rem; background: none; border: none; padding: 0.5rem 0; }
        .ds-detail-back:hover { text-decoration: underline; }
        .ds-detail-header { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .ds-detail-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.75rem; }
        .ds-detail-meta { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.75rem; }
        .ds-detail-chip { background: var(--bg-input); padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.8rem; color: var(--text-muted); }
        .ds-detail-tables { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .ds-detail-tables h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }
        .ds-detail-table-row { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--bg-input); border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; transition: background 0.15s; }
        .ds-detail-table-row:hover { background: var(--border); }
        .ds-detail-table-row.active { background: rgba(99,102,241,0.15); border: 1px solid var(--primary); }
        .ds-detail-table-name { font-weight: 600; font-size: 0.9rem; }
        .ds-detail-table-stats { display: flex; gap: 1.5rem; font-size: 0.8rem; color: var(--text-muted); }
        .ds-detail-schema { background: var(--bg-input); border-radius: 8px; padding: 1rem; margin-top: 0.75rem; font-family: 'Monaco','Menlo','Consolas',monospace; font-size: 0.8rem; color: var(--text-muted); line-height: 1.6; }
        .ds-detail-schema span { color: var(--accent); }
        .ds-detail-preview { margin-top: 1rem; overflow-x: auto; }
        .ds-detail-preview table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 600px; }
        .ds-detail-preview th { text-align: left; padding: 0.5rem 0.75rem; background: var(--bg-card); color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border); position: sticky; top: 0; white-space: nowrap; }
        .ds-detail-preview td { padding: 0.5rem 0.75rem; border-bottom: 1px solid rgba(51,65,85,0.3); white-space: nowrap; max-width: 250px; overflow: hidden; text-overflow: ellipsis; }
        .ds-detail-preview tr:hover td { background: rgba(99,102,241,0.04); }
        .ds-detail-pagination { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted); }
        .ds-detail-pagination button { padding: 0.375rem 0.75rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 0.8rem; }
        .ds-detail-pagination button:hover:not(:disabled) { background: var(--border); }
        .ds-detail-pagination button:disabled { opacity: 0.4; cursor: not-allowed; }
        .ds-detail-actions { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .ds-detail-actions h3 { width: 100%; font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .ds-preview-loading { text-align: center; padding: 2rem; color: var(--text-muted); }

        @media (max-width: 768px) {
            .ds-hero { grid-template-columns: repeat(2, 1fr); }
            .ds-table th:nth-child(3), .ds-table td:nth-child(3),
            .ds-table th:nth-child(4), .ds-table td:nth-child(4) { display: none; }
        }

        /* ===== Settings Styles ===== */
        .key-filter-box { position: relative; margin-bottom: 1.25rem; }
        .key-filter-input {
            width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem;
            background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px;
            color: var(--text); font-size: 0.9rem;
        }
        .key-filter-input:focus { outline: none; border-color: var(--primary); }
        .key-filter-input::placeholder { color: var(--text-muted); }
        .key-filter-icon { position: absolute; left: 0.85rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem; pointer-events: none; }
        .key-category { margin-bottom: 1rem; }
        .key-category-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0.6rem 0.75rem; border-radius: 8px; margin-bottom: 0.5rem; transition: background 0.15s; user-select: none; }
        .key-category-header:hover { background: var(--bg-input); }
        .key-category-title { font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent); display: flex; align-items: center; gap: 0.5rem; }
        .key-category-title .chevron { transition: transform 0.2s; font-size: 0.7rem; }
        .key-category-title .chevron.collapsed { transform: rotate(-90deg); }
        .key-category-count { font-size: 0.75rem; color: var(--text-muted); font-weight: 400; }
        .key-category-count .configured-num { color: var(--success); font-weight: 600; }
        .key-category-body { overflow: hidden; transition: max-height 0.3s ease; }
        .key-category-body.collapsed { max-height: 0 !important; }
        .key-row { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; background: var(--bg-input); border-radius: 8px; margin-bottom: 0.5rem; }
        .key-status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .key-status-dot.configured { background: var(--success); }
        .key-status-dot.missing { background: var(--border); }
        .key-info { flex: 1; min-width: 0; }
        .key-name { font-weight: 600; font-size: 0.875rem; }
        .key-desc { font-size: 0.75rem; color: var(--text-muted); }
        .key-masked { font-family: 'Monaco','Menlo',monospace; font-size: 0.75rem; color: var(--text-muted); background: var(--bg); padding: 0.25rem 0.5rem; border-radius: 4px; }
        .key-source-badge { font-size: 0.625rem; padding: 0.125rem 0.375rem; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.05em; }
        .key-source-badge.db { background: rgba(99,102,241,0.2); color: var(--primary); }
        .key-source-badge.env { background: rgba(249,115,22,0.2); color: #f97316; }
        .key-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; }
        .btn-sm:hover { background: var(--bg-card); color: var(--text); }
        .btn-sm.primary { background: var(--primary); border-color: var(--primary); color: white; }
        .btn-sm.primary:hover { opacity: 0.9; }
        .btn-sm.danger { color: var(--error); }
        .btn-sm.danger:hover { background: rgba(239,68,68,0.1); }
        .key-edit-row { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; }
        .key-edit-input { flex: 1; padding: 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Monaco','Menlo',monospace; font-size: 0.8rem; }
        .key-edit-input:focus { outline: none; border-color: var(--primary); }
        .test-result { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; margin-top: 0.25rem; }
        .test-result.success { background: rgba(34,197,94,0.1); color: var(--success); }
        .test-result.failure { background: rgba(239,68,68,0.1); color: var(--error); }

        /* Inline endpoint docs panel */
        .ep-docs-panel {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            margin: 0.25rem 0 0.75rem 0;
            animation: epSlideDown 0.2s ease-out;
        }
        @keyframes epSlideDown {
            from { opacity: 0; max-height: 0; padding: 0 1.25rem; }
            to { opacity: 1; max-height: 2000px; padding: 1.25rem; }
        }
        .ep-docs-section { margin-bottom: 1rem; }
        .ep-docs-section:last-child { margin-bottom: 0; }
        .ep-docs-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        .ep-docs-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }
        .ep-docs-desc p { margin-bottom: 0.5rem; }
        .ep-docs-desc strong { color: var(--text); }
        .ep-docs-desc code { background: var(--bg-input); padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.8rem; }
        .ep-docs-desc ul { margin: 0.25rem 0 0.5rem 1.25rem; }
        .ep-docs-desc li { margin-bottom: 0.25rem; }
        .ep-params-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .ep-params-table th {
            text-align: left;
            padding: 0.375rem 0.5rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
        }
        .ep-params-table td {
            padding: 0.375rem 0.5rem;
            border-bottom: 1px solid rgba(51,65,85,0.5);
            vertical-align: top;
        }
        .ep-params-table .param-name { font-family: monospace; color: var(--accent); font-weight: 500; }
        .ep-params-table .param-required { color: var(--error); font-weight: 700; }
        .ep-params-table .param-type { color: var(--warning); font-family: monospace; font-size: 0.75rem; }
        .ep-schema-block, .ep-curl-block {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            font-family: 'Monaco','Menlo','Consolas',monospace;
            font-size: 0.78rem;
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .ep-schema-block .key { color: var(--accent); }
        .ep-schema-block .type { color: var(--warning); }
        .ep-schema-block .required-marker { color: var(--error); font-weight: 700; }
        .ep-schema-block .comment { color: var(--text-muted); font-style: italic; }
        .ep-schema-block .nested-toggle { color: var(--primary); cursor: pointer; text-decoration: underline; font-style: normal; }
        .ep-schema-block .nested-toggle:hover { color: var(--accent); }
        .ep-model-name { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.375rem; font-family: monospace; }
        .ep-model-name span { color: var(--primary); font-weight: 600; }
        .ep-response-code { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; font-family: monospace; margin-right: 0.5rem; }
        .ep-response-code.c2xx { background: rgba(34,197,94,0.15); color: var(--success); }
        .ep-response-code.c4xx { background: rgba(245,158,11,0.15); color: var(--warning); }
        .ep-response-code.c5xx { background: rgba(239,68,68,0.15); color: var(--error); }
        .ep-response-block { margin-bottom: 0.75rem; }
        .ep-response-block:last-child { margin-bottom: 0; }
        .ep-response-desc { font-size: 0.8rem; color: var(--text-muted); margin: 0.25rem 0 0.375rem 0; }
        .ep-enum-values { font-size: 0.7rem; color: var(--warning); font-family: monospace; }
        .ep-curl-block { color: var(--success); }
        .ep-loading { text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.85rem; }
        .ep-fallback { padding: 0.75rem; color: var(--text-muted); font-size: 0.85rem; }
        .ep-fallback a { color: var(--accent); }
        .ep-docs-toggle { cursor: pointer; user-select: none; }
        .ep-docs-toggle:hover { color: var(--text) !important; }

        /* ===== Active Jobs Panel ===== */
        .active-jobs-panel {
            background: var(--card-bg, #1e1e2e);
            border: 1px solid var(--border, #333);
            border-radius: 8px;
            margin: 0.5rem 1rem;
            padding: 0.75rem 1rem;
            display: none; /* shown via JS when jobs exist */
        }
        .active-jobs-panel.visible { display: block; }
        .active-jobs-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text, #e0e0e0);
        }
        .pulse-dot {
            width: 8px; height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse-glow 1.5s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(74,222,128,0.5); }
            50% { box-shadow: 0 0 0 6px rgba(74,222,128,0); }
        }
        .active-job-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.4rem 0;
            font-size: 0.8rem;
            color: var(--text-muted, #aaa);
        }
        .active-job-item + .active-job-item {
            border-top: 1px solid var(--border, #333);
        }
        .job-type-badge {
            background: var(--accent, #6366f1);
            color: #fff;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .job-progress-bar {
            flex: 1;
            height: 6px;
            background: var(--border, #333);
            border-radius: 3px;
            overflow: hidden;
            min-width: 80px;
        }
        .job-progress-fill {
            height: 100%;
            background: #4ade80;
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        .job-message {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .job-worker-badge {
            font-size: 0.65rem;
            color: var(--text-muted, #888);
            background: rgba(255,255,255,0.05);
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            white-space: nowrap;
        }
        .job-fade-out {
            animation: job-fade 0.6s ease forwards;
        }
        @keyframes job-fade {
            to { opacity: 0; height: 0; padding: 0; margin: 0; overflow: hidden; }
        }

        /* ===== Jobs Dashboard ===== */
        .jobs-section { margin-bottom: 1.5rem; }
        .jobs-section .card-title { display: flex; align-items: center; gap: 0.5rem; }

        /* Run Collection form */
        .jobs-launcher-row { display: flex; gap: 0.75rem; align-items: flex-end; margin-bottom: 1rem; flex-wrap: wrap; }
        .jobs-launcher-field { display: flex; flex-direction: column; gap: 0.25rem; }
        .jobs-launcher-field label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 500; }
        .jobs-launcher-field select,
        .jobs-launcher-field input,
        .jobs-launcher-field textarea {
            padding: 0.5rem 0.75rem; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; color: var(--text); font-size: 0.875rem;
        }
        .jobs-launcher-field select:focus,
        .jobs-launcher-field input:focus { outline: none; border-color: var(--primary); }
        .jobs-checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem; margin: 0.75rem 0; }
        .jobs-checkbox-grid label {
            display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; color: var(--text-muted);
            cursor: pointer; padding: 0.3rem 0.5rem; border-radius: 4px; transition: background 0.15s;
        }
        .jobs-checkbox-grid label:hover { background: var(--bg-input); color: var(--text); }
        .jobs-checkbox-grid input[type="checkbox"] { accent-color: var(--primary); }
        .jobs-radio-group { display: flex; gap: 1rem; margin: 0.5rem 0; }
        .jobs-radio-group label { display: flex; align-items: center; gap: 0.35rem; font-size: 0.8rem; color: var(--text-muted); cursor: pointer; }
        .jobs-radio-group input[type="radio"] { accent-color: var(--primary); }
        .jobs-options-panel { min-height: 40px; padding: 0.5rem 0; }
        .jobs-run-result { font-size: 0.8rem; margin-top: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 6px; }
        .jobs-run-result.success { background: rgba(34,197,94,0.1); color: var(--success); }
        .jobs-run-result.error { background: rgba(239,68,68,0.1); color: var(--error); }

        /* Active jobs (full-width in Jobs tab) */
        .jobs-active-card .active-job-row {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0;
            border-bottom: 1px solid rgba(51,65,85,0.3); font-size: 0.85rem;
        }
        .jobs-active-card .active-job-row:last-child { border-bottom: none; }
        .jobs-elapsed { font-family: 'SF Mono', 'Consolas', monospace; font-size: 0.8rem; color: var(--accent); min-width: 50px; text-align: right; }
        .jobs-active-empty { text-align: center; padding: 1.5rem; color: var(--text-muted); font-size: 0.85rem; }

        /* History table */
        .jobs-history-toolbar { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
        .jobs-history-toolbar select { padding: 0.4rem 0.6rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8rem; }
        .jobs-summary { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .jobs-summary-item { font-size: 0.8rem; padding: 0.3rem 0.75rem; border-radius: 12px; font-weight: 600; }
        .jobs-summary-item.running { background: rgba(6,182,212,0.15); color: var(--accent); }
        .jobs-summary-item.pending { background: rgba(148,163,184,0.15); color: var(--text-muted); }
        .jobs-summary-item.success { background: rgba(34,197,94,0.12); color: var(--success); }
        .jobs-summary-item.failed { background: rgba(239,68,68,0.12); color: var(--error); }

        .jobs-history-table { width: 100%; border-collapse: collapse; }
        .jobs-history-table th { text-align: left; padding: 0.5rem 0.6rem; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); font-weight: 500; }
        .jobs-history-table td { padding: 0.55rem 0.6rem; border-bottom: 1px solid rgba(51,65,85,0.4); font-size: 0.85rem; }
        .jobs-history-table tbody tr { cursor: pointer; transition: background 0.1s; }
        .jobs-history-table tbody tr:hover { background: rgba(99,102,241,0.06); }

        .job-status-badge { padding: 0.15rem 0.55rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600; text-transform: capitalize; }
        .job-status-badge.success { background: rgba(34,197,94,0.15); color: var(--success); }
        .job-status-badge.failed { background: rgba(239,68,68,0.15); color: var(--error); }
        .job-status-badge.running, .job-status-badge.claimed { background: rgba(6,182,212,0.15); color: var(--accent); }
        .job-status-badge.pending, .job-status-badge.blocked { background: rgba(148,163,184,0.15); color: var(--text-muted); }

        .job-type-pill { padding: 0.15rem 0.55rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .job-type-pill.site_intel { background: rgba(99,102,241,0.15); color: #818cf8; }
        .job-type-pill.people { background: rgba(244,114,182,0.15); color: #f472b6; }
        .job-type-pill.pe { background: rgba(251,146,60,0.15); color: #fb923c; }
        .job-type-pill.lp { background: rgba(52,211,153,0.15); color: #34d399; }
        .job-type-pill.fo { background: rgba(167,139,250,0.15); color: #a78bfa; }
        .job-type-pill.agentic { background: rgba(250,204,21,0.15); color: #facc15; }
        .job-type-pill.ingestion { background: rgba(6,182,212,0.15); color: #06b6d4; }

        .jobs-detail-row td { padding: 0 !important; }
        .jobs-detail-content {
            padding: 0.75rem 1rem; background: var(--bg-input); border-radius: 6px; margin: 0.25rem 0.5rem 0.5rem;
            font-size: 0.8rem; max-height: 300px; overflow-y: auto;
        }
        .jobs-detail-content pre { white-space: pre-wrap; word-break: break-all; color: var(--text-muted); margin: 0.5rem 0; font-size: 0.75rem; }
        .jobs-detail-content .detail-label { font-weight: 600; color: var(--text); margin-right: 0.5rem; }
        .jobs-detail-content .detail-row { margin-bottom: 0.35rem; }

        .jobs-load-more { text-align: center; padding: 0.75rem; }
        .jobs-load-more .btn { font-size: 0.8rem; padding: 0.5rem 1.5rem; }

        /* ===== Source Detail Job Activity ===== */
        .source-jobs-active { margin-bottom: 1rem; }
        .source-jobs-active-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0.75rem;
            background: rgba(6,182,212,0.06); border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.85rem;
        }
        .source-jobs-active-item .job-progress-bar { max-width: 120px; }
        .source-jobs-table { width: 100%; border-collapse: collapse; }
        .source-jobs-table th {
            text-align: left; padding: 0.45rem 0.5rem; font-size: 0.7rem; color: var(--text-muted);
            text-transform: uppercase; border-bottom: 1px solid var(--border); font-weight: 500;
        }
        .source-jobs-table td { padding: 0.5rem 0.5rem; border-bottom: 1px solid rgba(51,65,85,0.3); font-size: 0.82rem; }
        .source-jobs-table tbody tr { cursor: pointer; transition: background 0.1s; }
        .source-jobs-table tbody tr:hover { background: rgba(99,102,241,0.06); }
        .source-jobs-detail td { padding: 0 !important; }
        .source-jobs-detail-inner {
            padding: 0.6rem 0.75rem; background: var(--bg-input); border-radius: 6px; margin: 0.2rem 0.4rem 0.4rem;
            font-size: 0.78rem; max-height: 250px; overflow-y: auto;
        }
        .source-jobs-detail-inner pre { white-space: pre-wrap; word-break: break-all; color: var(--text-muted); margin: 0.4rem 0; font-size: 0.72rem; }
        .source-jobs-detail-inner .detail-label { font-weight: 600; color: var(--text); margin-right: 0.4rem; }
        .source-jobs-detail-inner .detail-row { margin-bottom: 0.3rem; }
        .source-jobs-empty { text-align: center; padding: 1.5rem; color: var(--text-muted); font-size: 0.85rem; }

        /* ===== Toast Notifications ===== */
        .toast-container {
            position: fixed; top: 1rem; right: 1rem; z-index: 9999;
            display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none;
        }
        .toast {
            pointer-events: auto; min-width: 280px; max-width: 420px;
            padding: 0.75rem 1rem; border-radius: 8px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-left: 4px solid var(--text-muted);
            color: var(--text); font-size: 0.85rem; line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: toastIn 0.25s ease-out;
            display: flex; align-items: flex-start; gap: 0.5rem;
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--error); }
        .toast.info { border-left-color: var(--accent); }
        .toast-icon { font-size: 1rem; flex-shrink: 0; margin-top: 0.05rem; }
        .toast-close {
            margin-left: auto; cursor: pointer; color: var(--text-muted); font-size: 1rem;
            background: none; border: none; padding: 0; line-height: 1;
        }
        .toast-close:hover { color: var(--text); }
        .toast.removing { animation: toastOut 0.25s ease-in forwards; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(40px); } }

        /* ===== Confirm Modal ===== */
        .confirm-overlay {
            position: fixed; inset: 0; z-index: 10000;
            background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
        }
        .confirm-overlay:not(.hidden) {
            display: flex;
        }
        .confirm-dialog {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 1.5rem; min-width: 340px; max-width: 480px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .confirm-message { font-size: 0.95rem; margin-bottom: 1.25rem; line-height: 1.5; }
        .confirm-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }

        /* ===== Trigger Form Panel ===== */
        .trigger-form-panel {
            background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
            padding: 1rem 1.25rem; margin: 0.25rem 0 0.75rem 0;
            animation: epSlideDown 0.2s ease-out;
        }
        .trigger-form-panel .tf-row,
        .nc-form-section .tf-row,
        .nc-sched-config .tf-row,
        .nc-controls-row .tf-field { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
        .trigger-form-panel .tf-field,
        .nc-form-section .tf-field,
        .nc-sched-config .tf-field,
        .nc-controls-row .tf-field { display: flex; flex-direction: column; gap: 0.25rem; min-width: 140px; }
        .trigger-form-panel .tf-field label,
        .nc-form-section .tf-field label,
        .nc-sched-config .tf-field label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 500; }
        .trigger-form-panel .tf-field select,
        .trigger-form-panel .tf-field input,
        .trigger-form-panel .tf-field textarea,
        .nc-form-section .tf-field select,
        .nc-form-section .tf-field input,
        .nc-form-section .tf-field textarea,
        .nc-sched-config .tf-field select,
        .nc-sched-config .tf-field input,
        .nc-sched-config .tf-field textarea,
        .nc-controls-row .tf-field select,
        .nc-controls-row .tf-field input {
            padding: 0.45rem 0.65rem; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; color: var(--text); font-size: 0.85rem;
        }
        .trigger-form-panel .tf-field select:focus,
        .trigger-form-panel .tf-field input:focus,
        .nc-form-section .tf-field select:focus,
        .nc-form-section .tf-field input:focus,
        .nc-sched-config .tf-field select:focus,
        .nc-sched-config .tf-field input:focus,
        .nc-controls-row .tf-field select:focus,
        .nc-controls-row .tf-field input:focus { outline: none; border-color: var(--primary); }
        .trigger-form-panel .tf-actions { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; }
        .trigger-form-panel .tf-result,
        .nc-submit-row .tf-result { font-size: 0.8rem; margin-top: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 6px; }
        .trigger-form-panel .tf-result.success,
        .nc-submit-row .tf-result.success { background: rgba(34,197,94,0.1); color: var(--success); }
        .trigger-form-panel .tf-result.error,
        .nc-submit-row .tf-result.error { background: rgba(239,68,68,0.1); color: var(--error); }

        /* ===== Toggle Switch ===== */
        .toggle-row { display: flex; align-items: center; gap: 0.75rem; margin: 0.75rem 0; }
        .toggle-label { font-size: 0.8rem; color: var(--text-muted); }
        .toggle-switch {
            position: relative; width: 36px; height: 20px; flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; inset: 0; cursor: pointer; border-radius: 10px;
            background: var(--bg-input); border: 1px solid var(--border); transition: background 0.2s;
        }
        .toggle-slider::before {
            content: ''; position: absolute; left: 2px; top: 2px;
            width: 14px; height: 14px; border-radius: 50%;
            background: var(--text-muted); transition: transform 0.2s, background 0.2s;
        }
        .toggle-switch input:checked + .toggle-slider { background: var(--primary); border-color: var(--primary); }
        .toggle-switch input:checked + .toggle-slider::before { transform: translateX(16px); background: white; }
        .schedule-fields { margin-top: 0.5rem; padding: 0.75rem; background: var(--bg-input); border-radius: 6px; }
        .schedule-fields .tf-row { margin-bottom: 0.5rem; }

        /* ===== Schedule List in Detail View ===== */
        .schedule-list-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0.75rem;
            background: var(--bg-input); border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.85rem;
        }
        .schedule-list-item .sched-name { font-weight: 600; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .schedule-list-item .sched-freq { color: var(--text-muted); font-size: 0.75rem; }
        .schedule-badge { padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
        .schedule-badge.active { background: rgba(34,197,94,0.15); color: var(--success); }
        .schedule-badge.paused { background: rgba(148,163,184,0.15); color: var(--text-muted); }

        /* Schedule edit inline form */
        .sched-edit-form {
            display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: flex-end; padding: 0.5rem 0;
        }
        .sched-edit-form .tf-field { flex: 1; min-width: 100px; }
        .sched-edit-form .tf-field label { font-size: 0.65rem; color: var(--text-muted); margin-bottom: 0.15rem; display: block; }
        .sched-edit-form input, .sched-edit-form select {
            padding: 0.3rem 0.5rem; font-size: 0.78rem; width: 100%;
            background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);
        }
        .sched-edit-actions { display: flex; gap: 0.35rem; align-items: flex-end; }

        /* Schedule history */
        .sched-history { padding: 0.4rem 0 0.2rem 0; }
        .sched-history-item {
            display: flex; align-items: center; gap: 0.6rem; padding: 0.3rem 0.5rem;
            font-size: 0.75rem; border-bottom: 1px solid rgba(51,65,85,0.2);
        }
        .sched-history-item:last-child { border-bottom: none; }

        /* ===== Source Jobs Toolbar ===== */
        .source-jobs-toolbar {
            display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap;
        }
        .source-jobs-toolbar select {
            padding: 0.3rem 0.5rem; font-size: 0.78rem;
            background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text);
        }
        .source-jobs-badges { display: flex; gap: 0.4rem; flex-wrap: wrap; }
        .source-jobs-badge {
            padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600;
        }
        .source-jobs-badge.running { background: rgba(6,182,212,0.15); color: var(--info); }
        .source-jobs-badge.pending { background: rgba(234,179,8,0.15); color: #eab308; }
        .source-jobs-badge.success { background: rgba(34,197,94,0.15); color: var(--success); }
        .source-jobs-badge.failed { background: rgba(239,68,68,0.15); color: var(--error); }

        /* ===== New Collection Flow ===== */
        .nc-controls-row { display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; }
        .nc-controls-row .tf-field { flex: 1; }
        .exec-mode-group { display: flex; gap: 0; flex-shrink: 0; }
        .exec-mode-btn { padding: 0.5rem 1.125rem; text-align: center;
            background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text-muted); cursor: pointer; font-size: 0.8rem; transition: all 0.15s;
            white-space: nowrap; line-height: 1.4; }
        .exec-mode-btn:first-child { border-radius: 6px 0 0 6px; }
        .exec-mode-btn:last-child { border-radius: 0 6px 6px 0; border-left: none; }
        .exec-mode-btn.active { background: rgba(99,102,241,0.15); border-color: var(--primary);
            color: var(--primary); font-weight: 600; }
        .nc-form-section { background: var(--bg); border: 1px solid var(--border);
            border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem; }
        .collection-info-note { font-size: 0.78rem; color: var(--text-muted);
            padding: 0.5rem 0.75rem; background: rgba(6,182,212,0.06);
            border-left: 3px solid var(--accent); border-radius: 0 6px 6px 0; margin: 0 0 1rem 0; }
        .nc-sched-config { background: var(--bg); border: 1px solid var(--border);
            border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem; }
        .nc-sched-config .tf-row:last-child { margin-bottom: 0; }
        .nc-submit-row { display: flex; align-items: center; gap: 1rem; }
        .collection-panel { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; margin-top: 0.5rem; animation: epSlideDown 0.2s ease-out; }
        .collection-panel h4 { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.75rem; }

        /* ===== Checkbox Group (trigger forms) ===== */
        .tf-checkbox-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tf-checkbox-group label {
            display: flex; align-items: center; gap: 0.35rem; font-size: 0.8rem; color: var(--text-muted);
            cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background 0.15s;
        }
        .tf-checkbox-group label:hover { background: var(--bg-input); color: var(--text); }
        .tf-checkbox-group input[type="checkbox"] { accent-color: var(--primary); }
    </style>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <div id="confirm-overlay" class="confirm-overlay hidden"></div>
    <header class="header">
        <div class="logo">
            <span style="font-size: 1.5rem;">üìà</span>
            <h1>Nexdata</h1>
            <span class="tagline">Investment Intelligence</span>
        </div>
        <div class="status">
            <span class="health-dot" id="health-dot"></span>
            <span id="health-status">Checking...</span>
        </div>
    </header>

    <nav class="tabs">
        <button class="tab active" onclick="showTab('sources')">üì° Sources</button>
        <button class="tab" onclick="showTab('jobs')">üöÄ Jobs</button>
        <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
    </nav>

    <!-- Active Jobs Panel (auto-shows when jobs are running) -->
    <div id="active-jobs-panel" class="active-jobs-panel">
        <div class="active-jobs-header">
            <span class="pulse-dot"></span>
            <span>Active Jobs</span>
            <span id="active-jobs-count" style="color: var(--text-muted); font-weight: 400;"></span>
        </div>
        <div id="active-jobs-list"></div>
    </div>

    <main class="content">
        <!-- Sources Tab (default) -->
        <div id="tab-sources">
            <div id="sources-loading" class="loading">Loading data sources...</div>
            <div id="sources-content" class="hidden"></div>
        </div>

        <!-- Jobs Tab -->
        <div id="tab-jobs" class="hidden">
            <!-- Section 1: Run Collection -->
            <div class="card jobs-section">
                <h2 class="card-title">üöÄ Run Collection</h2>
                <div class="jobs-launcher-row">
                    <div class="jobs-launcher-field">
                        <label>Collection Type</label>
                        <select id="jobs-type-select" onchange="jobsTypeChanged()">
                            <option value="">Select type...</option>
                            <option value="site_intel">Site Intelligence</option>
                            <option value="people">People</option>
                            <option value="pe">PE Intelligence</option>
                            <option value="lp">LP Intelligence</option>
                            <option value="fo">Family Office</option>
                            <option value="agentic">Agentic Research</option>
                            <option value="ingestion">Data Ingestion</option>
                        </select>
                    </div>
                    <button class="btn" id="jobs-run-btn" onclick="jobsRunCollection()" disabled>Run</button>
                </div>
                <div id="jobs-options-panel" class="jobs-options-panel"></div>
                <div id="jobs-run-result"></div>
            </div>

            <!-- Section 2: Active Jobs -->
            <div class="card jobs-section jobs-active-card">
                <h2 class="card-title"><span class="pulse-dot"></span> Active Jobs <span id="jobs-active-count" style="color:var(--text-muted);font-weight:400;font-size:0.85rem;"></span></h2>
                <div id="jobs-active-list"></div>
            </div>

            <!-- Section 2.5: Nightly Batch -->
            <div class="card jobs-section" id="nightly-batch-card">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;">
                    <h2 class="card-title" style="margin:0;">üåô Nightly Batch</h2>
                    <div style="display:flex;gap:0.5rem;">
                        <button class="btn btn-secondary" onclick="nightlyRefresh()" style="padding:0.35rem 0.75rem;font-size:0.8rem;">Refresh</button>
                        <button class="btn" onclick="nightlyLaunch()" id="nightly-launch-btn" style="padding:0.35rem 0.75rem;font-size:0.8rem;">Launch Batch</button>
                    </div>
                </div>
                <div id="nightly-status"></div>
                <div id="nightly-tiers"></div>
                <div id="nightly-history" style="margin-top:0.75rem;"></div>
            </div>

            <!-- Section 3: Job History -->
            <div class="card jobs-section">
                <h2 class="card-title">üìã Job History</h2>
                <div class="jobs-history-toolbar">
                    <select id="jobs-hist-status" onchange="jobsLoadHistory()">
                        <option value="">All Statuses</option>
                        <option value="success">Success</option>
                        <option value="failed">Failed</option>
                        <option value="running">Running</option>
                        <option value="pending">Pending</option>
                    </select>
                    <select id="jobs-hist-type" onchange="jobsLoadHistory()">
                        <option value="">All Types</option>
                        <option value="site_intel">Site Intel</option>
                        <option value="people">People</option>
                        <option value="pe">PE</option>
                        <option value="lp">LP</option>
                        <option value="fo">Family Office</option>
                        <option value="agentic">Agentic</option>
                        <option value="ingestion">Ingestion</option>
                    </select>
                    <button class="btn btn-secondary" onclick="jobsLoadHistory()" style="padding:0.4rem 1rem;font-size:0.8rem;">Refresh</button>
                </div>
                <div id="jobs-summary"></div>
                <div id="jobs-history-body">
                    <div class="loading">Loading history...</div>
                </div>
                <div id="jobs-load-more" class="jobs-load-more hidden">
                    <button class="btn btn-secondary" onclick="jobsLoadMore()">Load More</button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="hidden">
            <div class="card">
                <h2 class="card-title">‚öôÔ∏è API Key Management</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    Configure API keys for external data sources. Keys are encrypted and stored in the database.
                    Existing <code>.env</code> keys continue to work ‚Äî DB keys take priority.
                </p>
                <div class="key-filter-box">
                    <span class="key-filter-icon">üîç</span>
                    <input type="text" class="key-filter-input" id="key-filter"
                           placeholder="Filter keys (e.g. openai, fred, market...)"
                           oninput="filterApiKeys(this.value)">
                </div>
                <div id="api-keys-container">
                    <div class="loading">Loading API keys...</div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <a href="http://localhost:8001/docs" target="_blank">API Docs</a>
        <span>‚Ä¢</span>
        <a href="http://localhost:8001/graphql" target="_blank">GraphQL</a>
        <span>‚Ä¢</span>
        <span>100+ Endpoints ‚Ä¢ 25+ Data Sources</span>
    </footer>

    <script>
        const API = '/api/v1';

        // ===== Toast Notifications =====
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: '\u2705', error: '\u274C', info: '\u2139\uFE0F' };
            toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span>
                <span style="flex:1;">${message}</span>
                <button class="toast-close" onclick="this.parentElement.classList.add('removing');setTimeout(()=>this.parentElement.remove(),250)">&times;</button>`;
            container.appendChild(toast);
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) { toast.classList.add('removing'); setTimeout(() => toast.remove(), 250); }
                }, duration);
            }
        }

        let _confirmCallback = null;
        function showConfirm(message, onConfirm) {
            _confirmCallback = onConfirm;
            const overlay = document.getElementById('confirm-overlay');
            overlay.classList.remove('hidden');
            overlay.innerHTML = `<div class="confirm-dialog">
                <div class="confirm-message">${message}</div>
                <div class="confirm-actions">
                    <button class="btn btn-secondary" onclick="closeConfirm()">Cancel</button>
                    <button class="btn" onclick="confirmAction()">Confirm</button>
                </div>
            </div>`;
        }
        function closeConfirm() {
            document.getElementById('confirm-overlay').classList.add('hidden');
            _confirmCallback = null;
        }
        function confirmAction() {
            const cb = _confirmCallback;
            closeConfirm();
            if (cb) cb();
        }

        // ===== Tab Navigation =====
        let _currentTab = 'sources';
        function showTab(tab) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content > div').forEach(t => t.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tab).classList.remove('hidden');
            _currentTab = tab;
            if (tab === 'settings') loadApiKeys();
            if (tab === 'jobs') jobsInitialize();
        }

        // ===== Health Check =====
        fetch('/api/v1/deals')
            .then(r => r.json())
            .then(() => {
                document.getElementById('health-dot').classList.add('healthy');
                document.getElementById('health-status').textContent = 'API Connected';
            })
            .catch(() => {
                document.getElementById('health-status').textContent = 'API Offline';
            });

        // ===================================================================
        //  TRIGGER FORMS ‚Äî source-aware field definitions
        // ===================================================================
        const INCREMENTAL_SOURCES = new Set(['fred','bls','eia','sec','treasury','bts','census','bea']);

        const TRIGGER_FORMS = {
            // ‚îÄ‚îÄ FRED ‚îÄ‚îÄ
            '/api/v1/fred/ingest': {
                fields: [
                    { name: 'category', label: 'Category', type: 'select', options: [
                        {value:'interest_rates',label:'Interest Rates (H.15 ‚Äî 7 series)'},
                        {value:'monetary_aggregates',label:'Monetary Aggregates (M1, M2 ‚Äî 4 series)'},
                        {value:'industrial_production',label:'Industrial Production (5 series)'},
                        {value:'economic_indicators',label:'Core Economic Indicators (GDP, CPI ‚Äî 6 series)'},
                    ]},
                    { name: 'series_ids', label: 'Series IDs (optional)', type: 'text', placeholder: 'DFF,DGS10 (comma-separated, blank = all in category)' },
                    { name: 'observation_start', label: 'Start Date', type: 'date' },
                    { name: 'observation_end', label: 'End Date', type: 'date' },
                ]
            },
            '/api/v1/fred/ingest/batch': {
                fields: [
                    { name: 'categories', label: 'Categories', type: 'checkbox-group', options: [
                        {value:'interest_rates',label:'Interest Rates'},
                        {value:'monetary_aggregates',label:'Monetary Aggregates'},
                        {value:'industrial_production',label:'Industrial Production'},
                        {value:'economic_indicators',label:'Economic Indicators'},
                    ]},
                    { name: 'observation_start', label: 'Start Date', type: 'date' },
                    { name: 'observation_end', label: 'End Date', type: 'date' },
                ]
            },

            // ‚îÄ‚îÄ BEA ‚îÄ‚îÄ
            '/api/v1/bea/nipa/ingest': {
                fields: [
                    { name: 'table_name', label: 'NIPA Table', type: 'select', options: [
                        {value:'T10101',label:'T10101 ‚Äî GDP'},
                        {value:'T10105',label:'T10105 ‚Äî GDP % Change'},
                        {value:'T10106',label:'T10106 ‚Äî Real GDP (Chained $)'},
                        {value:'T20100',label:'T20100 ‚Äî Personal Income'},
                        {value:'T20200',label:'T20200 ‚Äî PCE'},
                        {value:'T30100',label:'T30100 ‚Äî Govt Receipts & Expenditures'},
                        {value:'T50100',label:'T50100 ‚Äî Saving & Investment'},
                        {value:'T60100',label:'T60100 ‚Äî Corporate Profits'},
                    ]},
                    { name: 'frequency', label: 'Frequency', type: 'select', options: [
                        {value:'A',label:'Annual'},{value:'Q',label:'Quarterly'},{value:'M',label:'Monthly'},
                    ]},
                    { name: 'year', label: 'Year(s)', type: 'text', placeholder: '2024 or 2020,2021,2022 or ALL' },
                ]
            },
            '/api/v1/bea/regional/ingest': {
                fields: [
                    { name: 'table_name', label: 'Regional Table', type: 'select', options: [
                        {value:'SAGDP2N',label:'SAGDP2N ‚Äî GDP by State (all industries)'},
                        {value:'SAGDP9N',label:'SAGDP9N ‚Äî Real GDP by State'},
                        {value:'SAINC1',label:'SAINC1 ‚Äî Personal Income by State'},
                        {value:'SAINC4',label:'SAINC4 ‚Äî Income & Employment by State'},
                        {value:'SAINC51',label:'SAINC51 ‚Äî Per Capita Income by State'},
                        {value:'CAINC1',label:'CAINC1 ‚Äî Personal Income by County'},
                        {value:'CAGDP2',label:'CAGDP2 ‚Äî GDP by County'},
                        {value:'MAGDP2',label:'MAGDP2 ‚Äî GDP by Metro Area (MSA)'},
                    ]},
                    { name: 'line_code', label: 'Line Code', type: 'text', placeholder: '1', default: '1' },
                    { name: 'geo_fips', label: 'Geography', type: 'select', options: [
                        {value:'STATE',label:'State'},{value:'COUNTY',label:'County'},{value:'MSA',label:'MSA'},
                    ]},
                    { name: 'year', label: 'Year(s)', type: 'text', placeholder: '2024 or 2020,2021,2022' },
                ]
            },
            '/api/v1/bea/gdp-industry/ingest': {
                fields: [
                    { name: 'table_id', label: 'Table', type: 'select', options: [
                        {value:'1',label:'1 ‚Äî Value Added by Industry'},
                        {value:'5',label:'5 ‚Äî Value Added as % of GDP'},
                        {value:'6',label:'6 ‚Äî Real Value Added by Industry'},
                        {value:'10',label:'10 ‚Äî Gross Output by Industry'},
                        {value:'11',label:'11 ‚Äî Intermediate Inputs by Industry'},
                    ]},
                    { name: 'frequency', label: 'Frequency', type: 'select', options: [
                        {value:'A',label:'Annual'},{value:'Q',label:'Quarterly'},
                    ]},
                    { name: 'industry', label: 'Industry', type: 'text', placeholder: 'ALL (or specific industry code)', default: 'ALL' },
                    { name: 'year', label: 'Year(s)', type: 'text', placeholder: '2024 or 2020,2021,2022' },
                ]
            },
            '/api/v1/bea/international/ingest': {
                fields: [
                    { name: 'indicator', label: 'Indicator', type: 'select', options: [
                        {value:'BalGds',label:'BalGds ‚Äî Balance on Goods'},
                        {value:'BalServ',label:'BalServ ‚Äî Balance on Services'},
                        {value:'BalCurAcct',label:'BalCurAcct ‚Äî Current Account Balance'},
                        {value:'ExpGds',label:'ExpGds ‚Äî Exports of Goods'},
                        {value:'ImpGds',label:'ImpGds ‚Äî Imports of Goods'},
                    ]},
                    { name: 'area_or_country', label: 'Area/Country', type: 'text', placeholder: 'AllCountries', default: 'AllCountries' },
                    { name: 'frequency', label: 'Frequency', type: 'select', options: [
                        {value:'A',label:'Annual'},{value:'Q',label:'Quarterly'},
                    ]},
                    { name: 'year', label: 'Year(s)', type: 'text', placeholder: 'ALL or 2024' },
                ]
            },

            // ‚îÄ‚îÄ BLS ‚îÄ‚îÄ
            '/api/v1/bls/{dataset}/ingest': {
                pathParams: [
                    { name: 'dataset', label: 'Dataset', type: 'select', options: [
                        {value:'ces',label:'CES ‚Äî Current Employment Statistics'},
                        {value:'cps',label:'CPS ‚Äî Current Population Survey'},
                        {value:'jolts',label:'JOLTS ‚Äî Job Openings & Labor Turnover'},
                        {value:'cpi',label:'CPI ‚Äî Consumer Price Index'},
                        {value:'ppi',label:'PPI ‚Äî Producer Price Index'},
                        {value:'oes',label:'OES ‚Äî Occupational Employment & Wages'},
                    ]},
                ],
                fields: [
                    { name: 'start_year', label: 'Start Year', type: 'number', placeholder: '2014 (10yr default w/o key, 20yr w/ key)' },
                    { name: 'end_year', label: 'End Year', type: 'number', placeholder: '2024' },
                    { name: 'series_ids', label: 'Series IDs (optional)', type: 'text', placeholder: 'LNS14000000,CUUR0000SA0 (blank = common series)' },
                ]
            },
            '/api/v1/bls/all/ingest': {
                fields: [
                    { name: 'start_year', label: 'Start Year', type: 'number', placeholder: '2014' },
                    { name: 'end_year', label: 'End Year', type: 'number', placeholder: '2024' },
                ]
            },

            // ‚îÄ‚îÄ Treasury ‚îÄ‚îÄ
            '/api/v1/treasury/{type}/ingest': {
                pathParams: [
                    { name: 'type', label: 'Dataset', type: 'select', options: [
                        {value:'interest-rates',label:'Interest Rates'},
                        {value:'debt',label:'Debt Outstanding'},
                        {value:'revenue-spending',label:'Revenue & Spending (Monthly Statement)'},
                        {value:'auctions',label:'Auction Results'},
                        {value:'all',label:'All Datasets'},
                    ]},
                ],
                fields: [
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                    { name: 'security_type', label: 'Security Type (optional)', type: 'select', options: [
                        {value:'',label:'All'},
                        {value:'Treasury Bills',label:'Treasury Bills'},
                        {value:'Treasury Notes',label:'Treasury Notes'},
                        {value:'Treasury Bonds',label:'Treasury Bonds'},
                        {value:'TIPS',label:'TIPS'},
                        {value:'FRN',label:'Floating Rate Notes'},
                        {value:'CMB',label:'Cash Management Bills'},
                    ]},
                ]
            },
            // Static Treasury endpoints (no path param) ‚Äî inherit fields from generic
            '/api/v1/treasury/interest-rates/ingest': {
                fields: [
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                    { name: 'security_type', label: 'Security Type', type: 'select', options: [
                        {value:'',label:'All'},{value:'Treasury Bills',label:'Bills'},{value:'Treasury Notes',label:'Notes'},
                        {value:'Treasury Bonds',label:'Bonds'},{value:'TIPS',label:'TIPS'},{value:'FRN',label:'FRN'},
                    ]},
                ]
            },
            '/api/v1/treasury/debt/ingest': {
                fields: [
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                ]
            },
            '/api/v1/treasury/revenue-spending/ingest': {
                fields: [
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                    { name: 'classification', label: 'Classification (optional)', type: 'text', placeholder: 'e.g. Receipts, Outlays' },
                ]
            },
            '/api/v1/treasury/auctions/ingest': {
                fields: [
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                    { name: 'security_type', label: 'Security Type', type: 'select', options: [
                        {value:'',label:'All'},{value:'Bill',label:'Bill'},{value:'Note',label:'Note'},
                        {value:'Bond',label:'Bond'},{value:'TIPS',label:'TIPS'},{value:'FRN',label:'FRN'},{value:'CMB',label:'CMB'},
                    ]},
                ]
            },
            '/api/v1/treasury/all/ingest': {
                fields: [
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                ]
            },

            // ‚îÄ‚îÄ EIA ‚îÄ‚îÄ
            '/api/v1/eia/{category}/ingest': {
                pathParams: [
                    { name: 'category', label: 'Category', type: 'select', options: [
                        {value:'petroleum',label:'Petroleum'},
                        {value:'electricity',label:'Electricity'},
                        {value:'natural-gas',label:'Natural Gas'},
                        {value:'retail-gas-prices',label:'Retail Gas Prices'},
                        {value:'steo',label:'STEO (Short-Term Energy Outlook)'},
                    ]},
                ],
                fields: [
                    { name: 'subcategory', label: 'Subcategory (optional)', type: 'text', placeholder: 'e.g. consumption, production, imports, stocks' },
                    { name: 'frequency', label: 'Frequency', type: 'select', options: [
                        {value:'',label:'Default'},{value:'annual',label:'Annual'},{value:'monthly',label:'Monthly'},
                        {value:'weekly',label:'Weekly'},{value:'daily',label:'Daily'},
                    ]},
                    { name: 'start', label: 'Start Date', type: 'date' },
                    { name: 'end', label: 'End Date', type: 'date' },
                ]
            },
            // Static EIA endpoints with specific subcategory fields
            '/api/v1/eia/petroleum/ingest': {
                fields: [
                    { name: 'subcategory', label: 'Subcategory', type: 'select', options: [
                        {value:'consumption',label:'Consumption'},{value:'production',label:'Production'},
                        {value:'imports',label:'Imports'},{value:'exports',label:'Exports'},{value:'stocks',label:'Stocks'},
                    ]},
                    { name: 'frequency', label: 'Frequency', type: 'select', options: [
                        {value:'annual',label:'Annual'},{value:'monthly',label:'Monthly'},{value:'weekly',label:'Weekly'},{value:'daily',label:'Daily'},
                    ]},
                    { name: 'start', label: 'Start Date', type: 'date' },
                    { name: 'end', label: 'End Date', type: 'date' },
                ]
            },
            '/api/v1/eia/electricity/ingest': {
                fields: [
                    { name: 'subcategory', label: 'Subcategory', type: 'select', options: [
                        {value:'retail_sales',label:'Retail Sales'},{value:'generation',label:'Generation'},
                        {value:'revenue',label:'Revenue'},{value:'customers',label:'Customers'},
                    ]},
                    { name: 'frequency', label: 'Frequency', type: 'select', options: [
                        {value:'annual',label:'Annual'},{value:'monthly',label:'Monthly'},
                    ]},
                    { name: 'start', label: 'Start Date', type: 'date' },
                    { name: 'end', label: 'End Date', type: 'date' },
                ]
            },
            '/api/v1/eia/natural-gas/ingest': {
                fields: [
                    { name: 'subcategory', label: 'Subcategory', type: 'select', options: [
                        {value:'consumption',label:'Consumption'},{value:'production',label:'Production'},
                        {value:'storage',label:'Storage'},{value:'prices',label:'Prices'},
                    ]},
                    { name: 'frequency', label: 'Frequency', type: 'select', options: [
                        {value:'annual',label:'Annual'},{value:'monthly',label:'Monthly'},
                    ]},
                    { name: 'start', label: 'Start Date', type: 'date' },
                    { name: 'end', label: 'End Date', type: 'date' },
                ]
            },
            '/api/v1/eia/retail-gas-prices/ingest': {
                fields: [
                    { name: 'frequency', label: 'Frequency', type: 'select', options: [
                        {value:'weekly',label:'Weekly'},{value:'daily',label:'Daily'},
                    ]},
                    { name: 'start', label: 'Start Date', type: 'date' },
                    { name: 'end', label: 'End Date', type: 'date' },
                ]
            },
            '/api/v1/eia/steo/ingest': {
                fields: [
                    { name: 'start', label: 'Start (YYYY-MM)', type: 'text', placeholder: '2023-01' },
                    { name: 'end', label: 'End (YYYY-MM)', type: 'text', placeholder: '2024-12' },
                ]
            },

            // ‚îÄ‚îÄ Census ‚îÄ‚îÄ
            '/api/v1/census/{level}': {
                pathParams: [
                    { name: 'level', label: 'Geography Level', type: 'select', options: [
                        {value:'state',label:'State'},
                        {value:'county',label:'County'},
                        {value:'tract',label:'Census Tract'},
                        {value:'zip',label:'ZIP Code (ZCTA)'},
                    ]},
                ],
                fields: [
                    { name: 'survey', label: 'Survey', type: 'select', options: [
                        {value:'acs5',label:'ACS 5-Year Estimates'},{value:'acs1',label:'ACS 1-Year Estimates'},
                    ]},
                    { name: 'year', label: 'Year', type: 'number', required: true, placeholder: '2022 (required)' },
                    { name: 'table_id', label: 'Table ID', type: 'text', required: true, placeholder: 'B01001 (required)' },
                    { name: 'state_fips', label: 'State FIPS (optional)', type: 'text', placeholder: '06 for California' },
                ]
            },
            '/api/v1/census/state': {
                fields: [
                    { name: 'survey', label: 'Survey', type: 'select', options: [
                        {value:'acs5',label:'ACS 5-Year'},{value:'acs1',label:'ACS 1-Year'},
                    ]},
                    { name: 'year', label: 'Year', type: 'number', required: true, placeholder: '2022' },
                    { name: 'table_id', label: 'Table ID', type: 'text', required: true, placeholder: 'B01001' },
                ]
            },
            '/api/v1/census/county': {
                fields: [
                    { name: 'survey', label: 'Survey', type: 'select', options: [
                        {value:'acs5',label:'ACS 5-Year'},{value:'acs1',label:'ACS 1-Year'},
                    ]},
                    { name: 'year', label: 'Year', type: 'number', required: true, placeholder: '2022' },
                    { name: 'table_id', label: 'Table ID', type: 'text', required: true, placeholder: 'B01001' },
                    { name: 'state_fips', label: 'State FIPS (optional)', type: 'text', placeholder: '06' },
                ]
            },
            '/api/v1/census/zip': {
                fields: [
                    { name: 'survey', label: 'Survey', type: 'select', options: [
                        {value:'acs5',label:'ACS 5-Year'},{value:'acs1',label:'ACS 1-Year'},
                    ]},
                    { name: 'year', label: 'Year', type: 'number', required: true, placeholder: '2022' },
                    { name: 'table_id', label: 'Table ID', type: 'text', required: true, placeholder: 'B01001' },
                    { name: 'state_fips', label: 'State FIPS (optional)', type: 'text', placeholder: '06' },
                ]
            },
            '/api/v1/census/batch/state': {
                fields: [
                    { name: 'survey', label: 'Survey', type: 'select', options: [
                        {value:'acs5',label:'ACS 5-Year Estimates'},{value:'acs1',label:'ACS 1-Year Estimates'},
                    ]},
                    { name: 'table_id', label: 'Census Table', type: 'select', required: true, options: [
                        { value: 'B01001', label: 'B01001 ‚Äî Sex by Age' },
                        { value: 'B01003', label: 'B01003 ‚Äî Total Population' },
                        { value: 'B02001', label: 'B02001 ‚Äî Race' },
                        { value: 'B03003', label: 'B03003 ‚Äî Hispanic/Latino Origin' },
                        { value: 'B19013', label: 'B19013 ‚Äî Median Household Income' },
                        { value: 'B19001', label: 'B19001 ‚Äî Household Income Brackets' },
                        { value: 'B25001', label: 'B25001 ‚Äî Housing Units' },
                        { value: 'B25077', label: 'B25077 ‚Äî Median Home Value' },
                        { value: 'B25064', label: 'B25064 ‚Äî Median Gross Rent' },
                        { value: 'B23025', label: 'B23025 ‚Äî Employment Status' },
                        { value: 'B15003', label: 'B15003 ‚Äî Educational Attainment' },
                        { value: 'B17001', label: 'B17001 ‚Äî Poverty Status' },
                        { value: 'B08301', label: 'B08301 ‚Äî Means of Transportation to Work' },
                        { value: 'B27001', label: 'B27001 ‚Äî Health Insurance Coverage' },
                    ]},
                    { name: 'years', label: 'Years (comma-sep, max 10)', type: 'text', required: true,
                      placeholder: '2020,2021,2022,2023' },
                    { name: 'include_geojson', label: 'Include GeoJSON boundaries', type: 'select', options: [
                        { value: 'false', label: 'No (faster)' }, { value: 'true', label: 'Yes' },
                    ]},
                ]
            },
            '/api/v1/census/batch/county': {
                fields: [
                    { name: 'survey', label: 'Survey', type: 'select', options: [
                        {value:'acs5',label:'ACS 5-Year Estimates'},{value:'acs1',label:'ACS 1-Year Estimates'},
                    ]},
                    { name: 'table_id', label: 'Census Table', type: 'select', required: true, options: [
                        { value: 'B01001', label: 'B01001 ‚Äî Sex by Age' },
                        { value: 'B01003', label: 'B01003 ‚Äî Total Population' },
                        { value: 'B02001', label: 'B02001 ‚Äî Race' },
                        { value: 'B03003', label: 'B03003 ‚Äî Hispanic/Latino Origin' },
                        { value: 'B19013', label: 'B19013 ‚Äî Median Household Income' },
                        { value: 'B19001', label: 'B19001 ‚Äî Household Income Brackets' },
                        { value: 'B25001', label: 'B25001 ‚Äî Housing Units' },
                        { value: 'B25077', label: 'B25077 ‚Äî Median Home Value' },
                        { value: 'B25064', label: 'B25064 ‚Äî Median Gross Rent' },
                        { value: 'B23025', label: 'B23025 ‚Äî Employment Status' },
                        { value: 'B15003', label: 'B15003 ‚Äî Educational Attainment' },
                        { value: 'B17001', label: 'B17001 ‚Äî Poverty Status' },
                        { value: 'B08301', label: 'B08301 ‚Äî Means of Transportation to Work' },
                        { value: 'B27001', label: 'B27001 ‚Äî Health Insurance Coverage' },
                    ]},
                    { name: 'years', label: 'Years (comma-sep, max 10)', type: 'text', required: true,
                      placeholder: '2020,2021,2022,2023' },
                    { name: 'state_fips', label: 'State (optional)', type: 'select', options: [
                        { value: '', label: 'All states' },
                        { value: '06', label: 'California' }, { value: '48', label: 'Texas' },
                        { value: '36', label: 'New York' }, { value: '12', label: 'Florida' },
                        { value: '17', label: 'Illinois' }, { value: '42', label: 'Pennsylvania' },
                        { value: '39', label: 'Ohio' }, { value: '13', label: 'Georgia' },
                        { value: '37', label: 'North Carolina' }, { value: '26', label: 'Michigan' },
                        { value: '34', label: 'New Jersey' }, { value: '51', label: 'Virginia' },
                        { value: '53', label: 'Washington' }, { value: '04', label: 'Arizona' },
                        { value: '25', label: 'Massachusetts' }, { value: '47', label: 'Tennessee' },
                    ]},
                    { name: 'include_geojson', label: 'Include GeoJSON boundaries', type: 'select', options: [
                        { value: 'false', label: 'No (faster)' }, { value: 'true', label: 'Yes' },
                    ]},
                ]
            },

            // ‚îÄ‚îÄ SEC ‚îÄ‚îÄ
            '/api/v1/sec/ingest/company': {
                fields: [
                    { name: 'cik', label: 'CIK', type: 'text', required: true, placeholder: '0000320193 (Apple)' },
                    { name: 'filing_types', label: 'Filing Types', type: 'text', placeholder: '10-K,10-Q (comma-sep, default: 10-K,10-Q)' },
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                ]
            },
            '/api/v1/sec/ingest/multiple': {
                fields: [
                    { name: 'ciks', label: 'CIKs', type: 'text', required: true, placeholder: '0000320193,0000789019 (comma-separated)' },
                    { name: 'filing_types', label: 'Filing Types', type: 'text', placeholder: '10-K,10-Q' },
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                ]
            },
            '/api/v1/sec/ingest/industrial-companies': { fields: [] },
            '/api/v1/sec/form-adv/ingest/family-offices': {
                fields: [
                    { name: 'family_office_names', label: 'Family Office Names', type: 'text', required: true, placeholder: 'Soros Fund Management,Cascade Investment (comma-sep)' },
                    { name: 'max_concurrency', label: 'Max Concurrency', type: 'number', placeholder: '1', default: '1' },
                ]
            },
            '/api/v1/sec/form-adv/ingest/crd': {
                fields: [
                    { name: 'crd_number', label: 'CRD Number', type: 'text', required: true, placeholder: '158626' },
                ],
            },

            // ‚îÄ‚îÄ FDIC ‚îÄ‚îÄ
            '/api/v1/fdic/{type}/ingest': {
                pathParams: [
                    { name: 'type', label: 'Dataset', type: 'select', options: [
                        {value:'financials',label:'Bank Financials'},
                        {value:'institutions',label:'Institution Demographics'},
                        {value:'failed-banks',label:'Failed Banks (Historical)'},
                        {value:'deposits',label:'Deposits (Branch-Level ‚Äî large)'},
                        {value:'all',label:'All Datasets'},
                    ]},
                ],
                fields: [
                    { name: 'year', label: 'Year (optional)', type: 'number', placeholder: '2024' },
                    { name: 'state', label: 'State (optional)', type: 'text', placeholder: 'NY (2-letter code)' },
                    { name: 'cert', label: 'FDIC Cert # (optional)', type: 'text', placeholder: '628 (JPMorgan), 3510 (BofA)' },
                ]
            },
            '/api/v1/fdic/financials/ingest': {
                fields: [
                    { name: 'cert', label: 'FDIC Cert #', type: 'text', placeholder: '628 (JPMorgan)' },
                    { name: 'report_date', label: 'Report Date', type: 'text', placeholder: 'YYYYMMDD format' },
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2024' },
                ]
            },
            '/api/v1/fdic/institutions/ingest': {
                fields: [
                    { name: 'state', label: 'State', type: 'text', placeholder: 'NY (2-letter code)' },
                    { name: 'active_only', label: 'Active Only', type: 'select', options: [
                        {value:'true',label:'Yes (active only)'},{value:'false',label:'No (include inactive)'},
                    ]},
                ]
            },
            '/api/v1/fdic/failed-banks/ingest': {
                fields: [
                    { name: 'year_start', label: 'Start Year', type: 'number', placeholder: '2000' },
                    { name: 'year_end', label: 'End Year', type: 'number', placeholder: '2024' },
                ]
            },
            '/api/v1/fdic/deposits/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2024' },
                    { name: 'cert', label: 'FDIC Cert #', type: 'text', placeholder: '628' },
                    { name: 'state', label: 'State', type: 'text', placeholder: 'NY' },
                ]
            },
            '/api/v1/fdic/all/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2024' },
                ]
            },

            // ‚îÄ‚îÄ CMS ‚îÄ‚îÄ
            '/api/v1/cms/ingest/{dataset}': {
                pathParams: [
                    { name: 'dataset', label: 'Dataset', type: 'select', options: [
                        {value:'medicare-utilization',label:'Medicare Provider Utilization & Payment'},
                        {value:'hospital-cost-reports',label:'Hospital Cost Reports (HCRIS)'},
                        {value:'drug-pricing',label:'Medicare Part D Drug Spending'},
                    ]},
                ],
                fields: [
                    { name: 'year', label: 'Year (optional)', type: 'number', placeholder: '2024' },
                    { name: 'state', label: 'State (optional)', type: 'text', placeholder: 'NY (2-letter)' },
                    { name: 'limit', label: 'Row Limit (optional)', type: 'number', placeholder: 'e.g. 1000 for testing' },
                ]
            },
            '/api/v1/cms/ingest/medicare-utilization': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2024' },
                    { name: 'state', label: 'State', type: 'text', placeholder: 'NY' },
                    { name: 'limit', label: 'Row Limit', type: 'number', placeholder: '1000' },
                ]
            },
            '/api/v1/cms/ingest/hospital-cost-reports': {
                fields: [
                    { name: 'year', label: 'Fiscal Year', type: 'number', placeholder: '2024' },
                    { name: 'limit', label: 'Row Limit', type: 'number', placeholder: '1000' },
                ]
            },
            '/api/v1/cms/ingest/drug-pricing': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2024' },
                    { name: 'brand_name', label: 'Brand Name (optional)', type: 'text', placeholder: 'e.g. Humira' },
                    { name: 'limit', label: 'Row Limit', type: 'number', placeholder: '1000' },
                ]
            },

            // ‚îÄ‚îÄ People ‚îÄ‚îÄ
            '/api/v1/people-jobs/test/{company_id}': {
                pathParams: [
                    { name: 'company_id', label: 'Company ID', type: 'number', required: true, placeholder: 'e.g. 1' },
                ],
                queryParams: [
                    { name: 'sources', label: 'Sources', type: 'text', placeholder: 'website,sec,news (blank = website)' },
                ],
            },
            '/api/v1/people-jobs/test/{company_id}?sources=website': {
                pathParams: [
                    { name: 'company_id', label: 'Company ID', type: 'number', required: true, placeholder: 'e.g. 1' },
                ],
            },
            '/api/v1/people-jobs/deep-collect/{company_id}': {
                pathParams: [
                    { name: 'company_id', label: 'Company ID', type: 'number', required: true, placeholder: 'e.g. 1' },
                ],
                fields: [
                    { name: 'run_sec', label: 'Run SEC', type: 'select', options: [
                        { value: 'true', label: 'Yes (default)' }, { value: 'false', label: 'No' },
                    ]},
                    { name: 'run_website', label: 'Run Website Crawl', type: 'select', options: [
                        { value: 'true', label: 'Yes (default)' }, { value: 'false', label: 'No' },
                    ]},
                    { name: 'run_news', label: 'Run News Scan', type: 'select', options: [
                        { value: 'true', label: 'Yes (default)' }, { value: 'false', label: 'No' },
                    ]},
                    { name: 'build_org_chart', label: 'Build Org Chart', type: 'select', options: [
                        { value: 'true', label: 'Yes (default)' }, { value: 'false', label: 'No' },
                    ]},
                    { name: 'max_crawl_pages', label: 'Max Crawl Pages', type: 'number', placeholder: '50' },
                    { name: 'news_days_back', label: 'News Lookback (days)', type: 'number', placeholder: '1825 (5 years)' },
                    { name: 'seed_urls', label: 'Seed URLs (comma-sep)', type: 'text', placeholder: 'https://example.com/team (optional)' },
                    { name: 'subsidiary_names', label: 'Subsidiary Names (comma-sep)', type: 'text', placeholder: 'Acme Corp,Widget Inc (optional)' },
                ],
            },
            '/api/v1/people-jobs/recursive-collect/{company_id}': {
                pathParams: [
                    { name: 'company_id', label: 'Company ID', type: 'number', required: true, placeholder: 'e.g. 1' },
                ],
                fields: [
                    { name: 'discover_structure', label: 'Auto-Discover Subsidiaries', type: 'select', options: [
                        { value: 'true', label: 'Yes (default)' }, { value: 'false', label: 'No' },
                    ]},
                    { name: 'max_units', label: 'Max Business Units', type: 'number', placeholder: '25' },
                    { name: 'run_sec_per_unit', label: 'SEC per Unit', type: 'select', options: [
                        { value: 'true', label: 'Yes (default)' }, { value: 'false', label: 'No' },
                    ]},
                    { name: 'run_website_per_unit', label: 'Website Crawl per Unit', type: 'select', options: [
                        { value: 'true', label: 'Yes (default)' }, { value: 'false', label: 'No' },
                    ]},
                    { name: 'run_news_per_unit', label: 'News Scan per Unit', type: 'select', options: [
                        { value: 'false', label: 'No (default)' }, { value: 'true', label: 'Yes (slow)' },
                    ]},
                    { name: 'max_crawl_pages_per_unit', label: 'Max Pages per Unit', type: 'number', placeholder: '20' },
                    { name: 'run_linkedin', label: 'LinkedIn Discovery', type: 'select', options: [
                        { value: 'true', label: 'Yes (default)' }, { value: 'false', label: 'No' },
                    ]},
                    { name: 'max_linkedin_searches', label: 'Max LinkedIn Searches', type: 'number', placeholder: '100' },
                ],
            },
            '/api/v1/people-jobs/schedule': {
                fields: [
                    { name: 'job_type', label: 'Job Type', type: 'select', required: true, options: [
                        { value: 'website_crawl', label: 'Website Crawl' },
                        { value: 'sec_parse', label: 'SEC Parse' },
                        { value: 'news_scan', label: 'News Scan' },
                    ]},
                    { name: 'company_ids', label: 'Company IDs (comma-sep, blank = auto)', type: 'text', placeholder: '1,2,3 (blank = use priority filter)' },
                    { name: 'priority', label: 'Priority', type: 'select', options: [
                        { value: 'all', label: 'All companies' },
                        { value: 'portfolio', label: 'Portfolio only' },
                        { value: 'public', label: 'Public companies only' },
                    ]},
                    { name: 'limit', label: 'Max Companies', type: 'number', placeholder: '50' },
                ],
            },

            // ‚îÄ‚îÄ Job Postings ‚îÄ‚îÄ
            '/api/v1/job-postings/collect-all': {
                fields: [
                    { name: 'limit', label: 'Max Companies', type: 'number', placeholder: 'blank = all' },
                    { name: 'skip_recent_hours', label: 'Skip Recent (hours)', type: 'number', placeholder: '24' },
                ],
            },
            '/api/v1/job-postings/collect/{company_id}': {
                pathParams: [
                    { name: 'company_id', label: 'Company ID', type: 'number', required: true, placeholder: 'e.g. 1' },
                ],
                fields: [
                    { name: 'force_rediscover', label: 'Force Re-detect ATS', type: 'select', options: [
                        { value: 'false', label: 'No (default)' }, { value: 'true', label: 'Yes' },
                    ]},
                ],
            },
            '/api/v1/job-postings/discover-ats/{company_id}': {
                pathParams: [
                    { name: 'company_id', label: 'Company ID', type: 'number', required: true, placeholder: 'e.g. 1' },
                ],
            },

            // ‚îÄ‚îÄ Site Intel ‚îÄ‚îÄ
            '/api/v1/site-intel/sites/collect': {
                fields: [
                    { name: 'states', label: 'State Codes (comma-sep, blank = all)', type: 'text', placeholder: 'TX,CA,NY (optional filter)' },
                ],
            },
            // ‚îÄ‚îÄ PE Collection ‚îÄ‚îÄ
            '/api/v1/pe/collection/collect': {
                fields: [
                    { name: 'entity_type', label: 'Entity Type', type: 'select', options: [
                        { value: 'firm', label: 'Firm (default)' },
                        { value: 'company', label: 'Company' },
                        { value: 'person', label: 'Person' },
                        { value: 'deal', label: 'Deal' },
                    ]},
                    { name: 'firm_ids', label: 'Firm IDs (comma-sep, blank = all)', type: 'text', placeholder: '1,2,3 (optional)' },
                    { name: 'max_concurrent', label: 'Max Concurrent', type: 'number', placeholder: '5' },
                    { name: 'rate_limit_delay', label: 'Rate Limit Delay (sec)', type: 'number', placeholder: '2.0' },
                ],
            },

            // ‚îÄ‚îÄ USDA ‚îÄ‚îÄ
            '/api/v1/usda/crop/ingest': {
                fields: [
                    { name: 'commodity', label: 'Commodity', type: 'select', required: true, options: [
                        { value: 'CORN', label: 'Corn' }, { value: 'SOYBEANS', label: 'Soybeans' },
                        { value: 'WHEAT', label: 'Wheat' }, { value: 'RICE', label: 'Rice' },
                        { value: 'COTTON', label: 'Cotton' }, { value: 'BARLEY', label: 'Barley' },
                        { value: 'OATS', label: 'Oats' }, { value: 'SORGHUM', label: 'Sorghum' },
                    ]},
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2025' },
                    { name: 'state', label: 'State (blank = national)', type: 'text', placeholder: 'e.g. IOWA, ILLINOIS' },
                ],
            },
            '/api/v1/usda/livestock/ingest': {
                fields: [
                    { name: 'commodity', label: 'Livestock Type', type: 'select', required: true, options: [
                        { value: 'CATTLE', label: 'Cattle' }, { value: 'HOGS', label: 'Hogs' },
                        { value: 'SHEEP', label: 'Sheep' }, { value: 'CHICKENS', label: 'Chickens' },
                        { value: 'TURKEYS', label: 'Turkeys' },
                    ]},
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2025' },
                    { name: 'state', label: 'State (blank = national)', type: 'text', placeholder: 'e.g. TEXAS, IOWA' },
                ],
            },
            '/api/v1/usda/annual-summary/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/usda/all-major-crops/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/noaa/ingest': {
                fields: [
                    { name: 'dataset_key', label: 'Dataset', type: 'select', required: true, options: [
                        { value: 'GHCND', label: 'Daily Summaries' }, { value: 'GSOM', label: 'Monthly Summaries' },
                        { value: 'GSOY', label: 'Yearly Summaries' }, { value: 'NORMAL_DLY', label: 'Climate Normals' },
                    ]},
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                    { name: 'location_id', label: 'Location ID', type: 'text', placeholder: 'e.g. FIPS:06' },
                    { name: 'max_results', label: 'Max Results', type: 'number', placeholder: '1000' },
                ],
            },
            '/api/v1/fbi-crime/estimates/ingest': {
                fields: [
                    { name: 'scope', label: 'Scope', type: 'select', options: [
                        { value: 'national', label: 'National' }, { value: 'state', label: 'State-level' },
                    ]},
                    { name: 'offenses', label: 'Offenses (comma-sep)', type: 'text',
                      placeholder: 'violent-crime,property-crime,homicide,robbery (blank = all)' },
                    { name: 'states', label: 'States (comma-sep, for state scope)', type: 'text', placeholder: 'CA,TX,NY' },
                ],
            },
            '/api/v1/fbi-crime/summarized/ingest': {
                fields: [
                    { name: 'states', label: 'States (comma-sep)', type: 'text', placeholder: 'CA,TX,NY (blank = all)' },
                    { name: 'offenses', label: 'Offenses (comma-sep)', type: 'text',
                      placeholder: 'burglary,larceny,robbery (blank = all)' },
                    { name: 'since', label: 'Since Year', type: 'number', placeholder: '2010' },
                    { name: 'until', label: 'Until Year', type: 'number', placeholder: '2023' },
                ],
            },
            '/api/v1/fbi-crime/nibrs/ingest': {
                fields: [
                    { name: 'states', label: 'States (comma-sep)', type: 'text', placeholder: 'CA,TX,NY (blank = all)' },
                    { name: 'variables', label: 'Variables (comma-sep)', type: 'text',
                      placeholder: 'count,offense,victim/age,offender/race (blank = all)' },
                ],
            },
            '/api/v1/fbi-crime/hate-crime/ingest': {
                fields: [
                    { name: 'states', label: 'States (comma-sep)', type: 'text', placeholder: 'CA,TX,NY (blank = national)' },
                ],
            },
            '/api/v1/fbi-crime/leoka/ingest': {
                fields: [
                    { name: 'states', label: 'States (comma-sep)', type: 'text', placeholder: 'CA,TX,NY (blank = national)' },
                ],
            },
            '/api/v1/fbi-crime/ingest/all': {
                fields: [
                    { name: 'datasets', label: 'Datasets (comma-sep)', type: 'text',
                      placeholder: 'estimates_national,summarized,nibrs,hate_crime,leoka' },
                    { name: 'include_states', label: 'Include state-level data', type: 'select', options: [
                        { value: 'false', label: 'No (national only)' }, { value: 'true', label: 'Yes (more API calls)' },
                    ]},
                ],
            },
            '/api/v1/kaggle/m5/ingest': {
                fields: [
                    { name: 'force_download', label: 'Force Download', type: 'select', options: [{ value: '', label: 'No' }, { value: 'true', label: 'Yes' }]},
                    { name: 'limit_items', label: 'Limit Items', type: 'number', placeholder: '1000' },
                ],
            },
            '/api/v1/kaggle/m5/prepare-tables': {
                fields: [],
            },
            // ‚îÄ‚îÄ Yelp ‚îÄ‚îÄ
            '/api/v1/yelp/businesses/ingest': {
                fields: [
                    { name: 'location', label: 'Location', type: 'text', required: true, placeholder: 'e.g. San Francisco, CA' },
                    { name: 'term', label: 'Search Term', type: 'text', placeholder: 'e.g. restaurants' },
                    { name: 'categories', label: 'Categories', type: 'text', placeholder: 'e.g. bars,nightlife' },
                    { name: 'limit', label: 'Limit', type: 'number', placeholder: '50' },
                ],
            },
            '/api/v1/yelp/businesses/multi-location/ingest': {
                fields: [
                    { name: 'locations', label: 'Locations (comma-sep)', type: 'text', required: true,
                      placeholder: 'San Francisco CA, New York NY, Chicago IL' },
                    { name: 'term', label: 'Search Term', type: 'text', placeholder: 'e.g. restaurants, coffee shops' },
                    { name: 'categories', label: 'Categories', type: 'text', placeholder: 'e.g. restaurants,bars' },
                    { name: 'limit_per_location', label: 'Limit per Location', type: 'number', placeholder: '20 (max 50)' },
                ],
            },
            '/api/v1/yelp/categories/ingest': {
                fields: [],
            },
            // ‚îÄ‚îÄ USPTO ‚îÄ‚îÄ
            '/api/v1/uspto/ingest/assignee': {
                fields: [
                    { name: 'assignee_name', label: 'Assignee Name', type: 'text', required: true,
                      placeholder: 'e.g. Apple Inc., Google LLC, Microsoft' },
                    { name: 'date_from', label: 'Date From', type: 'date' },
                    { name: 'date_to', label: 'Date To', type: 'date' },
                    { name: 'max_patents', label: 'Max Patents', type: 'number', placeholder: '1000 (max 10000)' },
                ],
            },
            '/api/v1/uspto/ingest/cpc': {
                fields: [
                    { name: 'cpc_code', label: 'CPC Code', type: 'select', required: true, options: [
                        { value: 'G06N', label: 'G06N ‚Äî AI / Machine Learning' },
                        { value: 'G06F', label: 'G06F ‚Äî Computing / Data Processing' },
                        { value: 'H04L', label: 'H04L ‚Äî Networking / Protocols' },
                        { value: 'A61K', label: 'A61K ‚Äî Pharmaceuticals' },
                        { value: 'C12N', label: 'C12N ‚Äî Biotech / Genetic Engineering' },
                        { value: 'H01L', label: 'H01L ‚Äî Semiconductors' },
                        { value: 'B60L', label: 'B60L ‚Äî Electric Vehicles' },
                        { value: 'H02S', label: 'H02S ‚Äî Solar Energy' },
                        { value: 'G16H', label: 'G16H ‚Äî Healthcare Informatics' },
                    ]},
                    { name: 'date_from', label: 'Date From', type: 'date' },
                    { name: 'date_to', label: 'Date To', type: 'date' },
                    { name: 'max_patents', label: 'Max Patents', type: 'number', placeholder: '1000 (max 10000)' },
                ],
            },
            '/api/v1/uspto/ingest/search': {
                fields: [
                    { name: 'search_query', label: 'Search Query', type: 'text', required: true,
                      placeholder: 'e.g. machine learning, autonomous vehicle, CRISPR' },
                    { name: 'date_from', label: 'Date From', type: 'date' },
                    { name: 'date_to', label: 'Date To', type: 'date' },
                    { name: 'max_patents', label: 'Max Patents', type: 'number', placeholder: '1000 (max 10000)' },
                ],
            },
            '/api/v1/fema/{dataset}/ingest': {
                pathParams: [{ name: 'dataset', label: 'Dataset', type: 'select', required: true, options: [
                    { value: 'disasters', label: 'Disaster Declarations' }, { value: 'public-assistance', label: 'Public Assistance' },
                    { value: 'hazard-mitigation', label: 'Hazard Mitigation' },
                ]}],
                fields: [
                    { name: 'state', label: 'State', type: 'text', placeholder: 'e.g. CA' },
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2025' },
                    { name: 'max_records', label: 'Max Records', type: 'number', placeholder: '1000' },
                ],
            },
            '/api/v1/bts/border-crossing/ingest': {
                fields: [
                    { name: 'border', label: 'Border', type: 'select', options: [
                        { value: '', label: 'Both borders' },
                        { value: 'US-Mexico Border', label: 'US-Mexico' },
                        { value: 'US-Canada Border', label: 'US-Canada' },
                    ]},
                    { name: 'measure', label: 'Measure', type: 'select', options: [
                        { value: '', label: 'All measures' },
                        { value: 'Trucks', label: 'Trucks' },
                        { value: 'Personal Vehicles', label: 'Personal Vehicles' },
                        { value: 'Pedestrians', label: 'Pedestrians' },
                        { value: 'Trains', label: 'Trains' },
                        { value: 'Buses', label: 'Buses' },
                        { value: 'Loaded Truck Containers', label: 'Loaded Truck Containers' },
                    ]},
                    { name: 'state', label: 'State (blank = all)', type: 'text', placeholder: 'e.g. TX, CA, NY' },
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                ],
            },
            '/api/v1/bts/vmt/ingest': {
                fields: [
                    { name: 'state', label: 'State (blank = all)', type: 'text', placeholder: 'e.g. Texas, California' },
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                ],
            },
            '/api/v1/bts/faf/ingest': {
                fields: [
                    { name: 'version', label: 'FAF Version', type: 'select', options: [
                        { value: 'regional_2018_2024', label: 'Regional 2018-2024' },
                        { value: 'regional_forecasts', label: 'Regional Forecasts' },
                        { value: 'state_2018_2024', label: 'State 2018-2024' },
                    ]},
                ],
            },
            // ‚îÄ‚îÄ Data Commons ‚îÄ‚îÄ
            '/api/v1/data-commons/stat-var/ingest': {
                fields: [
                    { name: 'variable_dcid', label: 'Statistical Variable', type: 'select', options: [
                        {value:'Count_Person',label:'Population (Count_Person)'},
                        {value:'Median_Income_Household',label:'Median Household Income'},
                        {value:'UnemploymentRate_Person',label:'Unemployment Rate'},
                        {value:'Median_Age_Person',label:'Median Age'},
                        {value:'Count_Household',label:'Number of Households'},
                        {value:'Count_HousingUnit',label:'Housing Units'},
                        {value:'Count_Person_Employed',label:'Employed Persons'},
                        {value:'Count_Person_Unemployed',label:'Unemployed Persons'},
                        {value:'Median_Income_Person',label:'Median Personal Income'},
                        {value:'Count_Person_BelowPovertyLine',label:'Below Poverty Line'},
                        {value:'Count_CriminalActivities_CombinedCrime',label:'Total Crime'},
                        {value:'Count_CriminalActivities_ViolentCrime',label:'Violent Crime'},
                        {value:'LifeExpectancy_Person',label:'Life Expectancy'},
                        {value:'Amount_EconomicActivity_GrossDomesticProduction_RealValue',label:'Real GDP'},
                    ]},
                    { name: 'places', label: 'Places (comma-sep DCIDs)', type: 'text',
                      placeholder: 'geoId/06,geoId/48,geoId/36 (CA, TX, NY)' },
                ],
            },
            '/api/v1/data-commons/place-stats/ingest': {
                fields: [
                    { name: 'place_dcid', label: 'Place', type: 'select', options: [
                        {value:'geoId/06',label:'California (geoId/06)'},
                        {value:'geoId/48',label:'Texas (geoId/48)'},
                        {value:'geoId/36',label:'New York (geoId/36)'},
                        {value:'geoId/12',label:'Florida (geoId/12)'},
                        {value:'geoId/17',label:'Illinois (geoId/17)'},
                        {value:'geoId/42',label:'Pennsylvania (geoId/42)'},
                        {value:'geoId/39',label:'Ohio (geoId/39)'},
                        {value:'geoId/13',label:'Georgia (geoId/13)'},
                        {value:'geoId/37',label:'North Carolina (geoId/37)'},
                        {value:'geoId/26',label:'Michigan (geoId/26)'},
                        {value:'country/USA',label:'United States (country/USA)'},
                    ]},
                    { name: 'variables', label: 'Variables (comma-sep, blank = top 20)', type: 'text',
                      placeholder: 'Count_Person,Median_Income_Household,UnemploymentRate_Person' },
                ],
            },
            '/api/v1/data-commons/us-states/ingest': {
                fields: [
                    { name: 'variables', label: 'Variables', type: 'checkbox-group', options: [
                        {value:'Count_Person',label:'Population'},
                        {value:'Median_Income_Household',label:'Median Household Income'},
                        {value:'UnemploymentRate_Person',label:'Unemployment Rate'},
                        {value:'Median_Age_Person',label:'Median Age'},
                        {value:'Count_Household',label:'Households'},
                        {value:'Count_Person_Employed',label:'Employed'},
                        {value:'Count_Person_BelowPovertyLine',label:'Below Poverty Line'},
                        {value:'Count_CriminalActivities_CombinedCrime',label:'Total Crime'},
                        {value:'LifeExpectancy_Person',label:'Life Expectancy'},
                        {value:'Amount_EconomicActivity_GrossDomesticProduction_RealValue',label:'Real GDP'},
                    ]},
                ],
            },
            '/api/v1/prediction-markets/monitor/all': {
                fields: [
                    { name: 'kalshi_categories', label: 'Kalshi Categories', type: 'checkbox-group', options: [
                        { value: 'FED', label: 'Fed Rate Decisions' },
                        { value: 'CPI', label: 'CPI / Inflation' },
                        { value: 'UNRATE', label: 'Unemployment Rate' },
                        { value: 'GDP', label: 'GDP Growth' },
                        { value: 'INXD', label: 'Stock Market Indices' },
                        { value: 'PRES', label: 'Presidential Election' },
                        { value: 'SENATE', label: 'Senate Control' },
                        { value: 'HOUSE', label: 'House Control' },
                        { value: 'BTCUSD', label: 'Bitcoin Price' },
                        { value: 'ETHUSD', label: 'Ethereum Price' },
                        { value: 'CLIMATE', label: 'Climate / Weather' },
                    ]},
                    { name: 'limit_per_platform', label: 'Markets per platform (10-200)', type: 'number', placeholder: '50' },
                ],
            },
            '/api/v1/prediction-markets/monitor/kalshi': {
                queryParams: [
                    { name: 'categories', label: 'Kalshi Categories', type: 'checkbox-group', options: [
                        { value: 'FED', label: 'Fed Rate Decisions' },
                        { value: 'CPI', label: 'CPI / Inflation' },
                        { value: 'UNRATE', label: 'Unemployment Rate' },
                        { value: 'GDP', label: 'GDP Growth' },
                        { value: 'INXD', label: 'Stock Market Indices' },
                        { value: 'PRES', label: 'Presidential Election' },
                        { value: 'SENATE', label: 'Senate Control' },
                        { value: 'HOUSE', label: 'House Control' },
                        { value: 'BTCUSD', label: 'Bitcoin Price' },
                        { value: 'ETHUSD', label: 'Ethereum Price' },
                        { value: 'CLIMATE', label: 'Climate / Weather' },
                    ]},
                    { name: 'limit', label: 'Max markets (10-200)', type: 'number', placeholder: '50' },
                ],
            },
            '/api/v1/prediction-markets/monitor/polymarket': {
                queryParams: [
                    { name: 'limit', label: 'Max markets (10-200)', type: 'number', placeholder: '50' },
                ],
            },
            '/api/v1/international/worldbank/wdi/ingest': {
                fields: [
                    { name: 'indicators', label: 'WDI Indicators', type: 'checkbox-group', options: [
                        { value: 'NY.GDP.MKTP.CD', label: 'GDP (current US$)' },
                        { value: 'NY.GDP.MKTP.KD.ZG', label: 'GDP growth (annual %)' },
                        { value: 'NY.GDP.PCAP.CD', label: 'GDP per capita' },
                        { value: 'NY.GDP.PCAP.PP.CD', label: 'GDP per capita, PPP' },
                        { value: 'SP.POP.TOTL', label: 'Population, total' },
                        { value: 'SP.POP.GROW', label: 'Population growth (%)' },
                        { value: 'FP.CPI.TOTL.ZG', label: 'Inflation, CPI (%)' },
                        { value: 'SL.UEM.TOTL.ZS', label: 'Unemployment (%)' },
                        { value: 'NE.TRD.GNFS.ZS', label: 'Trade (% of GDP)' },
                        { value: 'BN.CAB.XOKA.CD', label: 'Current account balance' },
                        { value: 'SP.DYN.LE00.IN', label: 'Life expectancy' },
                        { value: 'SI.POV.GINI', label: 'Gini index' },
                        { value: 'EN.ATM.CO2E.PC', label: 'CO2 emissions per capita' },
                        { value: 'SE.XPD.TOTL.GD.ZS', label: 'Education spending (% GDP)' },
                        { value: 'SH.XPD.CHEX.GD.ZS', label: 'Health spending (% GDP)' },
                        { value: 'EG.FEC.RNEW.ZS', label: 'Renewable energy (%)' },
                    ]},
                    { name: 'countries', label: 'Countries (ISO3 codes, comma-sep)', type: 'text',
                      placeholder: 'USA,CHN,JPN,DEU,GBR (blank = all countries)' },
                    { name: 'start_year', label: 'Start Year', type: 'number', placeholder: '2015' },
                    { name: 'end_year', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/international/worldbank/countries/ingest': {
                fields: [],
            },
            '/api/v1/international/worldbank/indicators/ingest': {
                fields: [
                    { name: 'search', label: 'Search term (blank = all)', type: 'text',
                      placeholder: 'e.g. GDP, population, health, trade' },
                    { name: 'max_results', label: 'Max results', type: 'number', placeholder: '1000' },
                ],
            },
            '/api/v1/international/imf/ifs/ingest': {
                fields: [
                    { name: 'indicator', label: 'IFS Indicator', type: 'select', required: true, options: [
                        { value: 'NGDP_R_XDC', label: 'Real GDP (local currency)' },
                        { value: 'NGDP_XDC', label: 'Nominal GDP (local currency)' },
                        { value: 'NGDPD', label: 'GDP (current US$)' },
                        { value: 'NGDP_RPCH', label: 'GDP growth (annual %)' },
                        { value: 'PCPI_IX', label: 'Consumer Price Index' },
                        { value: 'PCPIE_IX', label: 'CPI (End of Period)' },
                        { value: 'PCPIEPCH', label: 'CPI Inflation (annual %)' },
                        { value: 'FPOLM', label: 'Policy Rate (Central Bank)' },
                        { value: 'FILR', label: 'Lending Rate' },
                        { value: 'FITB', label: 'Treasury Bill Rate' },
                        { value: 'ENEER', label: 'Nominal Effective Exchange Rate' },
                        { value: 'EREER', label: 'Real Effective Exchange Rate' },
                        { value: 'ENDA', label: 'Exchange Rate (per US$, avg)' },
                        { value: 'BCA', label: 'Current Account Balance' },
                        { value: 'TMG_CIF_USD', label: 'Imports (CIF, US$)' },
                        { value: 'TXG_FOB_USD', label: 'Exports (FOB, US$)' },
                        { value: 'GGXWDG', label: 'General Government Debt' },
                        { value: 'GGXONLB', label: 'Government Expenditure' },
                        { value: 'LUR', label: 'Unemployment Rate' },
                        { value: 'LP', label: 'Population' },
                    ]},
                    { name: 'countries', label: 'Countries (ISO3, comma-sep)', type: 'text',
                      placeholder: 'USA,GBR,JPN,DEU,FRA (blank = all)' },
                    { name: 'start_year', label: 'Start Year', type: 'number', placeholder: '2015' },
                    { name: 'end_year', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/international/oecd/mei/ingest': {
                fields: [
                    { name: 'countries', label: 'Countries (ISO3, comma-sep)', type: 'text',
                      placeholder: 'USA,GBR,DEU,FRA,JPN (blank = all OECD)' },
                    { name: 'subjects', label: 'Subjects (comma-sep codes)', type: 'text',
                      placeholder: 'blank = all (CLI, industrial production, CPI, etc.)' },
                    { name: 'start_period', label: 'Start Year', type: 'number', placeholder: '2015' },
                    { name: 'end_period', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/international/oecd/kei/ingest': {
                fields: [
                    { name: 'countries', label: 'Countries (ISO3, comma-sep)', type: 'text',
                      placeholder: 'USA,GBR,DEU,FRA,JPN (blank = all OECD)' },
                    { name: 'start_period', label: 'Start Year', type: 'number', placeholder: '2015' },
                    { name: 'end_period', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/international/oecd/labor/ingest': {
                fields: [
                    { name: 'countries', label: 'Countries (ISO3, comma-sep)', type: 'text',
                      placeholder: 'USA,GBR,DEU,FRA,JPN (blank = all OECD)' },
                    { name: 'start_period', label: 'Start Year', type: 'number', placeholder: '2015' },
                    { name: 'end_period', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/international/oecd/trade/ingest': {
                fields: [
                    { name: 'countries', label: 'Countries (ISO3, comma-sep)', type: 'text',
                      placeholder: 'USA,GBR,DEU,FRA,JPN (blank = all OECD)' },
                    { name: 'start_period', label: 'Start Year', type: 'number', placeholder: '2015' },
                    { name: 'end_period', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/international/oecd/tax/ingest': {
                fields: [
                    { name: 'countries', label: 'Countries (ISO3, comma-sep)', type: 'text',
                      placeholder: 'USA,GBR,DEU,FRA,JPN (blank = all OECD)' },
                    { name: 'start_period', label: 'Start Year', type: 'number', placeholder: '2000' },
                    { name: 'end_period', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/international/bis/eer/ingest': {
                fields: [
                    { name: 'eer_type', label: 'Exchange Rate Type', type: 'select', options: [
                        { value: 'R', label: 'Real (inflation-adjusted)' },
                        { value: 'N', label: 'Nominal' },
                    ]},
                    { name: 'countries', label: 'Countries (ISO3, comma-sep)', type: 'text',
                      placeholder: 'USA,GBR,DEU,JPN,CHN (blank = all)' },
                    { name: 'start_period', label: 'Start Year', type: 'number', placeholder: '2015' },
                    { name: 'end_period', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/international/bis/property/ingest': {
                fields: [
                    { name: 'countries', label: 'Countries (ISO3, comma-sep)', type: 'text',
                      placeholder: 'USA,GBR,DEU,FRA,JPN (blank = all)' },
                    { name: 'start_period', label: 'Start Year', type: 'number', placeholder: '2015' },
                    { name: 'end_period', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/international/{dataset}/ingest': {
                pathParams: [{ name: 'dataset', label: 'Dataset', type: 'select', required: true, options: [
                    { value: 'worldbank/wdi', label: 'World Bank WDI' }, { value: 'worldbank/countries', label: 'WB Countries' },
                    { value: 'imf/ifs', label: 'IMF IFS' }, { value: 'oecd/mei', label: 'OECD MEI' },
                    { value: 'oecd/kei', label: 'OECD KEI' }, { value: 'oecd/labor', label: 'OECD Labor' },
                    { value: 'oecd/trade', label: 'OECD Trade' }, { value: 'bis/eer', label: 'BIS Exchange Rates' },
                    { value: 'bis/property', label: 'BIS Property' },
                ]}],
                fields: [
                    { name: 'indicators', label: 'Indicators (comma-sep)', type: 'text', placeholder: 'NY.GDP.MKTP.CD' },
                    { name: 'countries', label: 'Countries (comma-sep)', type: 'text', placeholder: 'USA,GBR,DEU' },
                    { name: 'start_year', label: 'Start Year', type: 'number', placeholder: '2020' },
                    { name: 'end_year', label: 'End Year', type: 'number', placeholder: '2025' },
                ],
            },
            '/api/v1/us-trade/exports/hs/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', required: true, placeholder: '2025' },
                    { name: 'month', label: 'Month (1-12, blank = annual)', type: 'number', placeholder: 'blank = annual totals' },
                    { name: 'hs_code', label: 'HS Chapter/Code', type: 'select', options: [
                        { value: '', label: 'All commodities' },
                        { value: '27', label: '27 ‚Äî Mineral fuels, oils' },
                        { value: '84', label: '84 ‚Äî Machinery, mechanical' },
                        { value: '85', label: '85 ‚Äî Electrical machinery' },
                        { value: '87', label: '87 ‚Äî Vehicles' },
                        { value: '88', label: '88 ‚Äî Aircraft, spacecraft' },
                        { value: '90', label: '90 ‚Äî Optical, medical instruments' },
                        { value: '30', label: '30 ‚Äî Pharmaceuticals' },
                        { value: '39', label: '39 ‚Äî Plastics' },
                        { value: '71', label: '71 ‚Äî Precious metals, gems' },
                        { value: '72', label: '72 ‚Äî Iron and steel' },
                        { value: '12', label: '12 ‚Äî Oil seeds, grains' },
                        { value: '10', label: '10 ‚Äî Cereals' },
                    ]},
                    { name: 'country', label: 'Country (Census code)', type: 'select', options: [
                        { value: '', label: 'All countries' },
                        { value: '1220', label: 'Canada' },
                        { value: '2010', label: 'Mexico' },
                        { value: '5700', label: 'China' },
                        { value: '5880', label: 'Japan' },
                        { value: '5800', label: 'South Korea' },
                        { value: '5830', label: 'Taiwan' },
                        { value: '4120', label: 'United Kingdom' },
                        { value: '4280', label: 'Germany' },
                        { value: '4759', label: 'India' },
                        { value: '5520', label: 'Singapore' },
                    ]},
                ],
            },
            '/api/v1/us-trade/imports/hs/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', required: true, placeholder: '2025' },
                    { name: 'month', label: 'Month (1-12, blank = annual)', type: 'number', placeholder: 'blank = annual totals' },
                    { name: 'hs_code', label: 'HS Chapter/Code', type: 'select', options: [
                        { value: '', label: 'All commodities' },
                        { value: '27', label: '27 ‚Äî Mineral fuels, oils' },
                        { value: '84', label: '84 ‚Äî Machinery, mechanical' },
                        { value: '85', label: '85 ‚Äî Electrical machinery' },
                        { value: '87', label: '87 ‚Äî Vehicles' },
                        { value: '30', label: '30 ‚Äî Pharmaceuticals' },
                        { value: '39', label: '39 ‚Äî Plastics' },
                        { value: '61', label: '61 ‚Äî Knitted apparel' },
                        { value: '62', label: '62 ‚Äî Woven apparel' },
                        { value: '71', label: '71 ‚Äî Precious metals, gems' },
                        { value: '72', label: '72 ‚Äî Iron and steel' },
                        { value: '94', label: '94 ‚Äî Furniture' },
                        { value: '95', label: '95 ‚Äî Toys, games' },
                    ]},
                    { name: 'country', label: 'Country (Census code)', type: 'select', options: [
                        { value: '', label: 'All countries' },
                        { value: '5700', label: 'China' },
                        { value: '2010', label: 'Mexico' },
                        { value: '1220', label: 'Canada' },
                        { value: '5880', label: 'Japan' },
                        { value: '5800', label: 'South Korea' },
                        { value: '5830', label: 'Taiwan' },
                        { value: '4280', label: 'Germany' },
                        { value: '4120', label: 'United Kingdom' },
                        { value: '5520', label: 'Vietnam' },
                        { value: '4759', label: 'India' },
                    ]},
                ],
            },
            '/api/v1/us-trade/exports/state/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', required: true, placeholder: '2025' },
                    { name: 'month', label: 'Month (1-12, blank = annual)', type: 'number', placeholder: 'blank = annual totals' },
                    { name: 'state', label: 'State', type: 'select', options: [
                        { value: '', label: 'All states' },
                        { value: '06', label: 'California' },
                        { value: '48', label: 'Texas' },
                        { value: '36', label: 'New York' },
                        { value: '17', label: 'Illinois' },
                        { value: '12', label: 'Florida' },
                        { value: '42', label: 'Pennsylvania' },
                        { value: '39', label: 'Ohio' },
                        { value: '22', label: 'Louisiana' },
                        { value: '53', label: 'Washington' },
                        { value: '26', label: 'Michigan' },
                        { value: '13', label: 'Georgia' },
                        { value: '34', label: 'New Jersey' },
                    ]},
                    { name: 'hs_code', label: 'HS Chapter (blank = all)', type: 'text', placeholder: 'e.g. 84, 85, 27' },
                    { name: 'country', label: 'Country (Census code, blank = all)', type: 'text', placeholder: 'e.g. 5700 for China' },
                ],
            },
            '/api/v1/us-trade/port/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', required: true, placeholder: '2025' },
                    { name: 'trade_type', label: 'Trade Type', type: 'select', required: true, options: [
                        { value: 'export', label: 'Exports' },
                        { value: 'import', label: 'Imports' },
                    ]},
                    { name: 'month', label: 'Month (1-12, blank = annual)', type: 'number', placeholder: 'blank = annual totals' },
                    { name: 'district', label: 'Customs District', type: 'select', options: [
                        { value: '', label: 'All districts' },
                        { value: '26', label: 'Houston, TX' },
                        { value: '37', label: 'Los Angeles, CA' },
                        { value: '10', label: 'New York, NY' },
                        { value: '25', label: 'New Orleans, LA' },
                        { value: '17', label: 'Savannah, GA' },
                        { value: '16', label: 'Charleston, SC' },
                        { value: '35', label: 'Seattle, WA' },
                        { value: '20', label: 'Miami, FL' },
                        { value: '27', label: 'Laredo, TX' },
                        { value: '43', label: 'Detroit, MI' },
                        { value: '14', label: 'Norfolk, VA' },
                        { value: '30', label: 'San Diego, CA' },
                    ]},
                    { name: 'hs_code', label: 'HS Chapter (blank = all)', type: 'text', placeholder: 'e.g. 84, 27' },
                    { name: 'country', label: 'Country (Census code, blank = all)', type: 'text', placeholder: 'e.g. 5700 for China' },
                ],
            },
            '/api/v1/us-trade/summary/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', required: true, placeholder: '2025' },
                    { name: 'month', label: 'Month (1-12, blank = annual)', type: 'number', placeholder: 'blank = annual totals' },
                ],
            },
            '/api/v1/cftc-cot/ingest': {
                fields: [
                    { name: 'year', label: 'Year', type: 'number', placeholder: '2026' },
                    { name: 'report_type', label: 'Report Type', type: 'select', options: [
                        { value: 'legacy', label: 'Legacy (Commercial vs Non-Commercial)' },
                        { value: 'disaggregated', label: 'Disaggregated (Producer, Swap, Managed Money)' },
                        { value: 'tff', label: 'TFF (Traders in Financial Futures)' },
                        { value: 'all', label: 'All report types' },
                    ]},
                    { name: 'combined', label: 'Include Options', type: 'select', options: [
                        { value: 'true', label: 'Futures + Options combined' },
                        { value: 'false', label: 'Futures only' },
                    ]},
                ],
            },
            '/api/v1/irs-soi/zip-income/ingest': {
                fields: [
                    { name: 'year', label: 'Tax Year', type: 'select', options: [
                        { value: '2021', label: '2021' }, { value: '2020', label: '2020' },
                        { value: '2019', label: '2019' }, { value: '2018', label: '2018' },
                        { value: '2017', label: '2017' },
                    ]},
                    { name: 'use_cache', label: 'Use cached download', type: 'select', options: [
                        { value: 'true', label: 'Yes (faster)' }, { value: 'false', label: 'No (re-download)' },
                    ]},
                ],
            },
            '/api/v1/irs-soi/county-income/ingest': {
                fields: [
                    { name: 'year', label: 'Tax Year', type: 'select', options: [
                        { value: '2021', label: '2021' }, { value: '2020', label: '2020' },
                        { value: '2019', label: '2019' }, { value: '2018', label: '2018' },
                        { value: '2017', label: '2017' },
                    ]},
                    { name: 'use_cache', label: 'Use cached download', type: 'select', options: [
                        { value: 'true', label: 'Yes (faster)' }, { value: 'false', label: 'No (re-download)' },
                    ]},
                ],
            },
            '/api/v1/irs-soi/migration/ingest': {
                fields: [
                    { name: 'year', label: 'Tax Year', type: 'select', options: [
                        { value: '2021', label: '2021' }, { value: '2020', label: '2020' },
                        { value: '2019', label: '2019' }, { value: '2018', label: '2018' },
                        { value: '2017', label: '2017' },
                    ]},
                    { name: 'flow_type', label: 'Migration Flow', type: 'select', options: [
                        { value: 'both', label: 'Both (inflow + outflow)' },
                        { value: 'inflow', label: 'Inflow only' },
                        { value: 'outflow', label: 'Outflow only' },
                    ]},
                    { name: 'use_cache', label: 'Use cached download', type: 'select', options: [
                        { value: 'true', label: 'Yes (faster)' }, { value: 'false', label: 'No (re-download)' },
                    ]},
                ],
            },
            '/api/v1/irs-soi/business-income/ingest': {
                fields: [
                    { name: 'year', label: 'Tax Year', type: 'select', options: [
                        { value: '2021', label: '2021' }, { value: '2020', label: '2020' },
                        { value: '2019', label: '2019' }, { value: '2018', label: '2018' },
                        { value: '2017', label: '2017' },
                    ]},
                    { name: 'use_cache', label: 'Use cached download', type: 'select', options: [
                        { value: 'true', label: 'Yes (faster)' }, { value: 'false', label: 'No (re-download)' },
                    ]},
                ],
            },
            '/api/v1/irs-soi/all/ingest': {
                fields: [
                    { name: 'year', label: 'Tax Year', type: 'select', options: [
                        { value: '2021', label: '2021' }, { value: '2020', label: '2020' },
                        { value: '2019', label: '2019' }, { value: '2018', label: '2018' },
                        { value: '2017', label: '2017' },
                    ]},
                    { name: 'use_cache', label: 'Use cached download', type: 'select', options: [
                        { value: 'true', label: 'Yes (faster)' }, { value: 'false', label: 'No (re-download)' },
                    ]},
                ],
            },
            // ‚îÄ‚îÄ FCC Broadband ‚îÄ‚îÄ
            '/api/v1/fcc-broadband/state/ingest': {
                fields: [
                    { name: 'state_codes', label: 'State Codes (2-letter, comma-sep)', type: 'text', required: true,
                      placeholder: 'CA,TX,NY,FL' },
                    { name: 'include_summary', label: 'Include Summary Stats', type: 'select', options: [
                        { value: 'true', label: 'Yes' }, { value: 'false', label: 'No' },
                    ]},
                ],
            },
            '/api/v1/fcc-broadband/all-states/ingest': {
                fields: [
                    { name: 'include_summary', label: 'Include Summary Stats', type: 'select', options: [
                        { value: 'true', label: 'Yes' }, { value: 'false', label: 'No' },
                    ]},
                ],
            },
            '/api/v1/fcc-broadband/county/ingest': {
                fields: [
                    { name: 'county_fips_codes', label: 'County FIPS Codes (5-digit, comma-sep)', type: 'text', required: true,
                      placeholder: '06037,48201,36061 (LA, Houston, Manhattan)' },
                    { name: 'include_summary', label: 'Include Summary Stats', type: 'select', options: [
                        { value: 'true', label: 'Yes' }, { value: 'false', label: 'No' },
                    ]},
                ],
            },
            // ‚îÄ‚îÄ Real Estate ‚îÄ‚îÄ
            '/api/v1/realestate/fhfa/ingest': {
                fields: [
                    { name: 'geography_type', label: 'Geography', type: 'select', options: [
                        { value: '', label: 'All (National + State + MSA)' },
                        { value: 'National', label: 'National' }, { value: 'State', label: 'State' },
                        { value: 'MSA', label: 'MSA' }, { value: 'ZIP3', label: 'ZIP3' },
                    ]},
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                ],
            },
            '/api/v1/realestate/hud/ingest': {
                fields: [
                    { name: 'geography_type', label: 'Geography', type: 'select', options: [
                        { value: 'National', label: 'National' }, { value: 'State', label: 'State' },
                        { value: 'MSA', label: 'MSA' }, { value: 'County', label: 'County' },
                    ]},
                    { name: 'geography_id', label: 'Geography ID (for State/MSA/County)', type: 'text',
                      placeholder: 'e.g. 06 (CA FIPS), 31080 (LA MSA)' },
                    { name: 'start_date', label: 'Start Date', type: 'date' },
                    { name: 'end_date', label: 'End Date', type: 'date' },
                ],
            },
            '/api/v1/realestate/redfin/ingest': {
                fields: [
                    { name: 'region_type', label: 'Region Type', type: 'select', options: [
                        { value: 'zip', label: 'ZIP Code' }, { value: 'city', label: 'City' },
                        { value: 'neighborhood', label: 'Neighborhood' }, { value: 'metro', label: 'Metro' },
                    ]},
                    { name: 'property_type', label: 'Property Type', type: 'select', options: [
                        { value: 'All Residential', label: 'All Residential' },
                        { value: 'Single Family Residential', label: 'Single Family' },
                        { value: 'Multi-Family (2-4 Unit)', label: 'Multi-Family (2-4)' },
                        { value: 'Condo/Co-op', label: 'Condo/Co-op' },
                        { value: 'Townhouse', label: 'Townhouse' },
                    ]},
                ],
            },
            '/api/v1/realestate/osm/ingest': {
                fields: [
                    { name: 'bounding_box', label: 'Bounding Box (south,west,north,east)', type: 'text', required: true,
                      placeholder: '34.0,-118.5,34.1,-118.4 (LA example)' },
                    { name: 'building_type', label: 'Building Type', type: 'select', options: [
                        { value: '', label: 'All types' },
                        { value: 'residential', label: 'Residential' }, { value: 'commercial', label: 'Commercial' },
                        { value: 'industrial', label: 'Industrial' }, { value: 'retail', label: 'Retail' },
                        { value: 'office', label: 'Office' }, { value: 'warehouse', label: 'Warehouse' },
                    ]},
                    { name: 'limit', label: 'Max Buildings', type: 'number', placeholder: '10000 (max 50000)' },
                ],
            },
            '/api/v1/foot-traffic/collect': {
                fields: [
                    { name: 'brand_name', label: 'Brand Name', type: 'text', required: true, placeholder: 'e.g. Starbucks' },
                    { name: 'city', label: 'City', type: 'text', placeholder: 'e.g. New York' },
                    { name: 'state', label: 'State', type: 'text', placeholder: 'e.g. NY' },
                    { name: 'start_date', label: 'Start Date', type: 'date' }, { name: 'end_date', label: 'End Date', type: 'date' },
                ],
            },
            '/api/v1/form-d/ingest': { fields: [{ name: 'ciks', label: 'CIKs (comma-sep)', type: 'text', placeholder: '0001234567,0009876543' }] },
            '/api/v1/form-adv/ingest': { fields: [] },
            '/api/v1/opencorporates/ingest': {
                fields: [
                    { name: 'company_names', label: 'Company Names (comma-sep)', type: 'text', required: true, placeholder: 'Acme Inc,Widget Corp' },
                    { name: 'jurisdiction', label: 'Jurisdiction', type: 'text', placeholder: 'e.g. us_de' },
                    { name: 'limit', label: 'Limit', type: 'number', placeholder: '10' },
                ],
            },
            // ‚îÄ‚îÄ App Stores ‚îÄ‚îÄ
            '/api/v1/app-stores/ingest': {
                fields: [
                    { name: 'company_name', label: 'Company Name', type: 'text', placeholder: 'e.g. Uber (blank = all tracked)' },
                    { name: 'search_query', label: 'Search Query', type: 'text', placeholder: 'e.g. ride sharing' },
                    { name: 'limit', label: 'Limit', type: 'number', placeholder: '10 (max 200)' },
                ],
            },
            '/api/v1/app-stores/link': {
                fields: [
                    { name: 'company_name', label: 'Company Name', type: 'text', required: true, placeholder: 'e.g. Uber Technologies' },
                    { name: 'app_id', label: 'App ID', type: 'text', required: true, placeholder: 'e.g. 368677368 (iTunes ID)' },
                    { name: 'store', label: 'Store', type: 'select', options: [
                        { value: 'ios', label: 'iOS (App Store)' },
                        { value: 'android', label: 'Android (Google Play)' },
                    ]},
                    { name: 'relationship', label: 'Relationship', type: 'select', options: [
                        { value: 'owner', label: 'Owner' },
                        { value: 'subsidiary', label: 'Subsidiary' },
                        { value: 'partner', label: 'Partner' },
                    ]},
                ],
            },
            '/api/v1/github/org/{org}/fetch': {
                pathParams: [{ name: 'org', label: 'GitHub Org', type: 'text', required: true, placeholder: 'e.g. facebook' }],
                fields: [],
            },
            // ‚îÄ‚îÄ Glassdoor ‚îÄ‚îÄ
            '/api/v1/glassdoor/company': {
                fields: [
                    { name: 'company_name', label: 'Company Name', type: 'text', required: true, placeholder: 'e.g. Google' },
                    { name: 'website', label: 'Website', type: 'text', placeholder: 'e.g. google.com' },
                    { name: 'industry', label: 'Industry', type: 'text', placeholder: 'e.g. Technology' },
                    { name: 'headquarters', label: 'Headquarters', type: 'text', placeholder: 'e.g. Mountain View, CA' },
                ],
            },
            '/api/v1/glassdoor/salaries/bulk': {
                fields: [
                    { name: 'company_name', label: 'Company Name', type: 'text', required: true, placeholder: 'e.g. Google' },
                    { name: 'salaries', label: 'Salaries (JSON array)', type: 'textarea',
                      placeholder: '[{"job_title":"Software Engineer","base_salary_median":180000,"location":"San Francisco"}]' },
                ],
            },
            '/api/v1/glassdoor/reviews/summary': {
                fields: [
                    { name: 'company_name', label: 'Company Name', type: 'text', required: true, placeholder: 'e.g. Google' },
                    { name: 'period', label: 'Period', type: 'text', required: true, placeholder: '2026-Q1' },
                    { name: 'avg_rating', label: 'Average Rating (1.0-5.0)', type: 'number', required: true, placeholder: '4.2' },
                    { name: 'review_count', label: 'Review Count', type: 'number', required: true, placeholder: '150' },
                    { name: 'top_pros', label: 'Top Pros (comma-sep)', type: 'text', placeholder: 'Great culture, Good pay, Work-life balance' },
                    { name: 'top_cons', label: 'Top Cons (comma-sep)', type: 'text', placeholder: 'Long hours, Bureaucracy, Slow promotions' },
                ],
            },
            '/api/v1/glassdoor/import-csv': {
                fields: [],
                _note: 'File upload ‚Äî use Swagger UI or curl for CSV import',
            },
            // ‚îÄ‚îÄ LP Commitments ‚îÄ‚îÄ
            '/api/v1/lp-collection/jobs': {
                fields: [
                    { name: 'lp_types', label: 'LP Types', type: 'checkbox-group', options: [
                        { value: 'public_pension', label: 'Public Pension' },
                        { value: 'sovereign_wealth', label: 'Sovereign Wealth' },
                        { value: 'endowment', label: 'Endowment' },
                        { value: 'corporate_pension', label: 'Corporate Pension' },
                        { value: 'insurance', label: 'Insurance' },
                    ]},
                    { name: 'regions', label: 'Regions', type: 'checkbox-group', options: [
                        { value: 'us', label: 'US' }, { value: 'europe', label: 'Europe' },
                        { value: 'asia', label: 'Asia' }, { value: 'middle_east', label: 'Middle East' },
                        { value: 'oceania', label: 'Oceania' },
                    ]},
                    { name: 'sources', label: 'Sources (comma-sep)', type: 'text', placeholder: 'website,sec_adv,cafr,news (default: website)' },
                    { name: 'mode', label: 'Mode', type: 'select', options: [
                        { value: 'incremental', label: 'Incremental (skip recently collected)' },
                        { value: 'full', label: 'Full (re-collect all)' },
                    ]},
                    { name: 'max_age_days', label: 'Max Age (days)', type: 'number', placeholder: '90' },
                    { name: 'max_concurrent_lps', label: 'Max Concurrent LPs', type: 'number', placeholder: '5' },
                ],
            },
            '/api/v1/lp-collection/collect/{lp_id}': {
                pathParams: [{ name: 'lp_id', label: 'LP ID', type: 'number', required: true, placeholder: 'e.g. 1' }],
                fields: [
                    { name: 'sources', label: 'Sources (comma-sep)', type: 'text', placeholder: 'website,sec_adv,cafr,news (default: website)' },
                ],
            },
            '/api/v1/lp-collection/collect/stale': {
                queryParams: [
                    { name: 'max_age_days', label: 'Max Age (days)', type: 'number', placeholder: '90' },
                    { name: 'limit', label: 'Max LPs to Queue', type: 'number', placeholder: '50' },
                ],
            },
            '/api/v1/lp-collection/schedules': {
                fields: [
                    { name: 'lp_id', label: 'LP ID', type: 'number', required: true, placeholder: 'e.g. 1' },
                    { name: 'source_type', label: 'Source Type', type: 'select', required: true, options: [
                        { value: 'website', label: 'Website' }, { value: 'sec_adv', label: 'SEC ADV' },
                        { value: 'cafr', label: 'CAFR' }, { value: 'news', label: 'News' },
                    ]},
                    { name: 'frequency', label: 'Frequency', type: 'select', options: [
                        { value: 'daily', label: 'Daily' }, { value: 'weekly', label: 'Weekly' },
                        { value: 'monthly', label: 'Monthly' }, { value: 'quarterly', label: 'Quarterly' },
                    ]},
                    { name: 'day_of_week', label: 'Day of Week (0=Mon, for weekly)', type: 'number', placeholder: '0' },
                    { name: 'day_of_month', label: 'Day of Month (for monthly)', type: 'number', placeholder: '1' },
                    { name: 'hour', label: 'Hour (UTC, 0-23)', type: 'number', placeholder: '2' },
                ],
            },
            '/api/v1/lp-collection/collect/{lp_id}/governance': {
                pathParams: [{ name: 'lp_id', label: 'LP ID', type: 'number', required: true, placeholder: 'e.g. 1' }],
                fields: [],
            },
            '/api/v1/lp-collection/collect/{lp_id}/performance': {
                pathParams: [{ name: 'lp_id', label: 'LP ID', type: 'number', required: true, placeholder: 'e.g. 1' }],
                fields: [],
            },
            // ‚îÄ‚îÄ DUNL (S&P Data Unlocked) ‚îÄ‚îÄ
            '/api/v1/dunl/ingest-all': {
                fields: [],
                _note: 'Ingests all DUNL datasets: currencies (208), ports (301), UOM (210), and calendars (2024-2026). No parameters needed.',
            },
            '/api/v1/dunl/currencies/ingest': {
                fields: [],
                _note: 'Ingests all 208 ISO currency definitions from DUNL. No parameters needed.',
            },
            '/api/v1/dunl/ports/ingest': {
                fields: [],
                _note: 'Ingests all 301 commodity port definitions from DUNL. No parameters needed.',
            },
            '/api/v1/dunl/uom/ingest': {
                fields: [],
                _note: 'Ingests all 210 units of measure + conversion factors from DUNL. No parameters needed.',
            },
            '/api/v1/dunl/calendars/ingest': {
                fields: [
                    { name: 'years', label: 'Years', type: 'text', placeholder: '2024,2025,2026 (comma-separated)',
                      default: '2024,2025,2026' },
                ],
            },
        };

        // ===== Date Field Detection (auto-classify temporal type) =====
        const DATE_FIELD_PATTERNS = {
            startDate: ['observation_start', 'start_date', 'start', 'date_from'],
            endDate:   ['observation_end',   'end_date',   'end',   'date_to'],
            startYear: ['start_year', 'start_period'],
            endYear:   ['end_year', 'end_period'],
            year:      ['year'],
        };

        function classifyFormFields(formDef) {
            if (!formDef) return { temporalType: 'snapshot' };
            const allFields = [...(formDef.pathParams || []), ...(formDef.fields || [])];
            const names = allFields.map(f => f.name);

            let startField = null, endField = null;

            // Check date-range
            for (const pat of DATE_FIELD_PATTERNS.startDate) {
                const f = allFields.find(x => x.name === pat);
                if (f) { startField = f; break; }
            }
            for (const pat of DATE_FIELD_PATTERNS.endDate) {
                const f = allFields.find(x => x.name === pat);
                if (f) { endField = f; break; }
            }
            if (startField && endField) {
                return { temporalType: 'date-range', startField, endField };
            }

            // Check year-range
            let startYearField = null, endYearField = null;
            for (const pat of DATE_FIELD_PATTERNS.startYear) {
                const f = allFields.find(x => x.name === pat);
                if (f) { startYearField = f; break; }
            }
            for (const pat of DATE_FIELD_PATTERNS.endYear) {
                const f = allFields.find(x => x.name === pat);
                if (f) { endYearField = f; break; }
            }
            if (startYearField && endYearField) {
                return { temporalType: 'year-range', startField: startYearField, endField: endYearField };
            }

            // Check single year
            for (const pat of DATE_FIELD_PATTERNS.year) {
                const f = allFields.find(x => x.name === pat);
                if (f) return { temporalType: 'single-year', startField: f };
            }

            return { temporalType: 'snapshot' };
        }

        function getSmartStartDefault(fieldName) {
            // Date fields ‚Üí 30 days ago; year fields ‚Üí last year
            const isYear = DATE_FIELD_PATTERNS.startYear.includes(fieldName) ||
                           DATE_FIELD_PATTERNS.endYear.includes(fieldName) ||
                           DATE_FIELD_PATTERNS.year.includes(fieldName);
            if (isYear) return String(new Date().getFullYear() - 1);
            const d = new Date();
            d.setDate(d.getDate() - 30);
            return d.toISOString().split('T')[0];
        }

        // ===================================================================
        //  DATA SOURCES DASHBOARD
        // ===================================================================

        // Source registry: maps to actual DB tables and ingestion sources
        // key = must match backend source_health / ingestion_jobs key for status to work
        // healthKey = override key for health lookup (when key differs from health system)
        // siCollector = site intel collector key (for site intel status lookup)
        // endpoints = [{method, path, label}] available API endpoints
        // triggers = [{method, path, label, body?}] endpoints that start collection
        // scheduleOptions = available schedule frequencies
        const SOURCE_REGISTRY = {
            macro_econ: {
                label: 'Macro Economic',
                sources: [
                    { key: 'fred', label: 'FRED (Federal Reserve)', tablePrefix: 'fred_',
                      recommendedCadence: 'daily',
                      collectionFlow: {
                        triggers: [
                          { method:'POST', path:'/api/v1/fred/ingest', label:'Ingest category' },
                          { method:'POST', path:'/api/v1/fred/ingest/batch', label:'Batch ingest' },
                        ],
                        defaultTriggerIndex: 1,
                      },
                      triggers: [{method:'POST', path:'/api/v1/fred/ingest', label:'Ingest category'}, {method:'POST', path:'/api/v1/fred/ingest/batch', label:'Batch ingest'}],
                      endpoints: [{method:'GET', path:'/api/v1/fred/categories', label:'List categories'}, {method:'GET', path:'/api/v1/fred/series/{category}', label:'Series by category'}],
                      scheduleOptions: ['daily','weekly','monthly'] },
                    { key: 'bea', label: 'BEA (Bureau of Economic Analysis)', tablePrefix: 'bea_',
                      triggers: [{method:'POST', path:'/api/v1/bea/nipa/ingest', label:'Ingest NIPA/GDP'}, {method:'POST', path:'/api/v1/bea/regional/ingest', label:'Ingest Regional'}, {method:'POST', path:'/api/v1/bea/gdp-industry/ingest', label:'Ingest GDP by Industry'}, {method:'POST', path:'/api/v1/bea/international/ingest', label:'Ingest Intl Trade'}],
                      endpoints: [{method:'GET', path:'/api/v1/bea/datasets', label:'List datasets'}],
                      scheduleOptions: ['weekly','monthly','quarterly'] },
                    { key: 'bls', label: 'BLS (Bureau of Labor Statistics)', tablePrefix: 'bls_',
                      triggers: [{method:'POST', path:'/api/v1/bls/{dataset}/ingest', label:'Ingest dataset'}, {method:'POST', path:'/api/v1/bls/all/ingest', label:'Ingest all datasets'}],
                      endpoints: [{method:'GET', path:'/api/v1/bls/reference/datasets', label:'List datasets'}, {method:'GET', path:'/api/v1/bls/reference/series', label:'Search series'}, {method:'GET', path:'/api/v1/bls/reference/quick', label:'Quick lookup'}],
                      scheduleOptions: ['daily','weekly','monthly'] },
                    { key: 'treasury', label: 'US Treasury', tablePrefix: 'treasury_',
                      triggers: [{method:'POST', path:'/api/v1/treasury/interest-rates/ingest', label:'Ingest interest rates'}, {method:'POST', path:'/api/v1/treasury/debt/ingest', label:'Ingest debt data'}, {method:'POST', path:'/api/v1/treasury/revenue-spending/ingest', label:'Ingest revenue & spending'}, {method:'POST', path:'/api/v1/treasury/auctions/ingest', label:'Ingest auctions'}, {method:'POST', path:'/api/v1/treasury/all/ingest', label:'Ingest all'}],
                      endpoints: [{method:'GET', path:'/api/v1/treasury/reference/datasets', label:'List datasets'}, {method:'GET', path:'/api/v1/treasury/reference/security-types', label:'Security types'}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'data_commons', label: 'Google Data Commons', tables: ['data_commons_observations'],
                      triggers: [{method:'POST', path:'/api/v1/data-commons/stat-var/ingest', label:'Ingest stat variables'}, {method:'POST', path:'/api/v1/data-commons/place-stats/ingest', label:'Ingest place stats'}, {method:'POST', path:'/api/v1/data-commons/us-states/ingest', label:'Ingest US states'}],
                      endpoints: [{method:'GET', path:'/api/v1/data-commons/variables', label:'List variables'}, {method:'GET', path:'/api/v1/data-commons/places', label:'List places'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'prediction_markets', label: 'Prediction Markets', tables: ['prediction_markets'],
                      triggers: [{method:'POST', path:'/api/v1/prediction-markets/monitor/all', label:'Monitor all platforms'}, {method:'POST', path:'/api/v1/prediction-markets/monitor/kalshi', label:'Monitor Kalshi'}, {method:'POST', path:'/api/v1/prediction-markets/monitor/polymarket', label:'Monitor Polymarket'}],
                      endpoints: [{method:'GET', path:'/api/v1/prediction-markets/markets/top', label:'Top markets'}, {method:'GET', path:'/api/v1/prediction-markets/markets/category/{category}', label:'Markets by category'}, {method:'GET', path:'/api/v1/prediction-markets/markets/{market_id}', label:'Market details'}, {method:'GET', path:'/api/v1/prediction-markets/markets/{market_id}/history', label:'Price history'}, {method:'GET', path:'/api/v1/prediction-markets/alerts', label:'Alerts'}, {method:'GET', path:'/api/v1/prediction-markets/dashboard', label:'Dashboard'}, {method:'GET', path:'/api/v1/prediction-markets/movers', label:'Top movers'}, {method:'GET', path:'/api/v1/prediction-markets/jobs', label:'Jobs'}, {method:'GET', path:'/api/v1/prediction-markets/jobs/{job_id}', label:'Job status'}, {method:'GET', path:'/api/v1/prediction-markets/categories', label:'Categories'}, {method:'GET', path:'/api/v1/prediction-markets/platforms', label:'Platforms'}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'international_econ_worldbank', label: 'World Bank', tablePrefix: 'intl_worldbank_',
                      triggers: [{method:'POST', path:'/api/v1/international/worldbank/wdi/ingest', label:'Ingest WDI'}, {method:'POST', path:'/api/v1/international/worldbank/countries/ingest', label:'Ingest countries'}, {method:'POST', path:'/api/v1/international/worldbank/indicators/ingest', label:'Ingest indicators'}],
                      endpoints: [{method:'GET', path:'/api/v1/international/worldbank/indicators/common', label:'Common indicators'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'international_econ_imf', label: 'IMF Data', tablePrefix: 'intl_imf_',
                      triggers: [{method:'POST', path:'/api/v1/international/imf/ifs/ingest', label:'Ingest IFS data'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'international_econ_oecd', label: 'OECD Data', tablePrefix: 'intl_oecd_',
                      triggers: [{method:'POST', path:'/api/v1/international/oecd/mei/ingest', label:'Ingest MEI'}, {method:'POST', path:'/api/v1/international/oecd/kei/ingest', label:'Ingest KEI'}, {method:'POST', path:'/api/v1/international/oecd/labor/ingest', label:'Ingest labor'}, {method:'POST', path:'/api/v1/international/oecd/trade/ingest', label:'Ingest trade'}, {method:'POST', path:'/api/v1/international/oecd/tax/ingest', label:'Ingest tax'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'international_econ_bis', label: 'BIS Data', tablePrefix: 'intl_bis_',
                      triggers: [{method:'POST', path:'/api/v1/international/bis/eer/ingest', label:'Ingest exchange rates'}, {method:'POST', path:'/api/v1/international/bis/property/ingest', label:'Ingest property prices'}],
                      scheduleOptions: ['monthly','quarterly'] },
                ],
            },
            trade_commerce: {
                label: 'Trade & Commerce',
                sources: [
                    { key: 'us_trade', label: 'US Trade (Census)', tablePrefix: 'us_trade_',
                      triggers: [{method:'POST', path:'/api/v1/us-trade/exports/hs/ingest', label:'Ingest HS exports'}, {method:'POST', path:'/api/v1/us-trade/imports/hs/ingest', label:'Ingest HS imports'}, {method:'POST', path:'/api/v1/us-trade/exports/state/ingest', label:'Ingest state exports'}, {method:'POST', path:'/api/v1/us-trade/port/ingest', label:'Ingest port data'}, {method:'POST', path:'/api/v1/us-trade/summary/ingest', label:'Ingest summary'}],
                      endpoints: [{method:'GET', path:'/api/v1/us-trade/datasets', label:'List datasets'}, {method:'GET', path:'/api/v1/us-trade/reference/hs-chapters', label:'HS chapters'}, {method:'GET', path:'/api/v1/us-trade/reference/countries', label:'Countries'}, {method:'GET', path:'/api/v1/us-trade/reference/districts', label:'Districts'}, {method:'GET', path:'/api/v1/us-trade/reference/states', label:'States'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'census', label: 'Census Bureau', tablePrefix: 'census_',
                      triggers: [{method:'POST', path:'/api/v1/census/state', label:'Ingest state-level'}, {method:'POST', path:'/api/v1/census/county', label:'Ingest county-level'}, {method:'POST', path:'/api/v1/census/zip', label:'Ingest ZIP-level'}, {method:'POST', path:'/api/v1/census/batch/state', label:'Batch ingest states'}, {method:'POST', path:'/api/v1/census/batch/county', label:'Batch ingest counties'}],
                      scheduleOptions: ['monthly','quarterly','yearly'] },
                    { key: 'cftc_cot', label: 'CFTC Commitments of Traders', tablePrefix: 'cftc_cot_',
                      triggers: [{method:'POST', path:'/api/v1/cftc-cot/ingest', label:'Ingest COT data'}],
                      endpoints: [{method:'GET', path:'/api/v1/cftc-cot/reference/contracts', label:'Contracts'}, {method:'GET', path:'/api/v1/cftc-cot/reference/commodity-groups', label:'Commodity groups'}, {method:'GET', path:'/api/v1/cftc-cot/reference/report-types', label:'Report types'}],
                      scheduleOptions: ['weekly'] },
                    { key: 'irs_soi', label: 'IRS Statistics of Income', tablePrefix: 'irs_soi_',
                      triggers: [{method:'POST', path:'/api/v1/irs-soi/zip-income/ingest', label:'Ingest ZIP income'}, {method:'POST', path:'/api/v1/irs-soi/county-income/ingest', label:'Ingest county income'}, {method:'POST', path:'/api/v1/irs-soi/migration/ingest', label:'Ingest migration'}, {method:'POST', path:'/api/v1/irs-soi/business-income/ingest', label:'Ingest business income'}, {method:'POST', path:'/api/v1/irs-soi/all/ingest', label:'Ingest all'}],
                      endpoints: [{method:'GET', path:'/api/v1/irs-soi/reference/agi-brackets', label:'AGI brackets'}, {method:'GET', path:'/api/v1/irs-soi/reference/years', label:'Available years'}, {method:'GET', path:'/api/v1/irs-soi/datasets', label:'List datasets'}],
                      scheduleOptions: ['yearly'] },
                    { key: 'census_acs5', label: 'Census ACS 5-Year', tablePrefix: 'acs5_',
                      triggers: [{method:'POST', path:'/api/v1/census/batch/state', label:'Batch ingest states'}, {method:'POST', path:'/api/v1/census/batch/county', label:'Batch ingest counties'}],
                      scheduleOptions: ['yearly'] },
                    { key: 'bts_transport', label: 'BTS Transport Stats', tables: ['bts_border_crossing', 'air_cargo_stats'],
                      triggers: [{method:'POST', path:'/api/v1/bts/border-crossing/ingest', label:'Ingest border crossings'}, {method:'POST', path:'/api/v1/bts/vmt/ingest', label:'Ingest VMT'}, {method:'POST', path:'/api/v1/bts/faf/ingest', label:'Ingest freight analysis'}],
                      endpoints: [{method:'GET', path:'/api/v1/bts/datasets', label:'List datasets'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'trade_gateway', label: 'Trade Gateway', tables: ['trade_gateway_stats', 'container_freight_index'],
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/logistics/trade-gateways', label:'Trade gateways'}, {method:'GET', path:'/api/v1/site-intel/logistics/trade-gateways/trends', label:'Gateway trends'}],
                      scheduleOptions: ['monthly'] },
                    { key: 'dunl', label: 'DUNL (S&P Data Unlocked)', tablePrefix: 'dunl_',
                      triggers: [{method:'POST', path:'/api/v1/dunl/ingest-all', label:'Ingest all'}, {method:'POST', path:'/api/v1/dunl/currencies/ingest', label:'Ingest currencies'}, {method:'POST', path:'/api/v1/dunl/ports/ingest', label:'Ingest ports'}, {method:'POST', path:'/api/v1/dunl/uom/ingest', label:'Ingest UOM'}, {method:'POST', path:'/api/v1/dunl/calendars/ingest', label:'Ingest calendars'}],
                      endpoints: [{method:'GET', path:'/api/v1/dunl/currencies', label:'List currencies'}, {method:'GET', path:'/api/v1/dunl/ports', label:'List ports'}, {method:'GET', path:'/api/v1/dunl/uom', label:'List UOM'}, {method:'GET', path:'/api/v1/dunl/uom/conversions', label:'UOM conversions'}, {method:'GET', path:'/api/v1/dunl/calendars', label:'Calendars'}, {method:'GET', path:'/api/v1/dunl/stats', label:'Stats'}, {method:'GET', path:'/api/v1/dunl/changes', label:'RSS changes'}],
                      scheduleOptions: ['weekly','monthly'] },
                ],
            },
            financial_reg: {
                label: 'Financial & Regulatory',
                sources: [
                    { key: 'sec', label: 'SEC (EDGAR Filings)', tablePrefix: 'sec_',
                      triggers: [{method:'POST', path:'/api/v1/sec/ingest/company', label:'Ingest company'}, {method:'POST', path:'/api/v1/sec/ingest/multiple', label:'Batch ingest'}, {method:'POST', path:'/api/v1/sec/ingest/industrial-companies', label:'Ingest industrial cos'}],
                      endpoints: [{method:'GET', path:'/api/v1/sec/supported-filing-types', label:'Filing types'}, {method:'GET', path:'/api/v1/sec/common-companies', label:'Common companies'}, {method:'POST', path:'/api/v1/sec/form-adv/ingest/family-offices', label:'Ingest Form ADV FOs'}, {method:'GET', path:'/api/v1/sec/form-adv/firms', label:'Query Form ADV firms'}, {method:'GET', path:'/api/v1/sec/form-adv/stats', label:'Form ADV stats'}],
                      scheduleOptions: ['daily','weekly','monthly'] },
                    { key: 'fdic', label: 'FDIC (Banking)', tablePrefix: 'fdic_',
                      triggers: [{method:'POST', path:'/api/v1/fdic/financials/ingest', label:'Ingest financials'}, {method:'POST', path:'/api/v1/fdic/institutions/ingest', label:'Ingest institutions'}, {method:'POST', path:'/api/v1/fdic/failed-banks/ingest', label:'Ingest failed banks'}, {method:'POST', path:'/api/v1/fdic/deposits/ingest', label:'Ingest deposits (large)'}, {method:'POST', path:'/api/v1/fdic/all/ingest', label:'Ingest all'}],
                      endpoints: [{method:'GET', path:'/api/v1/fdic/search', label:'Search banks'}, {method:'GET', path:'/api/v1/fdic/reference/datasets', label:'List datasets'}, {method:'GET', path:'/api/v1/fdic/reference/major-banks', label:'Major banks'}],
                      scheduleOptions: ['weekly','monthly','quarterly'] },
                    { key: 'form_d', label: 'SEC Form D', tables: ['form_d_filings', 'form_d_related_persons'],
                      triggers: [{method:'POST', path:'/api/v1/form-d/ingest', label:'Ingest filings'}],
                      endpoints: [{method:'GET', path:'/api/v1/form-d/search', label:'Search filings'}, {method:'GET', path:'/api/v1/form-d/issuer/{cik}', label:'Filings by CIK'}, {method:'GET', path:'/api/v1/form-d/recent', label:'Recent filings'}, {method:'GET', path:'/api/v1/form-d/filing/{accession_number}', label:'Filing details'}, {method:'GET', path:'/api/v1/form-d/stats', label:'Statistics'}, {method:'GET', path:'/api/v1/form-d/industries', label:'Industries'}, {method:'GET', path:'/api/v1/form-d/exemptions', label:'Exemptions'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'form_adv', label: 'SEC Form ADV', tables: ['form_adv_advisers', 'sec_form_adv', 'sec_form_adv_personnel'], healthKey: 'sec',
                      endpoints: [{method:'GET', path:'/api/v1/sec/form-adv/firms', label:'Query firms'}, {method:'GET', path:'/api/v1/sec/form-adv/firms/{crd}', label:'Firm by CRD'}, {method:'GET', path:'/api/v1/sec/form-adv/stats', label:'Statistics'}],
                      triggers: [{method:'POST', path:'/api/v1/sec/form-adv/ingest/family-offices', label:'Ingest family offices'}, {method:'POST', path:'/api/v1/sec/form-adv/ingest/crd', label:'Ingest by CRD'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'corporate_registry', label: 'Corporate Registry', tables: ['corporate_registry_entities'],
                      endpoints: [{method:'GET', path:'/api/v1/corporate-registry/search', label:'Search companies'}, {method:'GET', path:'/api/v1/corporate-registry/company/{jurisdiction}/{company_number}', label:'Company details'}, {method:'GET', path:'/api/v1/corporate-registry/company/{jurisdiction}/{company_number}/officers', label:'Officers'}, {method:'GET', path:'/api/v1/corporate-registry/company/{jurisdiction}/{company_number}/filings', label:'Filings'}, {method:'GET', path:'/api/v1/corporate-registry/officers/search', label:'Search officers'}, {method:'GET', path:'/api/v1/corporate-registry/jurisdictions', label:'Jurisdictions'}],
                      scheduleOptions: ['monthly','quarterly'] },
                ],
            },
            energy_ag: {
                label: 'Energy & Agriculture',
                sources: [
                    { key: 'eia', label: 'EIA (Energy)', tables: ['electricity_price', 'natural_gas_pipeline', 'natural_gas_storage'],
                      triggers: [{method:'POST', path:'/api/v1/eia/petroleum/ingest', label:'Ingest petroleum'}, {method:'POST', path:'/api/v1/eia/electricity/ingest', label:'Ingest electricity'}, {method:'POST', path:'/api/v1/eia/natural-gas/ingest', label:'Ingest natural gas'}, {method:'POST', path:'/api/v1/eia/retail-gas-prices/ingest', label:'Ingest retail gas prices'}, {method:'POST', path:'/api/v1/eia/steo/ingest', label:'Ingest STEO'}],
                      scheduleOptions: ['daily','weekly','monthly'] },
                    { key: 'usda', label: 'USDA', tablePrefix: 'usda_',
                      triggers: [{method:'POST', path:'/api/v1/usda/crop/ingest', label:'Ingest crops'}, {method:'POST', path:'/api/v1/usda/livestock/ingest', label:'Ingest livestock'}, {method:'POST', path:'/api/v1/usda/annual-summary/ingest', label:'Ingest annual summary'}, {method:'POST', path:'/api/v1/usda/all-major-crops/ingest', label:'Ingest all major crops'}],
                      endpoints: [{method:'GET', path:'/api/v1/usda/reference/commodities', label:'Commodities'}, {method:'GET', path:'/api/v1/usda/reference/crop-states', label:'Crop states'}, {method:'GET', path:'/api/v1/usda/reference/state-fips', label:'State FIPS'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'noaa', label: 'NOAA (Climate)', tablePrefix: 'noaa_',
                      triggers: [{method:'POST', path:'/api/v1/noaa/ingest', label:'Ingest climate data'}],
                      endpoints: [{method:'GET', path:'/api/v1/noaa/datasets', label:'List datasets'}, {method:'GET', path:'/api/v1/noaa/datasets/{dataset_key}', label:'Dataset details'}, {method:'GET', path:'/api/v1/noaa/locations', label:'Locations'}, {method:'GET', path:'/api/v1/noaa/stations', label:'Stations'}, {method:'GET', path:'/api/v1/noaa/data-types', label:'Data types'}],
                      scheduleOptions: ['daily','weekly'] },
                ],
            },
            realestate: {
                label: 'Real Estate',
                sources: [
                    { key: 'realestate', label: 'Real Estate Data', tablePrefix: 'realestate_',
                      triggers: [{method:'POST', path:'/api/v1/realestate/fhfa/ingest', label:'Ingest FHFA'}, {method:'POST', path:'/api/v1/realestate/hud/ingest', label:'Ingest HUD'}, {method:'POST', path:'/api/v1/realestate/redfin/ingest', label:'Ingest Redfin'}, {method:'POST', path:'/api/v1/realestate/osm/ingest', label:'Ingest OSM'}],
                      endpoints: [{method:'GET', path:'/api/v1/realestate/info', label:'Dataset info'}],
                      scheduleOptions: ['monthly','quarterly'] },
                ],
            },
            healthcare: {
                label: 'Healthcare',
                sources: [
                    { key: 'cms', label: 'CMS (Healthcare/Medicare)', tablePrefix: 'cms_',
                      triggers: [{method:'POST', path:'/api/v1/cms/ingest/medicare-utilization', label:'Ingest Medicare'}, {method:'POST', path:'/api/v1/cms/ingest/hospital-cost-reports', label:'Ingest hospital costs'}, {method:'POST', path:'/api/v1/cms/ingest/drug-pricing', label:'Ingest drug pricing'}],
                      endpoints: [{method:'GET', path:'/api/v1/cms/datasets', label:'List datasets'}],
                      scheduleOptions: ['monthly','quarterly'] },
                ],
            },
            site_intel: {
                label: 'Site Intelligence',
                sources: [
                    // Power
                    { key: 'si_eia', label: 'EIA Power Plants', domain: 'power', siCollector: 'eia',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/power/plants', label:'List plants'}, {method:'GET', path:'/api/v1/site-intel/power/plants/nearby', label:'Nearby plants'}, {method:'GET', path:'/api/v1/site-intel/power/prices', label:'Electricity prices'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['eia']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_hifld', label: 'HIFLD Infrastructure', domain: 'power', siCollector: 'hifld',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['hifld']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_nrel', label: 'NREL Solar/Wind', domain: 'power', siCollector: 'nrel',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['nrel']}}],
                      scheduleOptions: ['quarterly'] },
                    { key: 'si_iso_pjm', label: 'ISO PJM', domain: 'power', siCollector: 'iso_pjm',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['iso_pjm']}}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'si_iso_caiso', label: 'ISO CAISO', domain: 'power', siCollector: 'iso_caiso',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['iso_caiso']}}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'si_iso_ercot', label: 'ISO ERCOT', domain: 'power', siCollector: 'iso_ercot',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['iso_ercot']}}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'si_iso_miso', label: 'ISO MISO', domain: 'power', siCollector: 'iso_miso',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['iso_miso']}}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'si_iso_spp', label: 'ISO SPP', domain: 'power', siCollector: 'iso_spp',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['iso_spp']}}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'si_iso_nyiso', label: 'ISO NYISO', domain: 'power', siCollector: 'iso_nyiso',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['iso_nyiso']}}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'si_iso_isone', label: 'ISO ISO-NE', domain: 'power', siCollector: 'iso_isone',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['power'],sources:['iso_isone']}}],
                      scheduleOptions: ['daily','weekly'] },
                    // Telecom
                    { key: 'si_fcc', label: 'FCC Broadband', domain: 'telecom', siCollector: 'fcc',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/telecom/broadband', label:'Broadband coverage'}, {method:'GET', path:'/api/v1/site-intel/telecom/broadband/at-location', label:'Coverage at location'}, {method:'GET', path:'/api/v1/site-intel/telecom/connectivity-score', label:'Connectivity score'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['telecom'],sources:['fcc']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_peeringdb', label: 'PeeringDB', domain: 'telecom', siCollector: 'peeringdb',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/telecom/ix', label:'Internet exchanges'}, {method:'GET', path:'/api/v1/site-intel/telecom/ix/nearby', label:'Nearby IXs'}, {method:'GET', path:'/api/v1/site-intel/telecom/data-centers', label:'Data centers'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['telecom'],sources:['peeringdb']}}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'si_telegeography', label: 'TeleGeography', domain: 'telecom', siCollector: 'telegeography',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['telecom'],sources:['telegeography']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_ripe_atlas', label: 'RIPE Atlas', domain: 'telecom', siCollector: 'ripe_atlas', scheduleOptions: ['monthly'] },
                    // Transport
                    { key: 'si_bts', label: 'BTS Transport', domain: 'transport', siCollector: 'bts',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/transport/intermodal', label:'Intermodal terminals'}, {method:'GET', path:'/api/v1/site-intel/transport/intermodal/nearby', label:'Nearby terminals'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['transport'],sources:['bts']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_bts_ntad', label: 'BTS NTAD', domain: 'transport', siCollector: 'bts_ntad',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['transport'],sources:['bts_ntad']}}],
                      scheduleOptions: ['quarterly'] },
                    { key: 'si_fra', label: 'FRA Rail', domain: 'transport', siCollector: 'fra',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/transport/rail/access', label:'Rail access'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['transport'],sources:['fra']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_usace', label: 'USACE Waterways', domain: 'transport', siCollector: 'usace',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/transport/ports', label:'Port terminals'}, {method:'GET', path:'/api/v1/site-intel/transport/ports/nearby', label:'Nearby ports'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['transport'],sources:['usace']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_faa', label: 'FAA Airports', domain: 'transport', siCollector: 'faa',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/transport/airports', label:'Airports'}, {method:'GET', path:'/api/v1/site-intel/transport/airports/nearby', label:'Nearby airports'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['transport'],sources:['faa']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_fhwa', label: 'FHWA Highways', domain: 'transport', siCollector: 'fhwa', scheduleOptions: ['quarterly'] },
                    // Labor
                    { key: 'si_bls', label: 'BLS Employment', domain: 'labor', siCollector: 'bls',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/labor/wages', label:'Wage data'}, {method:'GET', path:'/api/v1/site-intel/labor/employment', label:'Employment'}, {method:'GET', path:'/api/v1/site-intel/labor/workforce-score', label:'Workforce score'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['labor'],sources:['bls']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_bls_oes', label: 'BLS OES', domain: 'labor', siCollector: 'bls_oes',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['labor'],sources:['bls_oes']}}],
                      scheduleOptions: ['quarterly','yearly'] },
                    { key: 'si_bls_qcew', label: 'BLS QCEW', domain: 'labor', siCollector: 'bls_qcew',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['labor'],sources:['bls_qcew']}}],
                      scheduleOptions: ['quarterly'] },
                    { key: 'si_census_lehd', label: 'Census LEHD', domain: 'labor', siCollector: 'census_lehd',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['labor'],sources:['census_lehd']}}],
                      scheduleOptions: ['quarterly','yearly'] },
                    { key: 'si_census_acs', label: 'Census ACS', domain: 'labor', siCollector: 'census_acs',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['labor'],sources:['census_acs']}}],
                      scheduleOptions: ['yearly'] },
                    // Risk
                    { key: 'si_fema', label: 'FEMA Disasters', domain: 'risk', siCollector: 'fema',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/risk/flood', label:'Flood risk'}, {method:'GET', path:'/api/v1/site-intel/risk/flood/at-location', label:'Flood at location'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['risk'],sources:['fema']}}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'si_fema_nfhl', label: 'FEMA Flood', domain: 'risk', siCollector: 'fema_nfhl',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['risk'],sources:['fema_nfhl']}}],
                      scheduleOptions: ['quarterly'] },
                    { key: 'si_fema_nri', label: 'FEMA NRI', domain: 'risk', siCollector: 'fema_nri',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/risk/nri', label:'NRI data'}, {method:'GET', path:'/api/v1/site-intel/risk/nri/county/{fips}', label:'County NRI'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['risk'],sources:['fema_nri']}}],
                      scheduleOptions: ['quarterly','yearly'] },
                    { key: 'si_usgs_eq', label: 'USGS Earthquake', domain: 'risk', siCollector: 'usgs_earthquake',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/risk/seismic/at-location', label:'Seismic risk'}, {method:'GET', path:'/api/v1/site-intel/risk/faults/nearby', label:'Nearby faults'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['risk'],sources:['usgs_earthquake']}}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'si_noaa_climate', label: 'NOAA Climate', domain: 'risk', siCollector: 'noaa_climate',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/risk/climate/at-location', label:'Climate risk'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['risk'],sources:['noaa_climate']}}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'si_epa_enviro', label: 'EPA Envirofacts', domain: 'risk', siCollector: 'epa_envirofacts',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['risk'],sources:['epa_envirofacts']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_usfws_nwi', label: 'USFWS NWI', domain: 'risk', siCollector: 'usfws_nwi',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['risk'],sources:['usfws_nwi']}}],
                      scheduleOptions: ['quarterly','yearly'] },
                    // Incentives
                    { key: 'si_cdfi_oz', label: 'CDFI Opportunity Zones', domain: 'incentives', siCollector: 'cdfi_oz',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/incentives/opportunity-zones', label:'List OZs'}, {method:'GET', path:'/api/v1/site-intel/incentives/opportunity-zones/at-location', label:'OZs at location'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['incentives'],sources:['cdfi_oz']}}],
                      scheduleOptions: ['quarterly','yearly'] },
                    { key: 'si_ftz', label: 'FTZ Board', domain: 'incentives', siCollector: 'ftz_board',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/incentives/ftz', label:'List FTZs'}, {method:'GET', path:'/api/v1/site-intel/incentives/ftz/nearby', label:'Nearby FTZs'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['incentives'],sources:['ftz_board']}}],
                      scheduleOptions: ['quarterly'] },
                    { key: 'si_good_jobs', label: 'Good Jobs First', domain: 'incentives', siCollector: 'good_jobs_first',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/incentives/deals', label:'Incentive deals'}, {method:'GET', path:'/api/v1/site-intel/incentives/deals/benchmark', label:'Benchmarking'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['incentives'],sources:['good_jobs_first']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_state_edo', label: 'State EDO', domain: 'incentives', siCollector: 'state_edo',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/incentives/programs', label:'Programs'}, {method:'GET', path:'/api/v1/site-intel/incentives/programs/by-state/{state}', label:'By state'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['incentives'],sources:['state_edo']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    // Logistics
                    { key: 'si_freightos', label: 'Freightos', domain: 'logistics', siCollector: 'freightos',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/logistics/container-rates', label:'Container rates'}, {method:'GET', path:'/api/v1/site-intel/logistics/container-rates/routes', label:'Route rates'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['freightos']}}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'si_usda_ams', label: 'USDA AMS', domain: 'logistics', siCollector: 'usda_ams',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/logistics/truck-rates/agricultural', label:'Ag truck rates'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['usda_ams']}}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'si_fmcsa', label: 'FMCSA', domain: 'logistics', siCollector: 'fmcsa',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/logistics/carriers', label:'Carriers'}, {method:'GET', path:'/api/v1/site-intel/logistics/carriers/{dot}/safety', label:'Safety records'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['fmcsa']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_drewry', label: 'Drewry', domain: 'logistics', siCollector: 'drewry',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['drewry']}}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'si_scfi', label: 'SCFI', domain: 'logistics', siCollector: 'scfi',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['scfi']}}],
                      scheduleOptions: ['weekly'] },
                    { key: 'si_ccfi', label: 'CCFI', domain: 'logistics', siCollector: 'ccfi',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['ccfi']}}],
                      scheduleOptions: ['weekly'] },
                    { key: 'si_census_trade', label: 'Census Trade', domain: 'logistics', siCollector: 'census_trade',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['census_trade']}}],
                      scheduleOptions: ['monthly'] },
                    { key: 'si_bts_cargo', label: 'BTS Cargo', domain: 'logistics', siCollector: 'bts_cargo',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['bts_cargo']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_loopnet', label: 'LoopNet', domain: 'logistics', siCollector: 'loopnet',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['loopnet']}}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'si_transport_topics', label: 'Transport Topics', domain: 'logistics', siCollector: 'transport_topics',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['transport_topics']}}],
                      scheduleOptions: ['weekly'] },
                    { key: 'si_3pl_website', label: '3PL Website', domain: 'logistics', siCollector: 'three_pl_website',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['three_pl_website']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_3pl_sec', label: '3PL SEC', domain: 'logistics', siCollector: 'three_pl_sec',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['three_pl_sec']}}],
                      scheduleOptions: ['quarterly'] },
                    { key: 'si_3pl_fmcsa', label: '3PL FMCSA', domain: 'logistics', siCollector: 'three_pl_fmcsa',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['logistics'],sources:['three_pl_fmcsa']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    // Water & Utilities
                    { key: 'si_usgs_water', label: 'USGS Water', domain: 'water_utilities', siCollector: 'usgs_water',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/water-utilities/monitoring-sites', label:'Monitoring sites'}, {method:'GET', path:'/api/v1/site-intel/water-utilities/monitoring-sites/near', label:'Nearby sites'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['water_utilities'],sources:['usgs_water']}}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'si_epa_sdwis', label: 'EPA SDWIS', domain: 'water_utilities', siCollector: 'epa_sdwis',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/water-utilities/water-systems', label:'Water systems'}, {method:'GET', path:'/api/v1/site-intel/water-utilities/water-systems/{pwsid}/violations', label:'Violations'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['water_utilities'],sources:['epa_sdwis']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_eia_gas', label: 'EIA Gas', domain: 'water_utilities', siCollector: 'eia_gas',
                      endpoints: [{method:'GET', path:'/api/v1/site-intel/water-utilities/gas-pipelines', label:'Gas pipelines'}, {method:'GET', path:'/api/v1/site-intel/water-utilities/gas-storage', label:'Gas storage'}],
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['water_utilities'],sources:['eia_gas']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'si_openei_urdb', label: 'OpenEI URDB', domain: 'water_utilities', siCollector: 'openei_urdb',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['water_utilities'],sources:['openei_urdb']}}],
                      scheduleOptions: ['quarterly'] },
                    { key: 'si_eia_electricity', label: 'EIA Electricity', domain: 'water_utilities', siCollector: 'eia_electricity',
                      triggers: [{method:'POST', path:'/api/v1/site-intel/sites/collect', label:'Collect', body:{domains:['water_utilities'],sources:['eia_electricity']}}],
                      scheduleOptions: ['monthly','quarterly'] },
                ],
            },
            people: {
                label: 'People & Org Charts',
                sources: [
                    { key: 'people_website', label: 'Website Scraping', tables: ['people', 'company_people'],
                      triggers: [{method:'POST', path:'/api/v1/people-jobs/test/{company_id}?sources=website', label:'Test collect'}, {method:'POST', path:'/api/v1/people-jobs/schedule', label:'Schedule job'}],
                      endpoints: [{method:'GET', path:'/api/v1/people', label:'Search people'}, {method:'GET', path:'/api/v1/people/search/executives', label:'Search executives'}, {method:'GET', path:'/api/v1/people-jobs/', label:'List jobs'}, {method:'GET', path:'/api/v1/people-jobs/stats', label:'Job stats'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'people_sec', label: 'SEC 10-K Officers', tables: ['people', 'company_people'],
                      triggers: [{method:'POST', path:'/api/v1/people-jobs/deep-collect/{company_id}', label:'Deep collect (SEC phase)'}],
                      endpoints: [{method:'GET', path:'/api/v1/people', label:'Search people'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'people_news', label: 'News Deep Scan', tables: ['people', 'company_people'],
                      triggers: [{method:'POST', path:'/api/v1/people-jobs/deep-collect/{company_id}', label:'Deep collect (News phase)'}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'people_deep_crawl', label: 'Deep Crawl', tables: ['people', 'company_people'],
                      triggers: [{method:'POST', path:'/api/v1/people-jobs/deep-collect/{company_id}', label:'Deep collect (Crawl phase)'}, {method:'POST', path:'/api/v1/people-jobs/recursive-collect/{company_id}', label:'Recursive collect'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'org_chart', label: 'Org Chart Builder', tables: ['org_chart_snapshots'],
                      triggers: [{method:'POST', path:'/api/v1/people-jobs/deep-collect/{company_id}', label:'Deep collect (Org chart phase)'}],
                      endpoints: [{method:'GET', path:'/api/v1/companies/{company_id}/leadership', label:'Leadership team'}, {method:'GET', path:'/api/v1/companies/{company_id}/leadership/history', label:'Leadership history'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'industrial_companies', label: 'Industrial Companies', tables: ['industrial_companies'],
                      endpoints: [{method:'GET', path:'/api/v1/companies/', label:'List companies'}],
                      scheduleOptions: ['monthly'] },
                    { key: 'job_postings', label: 'Job Posting Intelligence', tablePrefix: 'job_posting',
                      triggers: [
                        {method:'POST', path:'/api/v1/job-postings/collect-all', label:'Collect all companies'},
                        {method:'POST', path:'/api/v1/job-postings/collect/{company_id}', label:'Collect company'},
                        {method:'POST', path:'/api/v1/job-postings/discover-ats/{company_id}', label:'Discover ATS'},
                      ],
                      endpoints: [
                        {method:'GET', path:'/api/v1/job-postings/', label:'List postings'},
                        {method:'GET', path:'/api/v1/job-postings/company/{company_id}', label:'Company postings'},
                        {method:'GET', path:'/api/v1/job-postings/company/{company_id}/trends', label:'Company trends'},
                        {method:'GET', path:'/api/v1/job-postings/ats-configs', label:'ATS configs'},
                        {method:'GET', path:'/api/v1/job-postings/snapshots', label:'Snapshots'},
                        {method:'GET', path:'/api/v1/job-postings/stats', label:'Stats'},
                      ],
                      scheduleOptions: ['daily','weekly'] },
                ],
            },
            pe: {
                label: 'PE Intelligence',
                sources: [
                    { key: 'pe_firms', label: 'PE/VC Firms', tables: ['pe_firms', 'pe_firm_people', 'pe_firm_news'],
                      triggers: [{method:'POST', path:'/api/v1/pe/collection/collect', label:'Collect PE data', body:{modules:['firms']}}],
                      endpoints: [{method:'GET', path:'/api/v1/pe/firms/', label:'List firms'}, {method:'GET', path:'/api/v1/pe/firms/search', label:'Search firms'}, {method:'GET', path:'/api/v1/pe/firms/{firm_id}/portfolio', label:'Portfolio'}, {method:'GET', path:'/api/v1/pe/firms/{firm_id}/team', label:'Team'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'pe_funds', label: 'Fund Performance', tables: ['pe_funds'],
                      triggers: [{method:'POST', path:'/api/v1/pe/collection/collect', label:'Collect PE data', body:{modules:['funds']}}],
                      endpoints: [{method:'GET', path:'/api/v1/pe/firms/{firm_id}/funds', label:'Firm funds'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'pe_deals', label: 'Deal Flow', tables: ['pe_deals', 'pe_deal_participants', 'pe_deal_advisors'],
                      triggers: [{method:'POST', path:'/api/v1/pe/collection/collect', label:'Collect PE data', body:{modules:['deals']}}],
                      endpoints: [{method:'GET', path:'/api/v1/pe/deals/', label:'List deals'}, {method:'GET', path:'/api/v1/pe/deals/search', label:'Search deals'}],
                      scheduleOptions: ['daily','weekly'] },
                    { key: 'pe_portfolio', label: 'Portfolio Companies', tables: ['pe_portfolio_companies', 'pe_company_financials'],
                      triggers: [{method:'POST', path:'/api/v1/pe/collection/collect', label:'Collect PE data', body:{modules:['portfolio']}}],
                      endpoints: [{method:'GET', path:'/api/v1/pe/companies/', label:'List companies'}, {method:'GET', path:'/api/v1/pe/companies/search', label:'Search'}, {method:'GET', path:'/api/v1/pe/companies/{company_id}/financials', label:'Financials'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'pe_people', label: 'Fund Professionals', tables: ['pe_people', 'pe_person_experience'],
                      triggers: [{method:'POST', path:'/api/v1/pe/collection/collect', label:'Collect PE data', body:{modules:['people']}}],
                      endpoints: [{method:'GET', path:'/api/v1/pe/people/', label:'List people'}, {method:'GET', path:'/api/v1/pe/people/search', label:'Search people'}, {method:'GET', path:'/api/v1/pe/people/{person_id}', label:'Person details'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'pe_13f', label: '13F Filings', tables: ['pe_fund_investments', 'pe_fund_performance'],
                      triggers: [{method:'POST', path:'/api/v1/pe/collection/collect', label:'Collect PE data', body:{modules:['13f']}}],
                      endpoints: [{method:'GET', path:'/api/v1/pe/collection/sources', label:'Collection sources'}],
                      scheduleOptions: ['quarterly'] },
                ],
            },
            fo: {
                label: 'Family Office & LP',
                sources: [
                    { key: 'family_offices', label: 'Family Offices', tablePrefix: 'family_office',
                      triggers: [{method:'POST', path:'/api/v1/sec/form-adv/ingest/family-offices', label:'Ingest from Form ADV'}],
                      endpoints: [{method:'GET', path:'/api/v1/family-offices/', label:'List offices'}, {method:'GET', path:'/api/v1/family-offices/{office_id}', label:'Office details'}, {method:'GET', path:'/api/v1/family-offices/stats/overview', label:'Overview stats'}],
                      scheduleOptions: ['weekly','monthly','quarterly'] },
                    { key: 'lp_commitments', label: 'LP Commitments', tablePrefix: 'lp_',
                      triggers: [{method:'POST', path:'/api/v1/lp-collection/jobs', label:'Create collection job'}, {method:'POST', path:'/api/v1/lp-collection/collect/{lp_id}', label:'Collect LP data'}, {method:'POST', path:'/api/v1/lp-collection/collect/stale', label:'Collect stale'}, {method:'POST', path:'/api/v1/lp-collection/schedules', label:'Create schedule'}, {method:'POST', path:'/api/v1/lp-collection/collect/{lp_id}/governance', label:'Collect governance'}, {method:'POST', path:'/api/v1/lp-collection/collect/{lp_id}/performance', label:'Collect performance'}],
                      endpoints: [{method:'GET', path:'/api/v1/lp-collection/jobs/{job_id}/status', label:'Job status'}, {method:'GET', path:'/api/v1/lp-collection/jobs', label:'List jobs'}, {method:'GET', path:'/api/v1/lp-collection/schedules', label:'List schedules'}, {method:'DELETE', path:'/api/v1/lp-collection/schedules/{schedule_id}', label:'Delete schedule'}, {method:'PATCH', path:'/api/v1/lp-collection/schedules/{schedule_id}/toggle', label:'Toggle schedule'}, {method:'GET', path:'/api/v1/lp-collection/status', label:'Collection status'}, {method:'GET', path:'/api/v1/lp-collection/coverage', label:'Coverage report'}, {method:'POST', path:'/api/v1/lp-collection/seed-lps', label:'Seed LPs'}, {method:'GET', path:'/api/v1/lp-collection/governance/{lp_id}', label:'Governance overview'}, {method:'GET', path:'/api/v1/lp-collection/performance/{lp_id}', label:'Performance history'}, {method:'GET', path:'/api/v1/lp-collection/lps/{lp_id}/allocation-history', label:'Allocation history'}, {method:'GET', path:'/api/v1/lp-collection/lps/{lp_id}/holdings', label:'Holdings'}, {method:'GET', path:'/api/v1/lp-collection/lps/{lp_id}/managers', label:'Managers'}, {method:'GET', path:'/api/v1/lp-collection/lps/{lp_id}/contacts', label:'Contacts'}, {method:'GET', path:'/api/v1/lp-collection/lps/{lp_id}/summary', label:'LP summary'}],
                      scheduleOptions: ['monthly','quarterly'] },
                ],
            },
            alt_data: {
                label: 'Alternative Data',
                sources: [
                    { key: 'fbi_crime', label: 'FBI Crime Stats', tablePrefix: 'fbi_crime_',
                      triggers: [{method:'POST', path:'/api/v1/fbi-crime/estimates/ingest', label:'Ingest estimates'}, {method:'POST', path:'/api/v1/fbi-crime/summarized/ingest', label:'Ingest summarized'}, {method:'POST', path:'/api/v1/fbi-crime/nibrs/ingest', label:'Ingest NIBRS'}, {method:'POST', path:'/api/v1/fbi-crime/hate-crime/ingest', label:'Ingest hate crime'}, {method:'POST', path:'/api/v1/fbi-crime/leoka/ingest', label:'Ingest LEOKA'}, {method:'POST', path:'/api/v1/fbi-crime/ingest/all', label:'Ingest all'}],
                      endpoints: [{method:'GET', path:'/api/v1/fbi-crime/datasets', label:'List datasets'}, {method:'GET', path:'/api/v1/fbi-crime/offenses', label:'Offense types'}, {method:'GET', path:'/api/v1/fbi-crime/states', label:'State data'}],
                      scheduleOptions: ['monthly','quarterly','yearly'] },
                    { key: 'kaggle', label: 'Kaggle Datasets', tables: ['m5_calendar', 'm5_items', 'm5_prices', 'm5_sales'],
                      triggers: [{method:'POST', path:'/api/v1/kaggle/m5/ingest', label:'Ingest M5 data'}, {method:'POST', path:'/api/v1/kaggle/m5/prepare-tables', label:'Prepare tables'}],
                      endpoints: [{method:'GET', path:'/api/v1/kaggle/m5/info', label:'M5 status'}, {method:'GET', path:'/api/v1/kaggle/m5/files', label:'M5 files'}, {method:'GET', path:'/api/v1/kaggle/m5/schema', label:'M5 schema'}],
                      scheduleOptions: ['monthly'] },
                    { key: 'fcc_broadband', label: 'FCC Broadband (National)', tablePrefix: 'fcc_',
                      triggers: [{method:'POST', path:'/api/v1/fcc-broadband/state/ingest', label:'Ingest state'}, {method:'POST', path:'/api/v1/fcc-broadband/all-states/ingest', label:'Ingest all states'}, {method:'POST', path:'/api/v1/fcc-broadband/county/ingest', label:'Ingest county'}],
                      endpoints: [{method:'GET', path:'/api/v1/fcc-broadband/reference/states', label:'States'}, {method:'GET', path:'/api/v1/fcc-broadband/reference/technologies', label:'Technologies'}, {method:'GET', path:'/api/v1/fcc-broadband/reference/speed-tiers', label:'Speed tiers'}, {method:'GET', path:'/api/v1/fcc-broadband/datasets', label:'List datasets'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'uspto', label: 'USPTO Patents', tablePrefix: 'uspto_',
                      triggers: [{method:'POST', path:'/api/v1/uspto/ingest/assignee', label:'Ingest by assignee'}, {method:'POST', path:'/api/v1/uspto/ingest/cpc', label:'Ingest by CPC'}, {method:'POST', path:'/api/v1/uspto/ingest/search', label:'Ingest by search'}],
                      endpoints: [{method:'GET', path:'/api/v1/uspto/patents', label:'Search patents'}, {method:'GET', path:'/api/v1/uspto/patents/{patent_id}', label:'Patent details'}, {method:'GET', path:'/api/v1/uspto/assignees', label:'Assignees'}, {method:'GET', path:'/api/v1/uspto/inventors', label:'Inventors'}, {method:'GET', path:'/api/v1/uspto/cpc-codes', label:'CPC codes'}, {method:'GET', path:'/api/v1/uspto/cpc-sections', label:'CPC sections'}, {method:'GET', path:'/api/v1/uspto/major-assignees', label:'Major assignees'}],
                      scheduleOptions: ['monthly','quarterly'] },
                    { key: 'yelp', label: 'Yelp Business Data', tablePrefix: 'yelp_',
                      triggers: [{method:'POST', path:'/api/v1/yelp/businesses/ingest', label:'Ingest businesses'}, {method:'POST', path:'/api/v1/yelp/businesses/multi-location/ingest', label:'Ingest multi-location'}, {method:'POST', path:'/api/v1/yelp/categories/ingest', label:'Ingest categories'}],
                      endpoints: [{method:'GET', path:'/api/v1/yelp/categories', label:'Categories'}, {method:'GET', path:'/api/v1/yelp/cities', label:'Cities'}, {method:'GET', path:'/api/v1/yelp/api-limits', label:'API limits'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'github', label: 'GitHub', tables: ['github_organizations', 'github_repositories'],
                      triggers: [{method:'POST', path:'/api/v1/github/org/{org}/fetch', label:'Fetch org data'}],
                      endpoints: [{method:'GET', path:'/api/v1/github/org/{org}', label:'Org overview'}, {method:'GET', path:'/api/v1/github/org/{org}/repos', label:'Org repos'}, {method:'GET', path:'/api/v1/github/org/{org}/activity', label:'Activity trends'}, {method:'GET', path:'/api/v1/github/org/{org}/contributors', label:'Contributors'}, {method:'GET', path:'/api/v1/github/org/{org}/score', label:'Velocity score'}, {method:'GET', path:'/api/v1/github/repo/{owner}/{repo}', label:'Repo details'}, {method:'GET', path:'/api/v1/github/search', label:'Search repos'}, {method:'GET', path:'/api/v1/github/stats', label:'Statistics'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'glassdoor', label: 'Glassdoor', tables: ['glassdoor_companies', 'glassdoor_salaries'],
                      triggers: [{method:'POST', path:'/api/v1/glassdoor/company', label:'Scrape company'}, {method:'POST', path:'/api/v1/glassdoor/salaries/bulk', label:'Bulk salaries'}, {method:'POST', path:'/api/v1/glassdoor/reviews/summary', label:'Review summary'}, {method:'POST', path:'/api/v1/glassdoor/import-csv', label:'Import CSV'}],
                      endpoints: [{method:'GET', path:'/api/v1/glassdoor/company/{name}', label:'Company data'}, {method:'GET', path:'/api/v1/glassdoor/company/{name}/salaries', label:'Salaries'}, {method:'GET', path:'/api/v1/glassdoor/company/{name}/reviews', label:'Reviews'}, {method:'GET', path:'/api/v1/glassdoor/compare', label:'Compare companies'}, {method:'GET', path:'/api/v1/glassdoor/search', label:'Search'}, {method:'GET', path:'/api/v1/glassdoor/rankings', label:'Rankings'}],
                      scheduleOptions: ['monthly'] },
                    { key: 'app_store', label: 'App Store Data', tablePrefix: 'app_store_',
                      triggers: [{method:'POST', path:'/api/v1/app-stores/ingest', label:'Ingest app data'}, {method:'POST', path:'/api/v1/app-stores/link', label:'Link to company'}],
                      endpoints: [{method:'GET', path:'/api/v1/app-stores/search', label:'Search apps'}, {method:'GET', path:'/api/v1/app-stores/app/{app_id}', label:'App details'}, {method:'GET', path:'/api/v1/app-stores/app/{app_id}/ratings', label:'Ratings'}, {method:'GET', path:'/api/v1/app-stores/app/{app_id}/rankings', label:'Rankings'}, {method:'GET', path:'/api/v1/app-stores/company/{company_name}/apps', label:'Company apps'}, {method:'GET', path:'/api/v1/app-stores/developer/{developer_name}', label:'Developer apps'}, {method:'GET', path:'/api/v1/app-stores/top', label:'Top apps'}, {method:'GET', path:'/api/v1/app-stores/stats', label:'Statistics'}],
                      scheduleOptions: ['weekly','monthly'] },
                    { key: 'geojson', label: 'GeoJSON Boundaries', tables: ['geojson_boundaries'],
                      endpoints: [{method:'GET', path:'/api/v1/geojson/datasets', label:'List datasets'}, {method:'GET', path:'/api/v1/geojson/boundaries/{dataset_id}', label:'Boundaries'}, {method:'GET', path:'/api/v1/geojson/boundary/{dataset_id}/{geo_id}', label:'Boundary GeoJSON'}, {method:'GET', path:'/api/v1/geojson/featurecollection/{dataset_id}', label:'Feature collection'}, {method:'GET', path:'/api/v1/geojson/search', label:'Search'}],
                      scheduleOptions: ['quarterly','yearly'] },
                ],
            },
        };

        const TOTAL_SOURCES = Object.values(SOURCE_REGISTRY).reduce((s, c) => s + c.sources.length, 0);

        // State
        let dashboardData = null;
        let siteIntelData = null;
        let schedulesData = null;
        let freshnessData = null;
        let watermarksData = null;
        let auditData = null;
        let activityData = null;
        let sourceConfigsData = null;
        let expandedCategories = {};
        let detailLoaded = false;
        let currentFilter = '';
        let currentFilterMode = 'all'; // 'all', 'with_data', 'empty'

        // Detail view state
        let currentView = 'list';       // 'list' or 'detail'
        let selectedSource = null;       // source object when in detail view
        let selectedCatKey = null;       // category key of selected source
        let allTablesCache = null;       // cached /export/tables response
        let collectionState = {
            selectedTriggerIndex: null,  // index into collectionFlow.triggers
            executionMode: null,         // 'run-once' | 'schedule' | null
        };
        let expandedTable = null;        // table name showing preview
        let tablePreview = null;         // { rows, columns, column_types, total_rows }
        let previewPage = 0;
        let previewLoading = false;
        const PREVIEW_PAGE_SIZE = 50;

        // Inline endpoint docs state
        let expandedEndpointKey = null;
        let openApiSpec = null;
        let openApiFetchPromise = null;
        let endpointDocsLoading = false;

        // Helpers
        function timeAgo(dateStr) {
            if (!dateStr) return 'Never';
            const now = new Date(), date = new Date(dateStr);
            const ms = now - date;
            if (ms < 0) return 'Just now';
            const mins = Math.floor(ms / 60000);
            if (mins < 1) return 'Just now';
            if (mins < 60) return mins + 'm ago';
            const hrs = Math.floor(mins / 60);
            if (hrs < 24) return hrs + 'h ago';
            const days = Math.floor(hrs / 24);
            if (days < 30) return days + 'd ago';
            return Math.floor(days / 30) + 'mo ago';
        }

        function fmtDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const mon = d.toLocaleString('en-US', { month: 'short' });
            const day = d.getDate();
            const hr = d.getHours().toString().padStart(2, '0');
            const min = d.getMinutes().toString().padStart(2, '0');
            return `${mon} ${day}, ${hr}:${min}`;
        }

        function fmtFullDate(dateStr) {
            if (!dateStr) return 'Never';
            return new Date(dateStr).toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: false
            });
        }

        function fmtNum(n) {
            if (n == null) return '-';
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toLocaleString();
        }

        // Build lookup maps
        function getSourceHealthMap() { return dashboardData?.source_health?.sources || {}; }
        function getScheduleMap() {
            const m = {};
            if (Array.isArray(schedulesData)) schedulesData.forEach(s => m[s.source] = s);
            return m;
        }
        function getLatestJobsMap() { return siteIntelData?.latest_jobs || {}; }
        function getWatermarkMap() {
            const m = {};
            if (watermarksData?.watermarks) watermarksData.watermarks.forEach(w => m[w.source] = w);
            return m;
        }

        // Resolve the health system key for a source
        function resolveHealthKey(key) {
            const found = findSourceByKey(key);
            if (!found) return key;
            const src = found.source;
            if (src.healthKey) return src.healthKey;
            return key;
        }

        // Get site intel collector status from siteIntelData
        function getSiCollectorStatus(src) {
            if (!src.siCollector || !siteIntelData) return null;
            const jobs = siteIntelData.latest_jobs || {};
            return jobs[src.siCollector] || null;
        }

        // Check if source has data in tables (fallback for sources not in health system)
        function getTableRowCount(src) {
            if (!allTablesCache) return 0;
            const tables = getTablesForSourceObj(src);
            return tables.reduce((sum, t) => sum + (t.row_count || 0), 0);
        }

        // Like getTablesForSource but takes source object directly
        function getTablesForSourceObj(source) {
            if (!allTablesCache) return [];
            if (source.tables && source.tables.length > 0) {
                return allTablesCache.filter(t => source.tables.includes(t.table_name));
            }
            if (source.tablePrefix) {
                return allTablesCache.filter(t => t.table_name.startsWith(source.tablePrefix));
            }
            return allTablesCache.filter(t => t.table_name.startsWith(source.key + '_'));
        }

        function getSourceStatus(key) {
            // 1. Check main health system (with resolved key)
            const hKey = resolveHealthKey(key);
            const h = getSourceHealthMap()[hKey];
            if (h) {
                if (h.status === 'healthy') return 'ok';
                if (h.status === 'degraded' || h.status === 'warning') return 'stale';
                if (h.status === 'critical') return 'error';
                if (h.last_success_at) return 'stale';
                return 'idle';
            }
            // 2. Check site intel collector status
            const found = findSourceByKey(key);
            if (found?.source.siCollector) {
                const siJob = getSiCollectorStatus(found.source);
                if (siJob) {
                    if (siJob.status === 'success' || siJob.status === 'completed') return 'ok';
                    if (siJob.status === 'partial') return 'stale';
                    if (siJob.status === 'failed') return 'error';
                    if (siJob.status === 'running') return 'ok';
                }
            }
            // 3. Check site intel latest_jobs directly
            const j = getLatestJobsMap()[key];
            if (j) {
                if (j.status === 'completed' && j.rows_collected > 0) return 'ok';
                if (j.status === 'failed') return 'error';
                if (j.status === 'running') return 'ok';
                return 'idle';
            }
            // 4. Fallback: check if tables have data
            if (found && allTablesCache) {
                const rows = getTableRowCount(found.source);
                if (rows > 0) return 'stale'; // has data but we don't know when it ran
            }
            return 'idle';
        }

        function getLastRunRaw(key) {
            const hKey = resolveHealthKey(key);
            const h = getSourceHealthMap()[hKey];
            if (h?.last_success_at) return h.last_success_at;
            // Site intel collector
            const found = findSourceByKey(key);
            if (found?.source.siCollector) {
                const siJob = getSiCollectorStatus(found.source);
                if (siJob?.completed_at) return siJob.completed_at;
            }
            const j = getLatestJobsMap()[key];
            if (j?.completed_at) return j.completed_at;
            const w = getWatermarkMap()[key];
            if (w?.last_collected_at) return w.last_collected_at;
            const s = getScheduleMap()[key];
            if (s?.last_run_at) return s.last_run_at;
            return null;
        }

        function getLastRun(key) {
            const raw = getLastRunRaw(key);
            if (raw) return `<span title="${fmtFullDate(raw)}">${timeAgo(raw)}<span class="ds-date-sub">${fmtDate(raw)}</span></span>`;
            // Fallback: if tables have data, show "Has data" instead of "Never"
            const found = findSourceByKey(key);
            if (found && allTablesCache) {
                const rows = getTableRowCount(found.source);
                if (rows > 0) return `<span style="color:var(--text-muted)">Has data (${fmtNum(rows)} rows)</span>`;
            }
            return 'Never';
        }

        function getRecords(key) {
            const j = getLatestJobsMap()[key];
            if (j?.rows_collected != null) return fmtNum(j.rows_collected);
            const hKey = resolveHealthKey(key);
            const h = getSourceHealthMap()[hKey];
            if (h?.success_24h > 0) return h.success_24h + ' jobs';
            // Site intel collector
            const found = findSourceByKey(key);
            if (found?.source.siCollector) {
                const siJob = getSiCollectorStatus(found.source);
                if (siJob?.rows_inserted != null) return fmtNum(siJob.rows_inserted);
            }
            // Table fallback
            if (found && allTablesCache) {
                const rows = getTableRowCount(found.source);
                if (rows > 0) return fmtNum(rows);
            }
            return '-';
        }

        function getFrequency(key) {
            const s = getScheduleMap()[key];
            if (!s) return 'Manual';
            if (!s.is_active) return 'Paused';
            return s.frequency ? s.frequency.charAt(0).toUpperCase() + s.frequency.slice(1) : 'Manual';
        }

        function countActive(sources) {
            return sources.filter(s => { const st = getSourceStatus(s.key); return st === 'ok' || st === 'stale'; }).length;
        }

        function filterSources(sources) {
            if (!currentFilter.trim()) return sources;
            const q = currentFilter.toLowerCase();
            return sources.filter(s =>
                s.label.toLowerCase().includes(q) ||
                s.key.toLowerCase().includes(q) ||
                (s.domain && s.domain.toLowerCase().includes(q))
            );
        }

        // Render the entire sources dashboard
        function renderSources() {
            if (currentView === 'detail') {
                renderDetailView();
                return;
            }
            renderListView();
        }

        // Get the DB table names for a source as a display string
        function getSourceTableNames(src) {
            if (src.tables && src.tables.length > 0) return src.tables;
            if (src.tablePrefix) {
                if (!allTablesCache) return [src.tablePrefix + '*'];
                const matched = allTablesCache.filter(t => t.table_name.startsWith(src.tablePrefix));
                return matched.length > 0 ? matched.map(t => t.table_name) : [src.tablePrefix + '*'];
            }
            if (!allTablesCache) return [src.key + '_*'];
            const matched = allTablesCache.filter(t => t.table_name.startsWith(src.key + '_'));
            return matched.length > 0 ? matched.map(t => t.table_name) : [];
        }

        // Get total DB records for a source from actual tables
        function getDbRecords(src) {
            if (!allTablesCache) return 0;
            const tables = getTablesForSourceObj(src);
            return tables.reduce((sum, t) => sum + (t.row_count || 0), 0);
        }

        // Compute inventory stats
        function getInventoryStats() {
            const allTables = allTablesCache || [];
            const totalTables = allTables.length;
            const tablesWithData = allTables.filter(t => t.row_count > 0).length;
            const totalRecords = allTables.reduce((s, t) => s + t.row_count, 0);
            // Count sources with data
            let sourcesWithData = 0;
            let sourcesTotal = 0;
            for (const cat of Object.values(SOURCE_REGISTRY)) {
                for (const src of cat.sources) {
                    sourcesTotal++;
                    if (getDbRecords(src) > 0) sourcesWithData++;
                }
            }
            // Top tables
            const topTables = [...allTables].sort((a, b) => b.row_count - a.row_count).filter(t => t.row_count > 0).slice(0, 10);
            // Records per category
            const catRecords = {};
            for (const [catKey, cat] of Object.entries(SOURCE_REGISTRY)) {
                catRecords[catKey] = { label: cat.label, records: 0, sources: cat.sources.length, withData: 0 };
                for (const src of cat.sources) {
                    const r = getDbRecords(src);
                    catRecords[catKey].records += r;
                    if (r > 0) catRecords[catKey].withData++;
                }
            }
            return { totalTables, tablesWithData, totalRecords, sourcesWithData, sourcesTotal, topTables, catRecords };
        }

        function renderListView() {
            const inv = getInventoryStats();
            const alerts = dashboardData?.alerts || [];

            let html = '';

            // ---- Hero stats (data inventory focused) ----
            html += `<div class="ds-hero">
                <div class="ds-hero-card">
                    <div class="ds-hero-value">${fmtNum(inv.totalRecords)}</div>
                    <div class="ds-hero-label">Total Records</div>
                </div>
                <div class="ds-hero-card">
                    <div class="ds-hero-value">${inv.tablesWithData}<span style="font-size:1rem;color:var(--text-muted)">/${inv.totalTables}</span></div>
                    <div class="ds-hero-label">Tables with Data</div>
                </div>
                <div class="ds-hero-card">
                    <div class="ds-hero-value">${inv.sourcesWithData}<span style="font-size:1rem;color:var(--text-muted)">/${inv.sourcesTotal}</span></div>
                    <div class="ds-hero-label">Sources with Data</div>
                </div>
                <div class="ds-hero-card">
                    ${freshnessData?.avg_coverage_score != null
                        ? `<div class="ds-hero-value" style="color:${freshnessData.avg_coverage_score >= 60 ? 'var(--success)' : freshnessData.avg_coverage_score >= 35 ? 'var(--warning)' : 'var(--error)'}">${freshnessData.avg_coverage_score}/100</div>
                           <div class="ds-hero-label">Avg Coverage</div>`
                        : `<div class="ds-hero-value">${Object.keys(SOURCE_REGISTRY).length}</div>
                           <div class="ds-hero-label">Categories</div>`
                    }
                </div>
            </div>`;

            // ---- Data Coverage + Largest Tables (side by side) ----
            html += `<div style="display:flex;gap:1.5rem;margin-bottom:1.5rem;flex-wrap:wrap;">`;

            // Left: Data Coverage by Category (log-scale from freshness API)
            html += `<div class="card" style="flex:1;min-width:340px;margin-bottom:0;">
                <div class="card-title">Data Coverage by Category</div>`;

            const depthColors = { empty: 'var(--text-muted)', minimal: 'var(--error)', light: 'var(--warning)', moderate: 'var(--primary)', substantial: 'var(--accent)', comprehensive: 'var(--success)' };
            const freshCats = freshnessData?.categories || [];

            if (freshCats.length > 0) {
                // Use log-scale coverage from freshness API
                for (const fc of freshCats) {
                    const barColor = depthColors[fc.coverage_depth] || 'var(--primary)';
                    const score = fc.avg_coverage_score || 0;
                    html += `<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.625rem;cursor:pointer;">
                        <div style="width:140px;font-size:0.8rem;color:var(--text-muted);text-align:right;flex-shrink:0;">${fc.category}</div>
                        <div style="flex:1;background:var(--bg-input);border-radius:4px;height:20px;overflow:hidden;position:relative;">
                            <div style="width:${score}%;height:100%;background:${barColor};border-radius:4px;transition:width 0.4s;"></div>
                        </div>
                        <div style="width:32px;font-size:0.8rem;font-weight:700;color:${barColor};text-align:right;">${score}</div>
                        <div style="width:95px;font-size:0.7rem;text-transform:uppercase;font-weight:600;color:${barColor};letter-spacing:0.03em;">${fc.coverage_depth}</div>
                        <div style="width:70px;font-size:0.75rem;color:var(--text-muted);">${fmtNum(fc.total_records)}</div>
                    </div>`;
                }
                if (freshnessData?.avg_coverage_score != null) {
                    const avgColor = freshnessData.avg_coverage_score >= 60 ? 'var(--success)' : freshnessData.avg_coverage_score >= 35 ? 'var(--warning)' : 'var(--error)';
                    html += `<div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
                        <span style="font-size:0.8rem;color:var(--text-muted);">Overall: ${freshnessData.total_sources} sources &middot; ${fmtNum(freshnessData.total_records)} records</span>
                        <span style="font-size:0.9rem;font-weight:700;color:${avgColor};">Avg ${freshnessData.avg_coverage_score}/100</span>
                    </div>`;
                }
            } else {
                // Fallback to log scale from local table counts (handles 361 vs 7.1M gracefully)
                const maxCatRecords = Math.max(...Object.values(inv.catRecords).map(c => c.records), 1);
                const logMax = maxCatRecords > 0 ? Math.log10(maxCatRecords) : 1;
                for (const [catKey, cat] of Object.entries(inv.catRecords)) {
                    const pct = cat.records > 0 ? Math.max(3, Math.round((Math.log10(cat.records) / logMax) * 100)) : 0;
                    const barColor = cat.records > 0 ? 'var(--primary)' : 'var(--border)';
                    html += `<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.625rem;cursor:pointer;" onclick="expandedCategories['${catKey}']=true;renderSources();document.querySelector('[data-cat=\\'${catKey}\\']')?.scrollIntoView({behavior:'smooth'});">
                        <div style="width:130px;font-size:0.8rem;color:var(--text-muted);text-align:right;flex-shrink:0;">${cat.label}</div>
                        <div style="flex:1;background:var(--bg-input);border-radius:4px;height:20px;overflow:hidden;">
                            <div style="width:${pct}%;height:100%;background:${barColor};border-radius:4px;transition:width 0.3s;"></div>
                        </div>
                        <div style="width:80px;font-size:0.8rem;color:var(--text);font-weight:500;">${fmtNum(cat.records)}</div>
                        <div style="width:55px;font-size:0.75rem;color:var(--text-muted);">${cat.withData}/${cat.sources}</div>
                    </div>`;
                }
            }
            html += `</div>`;

            // Right: Largest Tables
            if (inv.topTables.length > 0) {
                html += `<div class="card" style="flex:0 0 380px;min-width:300px;margin-bottom:0;">
                    <div class="card-title">Largest Tables</div>
                    <table class="ds-table"><thead><tr>
                        <th>Table</th><th>Records</th><th>Cols</th>
                    </tr></thead><tbody>`;
                inv.topTables.forEach(t => {
                    html += `<tr style="cursor:pointer;" onclick="jumpToTablePreview('${t.table_name}')">
                        <td style="font-family:monospace;font-size:0.8rem;">${t.table_name}</td>
                        <td style="font-weight:600;">${fmtNum(t.row_count)}</td>
                        <td>${t.columns.length}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
            html += `</div>`;

            // ---- Alerts ----
            const importantAlerts = (alerts || []).filter(a => a.severity === 'critical' || a.severity === 'warning');
            if (importantAlerts.length > 0) {
                html += '<div class="ds-alerts">';
                importantAlerts.forEach(a => {
                    const icon = a.severity === 'critical' ? '!!' : '!';
                    html += `<div class="ds-alert-item"><span class="ds-alert-sev ${a.severity}">${icon}</span> ${a.message}</div>`;
                });
                html += '</div>';
            }

            // ---- Toolbar ----
            html += `<div class="ds-toolbar">
                <input class="search-input" type="text" placeholder="Filter sources..." value="${currentFilter}" oninput="currentFilter=this.value;renderSources()">
                <select class="search-input" style="flex:none;width:auto;" onchange="currentFilterMode=this.value;renderSources()">
                    <option value="all"${currentFilterMode==='all'?' selected':''}>All sources</option>
                    <option value="with_data"${currentFilterMode==='with_data'?' selected':''}>With data only</option>
                    <option value="empty"${currentFilterMode==='empty'?' selected':''}>Empty only</option>
                </select>
                <button class="btn btn-secondary" onclick="refreshSources()">Refresh</button>
            </div>`;

            // ---- Category accordions ----
            for (const [catKey, category] of Object.entries(SOURCE_REGISTRY)) {
                let filtered = filterSources(category.sources);
                // Apply data filter
                if (currentFilterMode === 'with_data') filtered = filtered.filter(s => getDbRecords(s) > 0);
                else if (currentFilterMode === 'empty') filtered = filtered.filter(s => getDbRecords(s) === 0);
                if ((currentFilter || currentFilterMode !== 'all') && filtered.length === 0) continue;

                const isExpanded = expandedCategories[catKey];
                const catRows = inv.catRecords[catKey];
                const chevron = isExpanded ? '&#9660;' : '&#9654;';

                html += `<div class="ds-category" data-cat="${catKey}">
                    <div class="ds-cat-header" onclick="toggleSourceCategory('${catKey}')">
                        <div class="ds-cat-left">
                            <span class="ds-chevron">${chevron}</span>
                            <span class="ds-cat-title">${category.label}</span>
                            <span class="ds-cat-count">(${filtered.length} sources)</span>
                        </div>
                        <div style="display:flex;gap:1rem;align-items:center;">
                            ${catRows.records > 0 ? `<span style="font-size:0.8rem;color:var(--text-muted);">${fmtNum(catRows.records)} records</span>` : ''}
                            ${catRows.withData > 0 ? `<span class="ds-badge-active">${catRows.withData} with data</span>` : ''}
                        </div>
                    </div>`;

                if (isExpanded) {
                    html += '<div class="ds-cat-body">';
                    if (catKey === 'site_intel') {
                        html += renderSiteIntelTable(filtered, catKey);
                    } else {
                        html += renderSourceTable(filtered, catKey);
                    }
                    html += '</div>';
                }
                html += '</div>';
            }

            document.getElementById('sources-content').innerHTML = html;
        }

        function renderSourceTable(sources, catKey) {
            if (sources.length === 0) return '<div class="empty">No matching sources</div>';
            let html = `<table class="ds-table"><thead><tr>
                <th>Source</th><th>DB Tables</th><th>Records</th><th>Frequency</th><th>APIs</th>
            </tr></thead><tbody>`;
            sources.forEach(s => {
                const st = getSourceStatus(s.key);
                const tableNames = getSourceTableNames(s);
                const dbRecords = getDbRecords(s);
                const tableDisplay = tableNames.length <= 2
                    ? tableNames.map(t => `<span style="font-family:monospace;font-size:0.75rem;">${t}</span>`).join(', ')
                    : `<span style="font-family:monospace;font-size:0.75rem;">${tableNames[0]}</span> <span style="color:var(--text-muted);font-size:0.7rem;">+${tableNames.length - 1} more</span>`;

                html += `<tr onclick="openSourceDetail('${s.key}','${catKey}')" title="Click to view details">
                    <td><span class="ds-dot ${st}"></span>${s.label}</td>
                    <td>${tableDisplay}</td>
                    <td style="font-weight:${dbRecords > 0 ? '600' : '400'};${dbRecords === 0 ? 'color:var(--text-muted);' : ''}">${dbRecords > 0 ? fmtNum(dbRecords) : '-'}</td>
                    <td>${getFrequency(s.key)}</td>
                    <td>${(s.endpoints?.length || 0) + (s.triggers?.length || 0)}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        function renderSiteIntelTable(sources, catKey) {
            const grouped = {};
            sources.forEach(s => {
                const d = s.domain || 'other';
                if (!grouped[d]) grouped[d] = [];
                grouped[d].push(s);
            });
            const domainLabels = { power: 'Power', telecom: 'Telecom', transport: 'Transport', labor: 'Labor', risk: 'Risk', incentives: 'Incentives', logistics: 'Logistics', water_utilities: 'Water & Utilities' };
            let html = '';
            for (const [domain, list] of Object.entries(grouped)) {
                const domainRecords = list.reduce((s, src) => s + getDbRecords(src), 0);
                html += `<div class="ds-domain-group">
                    <div class="ds-domain-header">${domainLabels[domain] || domain} <span class="ds-domain-count">${list.length}</span>${domainRecords > 0 ? ` <span style="font-size:0.75rem;color:var(--text-muted);font-weight:400;">&middot; ${fmtNum(domainRecords)} records</span>` : ''}</div>`;
                html += `<table class="ds-table"><thead><tr>
                    <th>Collector</th><th>Records</th><th>Frequency</th><th>APIs</th>
                </tr></thead><tbody>`;
                list.forEach(s => {
                    const st = getSourceStatus(s.key);
                    const dbRecords = getDbRecords(s);
                    html += `<tr onclick="openSourceDetail('${s.key}','${catKey}')" title="Click to view details">
                        <td><span class="ds-dot ${st}"></span>${s.label}</td>
                        <td style="font-weight:${dbRecords > 0 ? '600' : '400'};${dbRecords === 0 ? 'color:var(--text-muted);' : ''}">${dbRecords > 0 ? fmtNum(dbRecords) : '-'}</td>
                        <td>${getFrequency(s.key)}</td>
                        <td>${(s.endpoints?.length || 0) + (s.triggers?.length || 0)}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }
            return html;
        }

        // Jump directly to a table's preview from the "Largest Tables" section
        async function jumpToTablePreview(tableName) {
            // Find which source owns this table
            for (const [catKey, cat] of Object.entries(SOURCE_REGISTRY)) {
                for (const src of cat.sources) {
                    const tables = getSourceTableNames(src);
                    if (tables.includes(tableName)) {
                        await openSourceDetail(src.key, catKey);
                        toggleTablePreview(tableName);
                        return;
                    }
                }
            }
            // If no source found, open a standalone preview
            expandedTable = tableName;
            previewPage = 0;
            previewLoading = true;
            // Show a minimal detail view
            selectedSource = { key: tableName, label: tableName, tables: [tableName] };
            selectedCatKey = '';
            currentView = 'detail';
            renderSources();
            await loadPreview(tableName, 0);
        }

        // =================================================================
        //  DETAIL VIEW ‚Äî Click-into-source data browser
        // =================================================================

        function findSourceByKey(key) {
            for (const [catKey, cat] of Object.entries(SOURCE_REGISTRY)) {
                const src = cat.sources.find(s => s.key === key);
                if (src) return { source: src, catKey };
            }
            return null;
        }

        function getTablesForSource(source) {
            if (!allTablesCache) return [];
            // Explicit table list
            if (source.tables && source.tables.length > 0) {
                return allTablesCache.filter(t => source.tables.includes(t.table_name));
            }
            // Prefix-based matching
            if (source.tablePrefix) {
                return allTablesCache.filter(t => t.table_name.startsWith(source.tablePrefix));
            }
            // Fallback: try key as prefix
            return allTablesCache.filter(t => t.table_name.startsWith(source.key + '_'));
        }

        async function ensureTablesLoaded() {
            if (allTablesCache) return;
            try {
                const res = await fetch(`${API}/export/tables`);
                if (res.ok) allTablesCache = await res.json();
            } catch (e) {
                console.error('Failed to load tables:', e);
                allTablesCache = [];
            }
        }

        async function openSourceDetail(sourceKey, catKey) {
            selectedCatKey = catKey;
            const found = findSourceByKey(sourceKey);
            if (!found) return;
            selectedSource = found.source;
            currentView = 'detail';
            expandedTable = null;
            tablePreview = null;
            previewPage = 0;
            _sourceJobs = [];

            // Update URL hash for deep linking
            history.replaceState(null, '', '#/' + sourceKey);

            // Show loading state immediately
            document.getElementById('sources-content').innerHTML = '<div class="loading">Loading source details...</div>';

            await ensureTablesLoaded();
            renderSources();
            startSourceJobPolling();
        }

        function backToList() {
            currentView = 'list';
            selectedSource = null;
            expandedTable = null;
            tablePreview = null;
            previewPage = 0;
            collectionState = { selectedTriggerIndex: null, executionMode: null };
            stopSourceJobPolling();
            history.replaceState(null, '', '#/');
            renderSources();
        }

        // ---- Inline Endpoint Docs ----

        async function getOpenApiSpec() {
            if (openApiSpec) return openApiSpec;
            if (openApiFetchPromise) return openApiFetchPromise;
            openApiFetchPromise = (async () => {
                const urls = ['/openapi.json', 'http://localhost:8001/openapi.json'];
                for (const url of urls) {
                    try {
                        const r = await fetch(url);
                        if (!r.ok) continue;
                        const ct = r.headers.get('content-type') || '';
                        if (!ct.includes('json')) continue; // proxy returned HTML fallback
                        const spec = await r.json();
                        if (spec?.paths) { openApiSpec = spec; return spec; }
                    } catch (e) { console.warn(`OpenAPI fetch failed (${url}):`, e); }
                }
                console.warn('Could not load OpenAPI spec from any URL');
                return null;
            })();
            openApiFetchPromise.finally(() => { openApiFetchPromise = null; });
            return openApiFetchPromise;
        }

        function resolveRef(ref, spec) {
            if (!ref || !ref.startsWith('#/')) return null;
            const parts = ref.replace('#/', '').split('/');
            let obj = spec;
            for (const p of parts) { obj = obj?.[p]; if (!obj) return null; }
            return obj;
        }

        function getRefName(schema) {
            if (schema?.$ref) return schema.$ref.split('/').pop();
            if (schema?.allOf) {
                const refItem = schema.allOf.find(s => s.$ref);
                if (refItem) return refItem.$ref.split('/').pop();
            }
            return null;
        }

        function resolveSchema(schema, spec, depth = 0, seen = new Set()) {
            if (!schema || depth > 8) return schema;
            if (schema.$ref) {
                if (seen.has(schema.$ref)) return { type: 'object', title: schema.$ref.split('/').pop(), _circular: true };
                seen.add(schema.$ref);
                const resolved = resolveRef(schema.$ref, spec);
                return resolved ? resolveSchema({ ...resolved, title: resolved.title || schema.$ref.split('/').pop() }, spec, depth + 1, seen) : schema;
            }
            if (schema.allOf) {
                let merged = { type: 'object', properties: {}, required: [] };
                for (const sub of schema.allOf) {
                    const resolved = resolveSchema(sub, spec, depth + 1, seen);
                    if (resolved?.properties) Object.assign(merged.properties, resolved.properties);
                    if (resolved?.required) merged.required.push(...resolved.required);
                    if (resolved?.title) merged.title = resolved.title;
                }
                return merged;
            }
            if (schema.anyOf) {
                const nonNull = schema.anyOf.filter(s => s.type !== 'null');
                if (nonNull.length === 1) {
                    const inner = resolveSchema(nonNull[0], spec, depth + 1, seen);
                    return { ...inner, _nullable: true, description: schema.description || inner?.description };
                }
                return schema;
            }
            if (schema.properties) {
                const props = {};
                for (const [k, v] of Object.entries(schema.properties)) {
                    props[k] = resolveSchema(v, spec, depth + 1, seen);
                }
                return { ...schema, properties: props };
            }
            if (schema.items) return { ...schema, items: resolveSchema(schema.items, spec, depth + 1, seen) };
            return schema;
        }

        function getTypeString(prop) {
            if (!prop) return 'any';
            if (prop._circular) return prop.title || 'object (circular)';
            if (prop.enum) return prop.enum.map(v => `"${v}"`).join(' | ');
            let t = prop.type || 'any';
            if (prop.format) t += ` (${prop.format})`;
            if (t === 'array' && prop.items) {
                const itemType = prop.items?.title || prop.items?.type || 'any';
                t = itemType + '[]';
            }
            if (prop.anyOf) {
                t = prop.anyOf.map(s => s.type === 'null' ? 'null' : (s.title || s.type || 'any')).join(' | ');
            }
            if (prop._nullable) t += ' | null';
            return t;
        }

        function renderSchemaLines(schema, spec, indent = 0, seen = new Set()) {
            const resolved = resolveSchema(schema, spec, 0, new Set(seen));
            const pad = '  '.repeat(indent);
            const lines = [];

            if (resolved?._circular) {
                lines.push(`${pad}<span class="comment">// circular ref: ${escHtml(resolved.title)}</span>`);
                return lines;
            }

            // Array of objects
            if (resolved?.type === 'array' && resolved.items) {
                const itemResolved = resolveSchema(resolved.items, spec, 0, new Set(seen));
                if (itemResolved?.properties) {
                    const modelName = itemResolved.title || getRefName(resolved.items) || '';
                    lines.push(`${pad}[  <span class="comment">// ${escHtml(modelName)}[]</span>`);
                    lines.push(...renderObjectLines(itemResolved, spec, indent + 1, seen));
                    lines.push(`${pad}]`);
                } else {
                    const itemType = getTypeString(itemResolved);
                    lines.push(`${pad}<span class="type">${escHtml(itemType)}[]</span>`);
                }
                return lines;
            }

            // Object with properties
            if (resolved?.properties) {
                lines.push(...renderObjectLines(resolved, spec, indent, seen));
                return lines;
            }

            // Primitive
            lines.push(`${pad}<span class="type">${escHtml(getTypeString(resolved))}</span>`);
            return lines;
        }

        function renderObjectLines(resolved, spec, indent, seen) {
            const pad = '  '.repeat(indent);
            const required = new Set(resolved.required || []);
            const lines = [`${pad}{`];
            const entries = Object.entries(resolved.properties || {});
            entries.forEach(([key, prop], i) => {
                const innerPad = '  '.repeat(indent + 1);
                const reqMark = required.has(key) ? '<span class="required-marker">*</span>' : '';
                const comma = i < entries.length - 1 ? ',' : '';

                // Check if prop is a nested object or array of objects
                const propResolved = resolveSchema(prop, spec, 0, new Set(seen));
                const isNestedObj = propResolved?.properties && !propResolved._circular;
                const isNestedArr = propResolved?.type === 'array' && resolveSchema(propResolved?.items, spec, 0, new Set(seen))?.properties;

                if (isNestedObj && Object.keys(propResolved.properties).length > 0) {
                    const modelName = propResolved.title || getRefName(prop) || '';
                    const desc = prop?.description || propResolved?.description || '';
                    const descComment = desc ? `  <span class="comment">// ${escHtml(desc)}</span>` : '';
                    lines.push(`${innerPad}<span class="key">"${escHtml(key)}"</span>${reqMark}: {${descComment}${modelName ? `  <span class="comment">(${escHtml(modelName)})</span>` : ''}`);
                    const nestedEntries = Object.entries(propResolved.properties);
                    const nestedRequired = new Set(propResolved.required || []);
                    nestedEntries.forEach(([nk, nv], ni) => {
                        const deepPad = '  '.repeat(indent + 2);
                        const nReqMark = nestedRequired.has(nk) ? '<span class="required-marker">*</span>' : '';
                        const nResolved = resolveSchema(nv, spec, 0, new Set(seen));
                        const nType = getTypeString(nResolved);
                        const nDesc = nv?.description || nResolved?.description || '';
                        const nDescComment = nDesc ? `  <span class="comment">// ${escHtml(nDesc)}</span>` : '';
                        const nDefault = nResolved?.default !== undefined ? ` = ${escHtml(JSON.stringify(nResolved.default))}` : '';
                        const nEnum = nResolved?.enum ? `  <span class="comment">enum: [${nResolved.enum.map(v => `"${v}"`).join(', ')}]</span>` : '';
                        const nComma = ni < nestedEntries.length - 1 ? ',' : '';

                        // If this nested prop is ALSO an object, show its type name but don't go infinitely deep
                        const deepResolved = resolveSchema(nv, spec, 0, new Set(seen));
                        if (deepResolved?.properties && !deepResolved._circular && Object.keys(deepResolved.properties).length > 0) {
                            const deepModel = deepResolved.title || getRefName(nv) || 'object';
                            lines.push(`${deepPad}<span class="key">"${escHtml(nk)}"</span>${nReqMark}: <span class="type">${escHtml(deepModel)}</span>${nDefault}${nComma}${nDescComment}`);
                        } else {
                            lines.push(`${deepPad}<span class="key">"${escHtml(nk)}"</span>${nReqMark}: <span class="type">${escHtml(nType)}</span>${nDefault}${nComma}${nDescComment}${nEnum}`);
                        }
                    });
                    lines.push(`${innerPad}}${comma}`);
                } else if (isNestedArr) {
                    const itemResolved = resolveSchema(propResolved.items, spec, 0, new Set(seen));
                    const modelName = itemResolved?.title || getRefName(propResolved.items) || 'object';
                    const desc = prop?.description || propResolved?.description || '';
                    const descComment = desc ? `  <span class="comment">// ${escHtml(desc)}</span>` : '';
                    lines.push(`${innerPad}<span class="key">"${escHtml(key)}"</span>${reqMark}: <span class="type">${escHtml(modelName)}[]</span>${comma}${descComment}`);
                } else {
                    const typeStr = getTypeString(propResolved);
                    const desc = prop?.description || propResolved?.description || '';
                    const descComment = desc ? `  <span class="comment">// ${escHtml(desc)}</span>` : '';
                    const defVal = propResolved?.default !== undefined ? ` = ${escHtml(JSON.stringify(propResolved.default))}` : '';
                    const enumVals = propResolved?.enum ? `  <span class="comment">enum: [${propResolved.enum.map(v => `"${v}"`).join(', ')}]</span>` : '';
                    lines.push(`${innerPad}<span class="key">"${escHtml(key)}"</span>${reqMark}: <span class="type">${escHtml(typeStr)}</span>${defVal}${comma}${descComment}${enumVals}`);
                }
            });
            lines.push(`${pad}}`);
            return lines;
        }

        function renderSchemaAsBlock(schema, spec) {
            const modelName = getRefName(schema);
            const lines = renderSchemaLines(schema, spec);
            if (lines.length === 0) return '<span class="comment">// No schema available</span>';
            let header = '';
            if (modelName) header = `<div class="ep-model-name">Model: <span>${escHtml(modelName)}</span></div>`;
            return header + lines.join('\n');
        }

        function escHtml(s) {
            if (!s) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function simpleMarkdown(text) {
            if (!text) return '';
            let html = escHtml(text);
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            html = html.replace(/\n\n/g, '</p><p>');
            return '<p>' + html + '</p>';
        }

        function buildCurlExample(method, path, operation, spec) {
            let url = `http://localhost:8001${path}`;
            const params = operation.parameters || [];
            const queryParams = params.filter(p => p.in === 'query' && p.required);
            if (queryParams.length > 0) {
                url += '?' + queryParams.map(p => `${p.name}={${p.name}}`).join('&');
            }
            let curl = `curl -X ${method} "${url}"`;
            if (['POST', 'PUT', 'PATCH'].includes(method)) {
                curl += ` \\\n  -H "Content-Type: application/json"`;
                const bodySchema = operation.requestBody?.content?.['application/json']?.schema;
                if (bodySchema) {
                    const resolved = resolveSchema(bodySchema, spec);
                    if (resolved?.properties) {
                        const example = {};
                        const required = new Set(resolved.required || []);
                        for (const [k, v] of Object.entries(resolved.properties)) {
                            if (k === '_required') continue;
                            if (required.has(k) || Object.keys(example).length < 3) {
                                example[k] = v?.example ?? v?.default ?? (v?.type === 'integer' ? 0 : v?.type === 'boolean' ? false : v?.type === 'array' ? [] : '...');
                            }
                        }
                        curl += ` \\\n  -d '${JSON.stringify(example)}'`;
                    }
                }
            }
            return curl;
        }

        function findSpecPath(rawPath, spec) {
            const paths = spec.paths || {};
            // Strip query string and trailing slash for matching
            const clean = rawPath.split('?')[0].replace(/\/+$/, '');
            // 1. Exact match (with and without trailing slash)
            if (paths[clean]) return clean;
            if (paths[clean + '/']) return clean + '/';
            if (paths[rawPath]) return rawPath;
            // 2. Normalize param names: {id} matches {firm_id} etc.
            const norm = p => p.replace(/\{[^}]+\}/g, '{}');
            const cleanNorm = norm(clean);
            for (const sp of Object.keys(paths)) {
                if (norm(sp) === cleanNorm || norm(sp) === cleanNorm + '/') return sp;
            }
            return null;
        }

        function renderEndpointDocs(method, path) {
            const spec = openApiSpec;
            if (!spec) {
                return `<div class="ep-fallback">Could not load API documentation. <a href="http://localhost:8001/docs" target="_blank">Open Swagger UI</a></div>`;
            }
            const matched = findSpecPath(path, spec);
            if (!matched) {
                const clean = path.split('?')[0].replace(/\/+$/, '');
                return `<div class="ep-fallback">Endpoint <code>${escHtml(clean)}</code> not found in API spec. It may not be implemented yet or the path may have changed.</div>`;
            }
            return renderEndpointDocsInner(method, matched, spec.paths[matched], spec);
        }

        function renderEndpointDocsInner(method, path, pathObj, spec) {
            const op = pathObj[method.toLowerCase()];
            if (!op) {
                return `<div class="ep-fallback">Method ${method} not found for this path. <a href="http://localhost:8001/docs" target="_blank">Open Swagger UI</a></div>`;
            }

            let html = '';

            // Summary header (operation ID + summary)
            if (op.summary) {
                html += `<div style="font-size:0.95rem;font-weight:600;margin-bottom:0.5rem;">${escHtml(op.summary)}</div>`;
            }
            if (op.operationId) {
                html += `<div style="font-family:monospace;font-size:0.75rem;color:var(--text-muted);margin-bottom:0.75rem;">operationId: <span style="color:var(--primary);">${escHtml(op.operationId)}</span></div>`;
            }

            // Description
            const desc = op.description || '';
            if (desc) {
                html += `<div class="ep-docs-section">
                    <div class="ep-docs-section-title">Description</div>
                    <div class="ep-docs-desc">${simpleMarkdown(desc)}</div>
                </div>`;
            }

            // Parameters
            const params = [...(pathObj.parameters || []), ...(op.parameters || [])];
            if (params.length > 0) {
                html += `<div class="ep-docs-section">
                    <div class="ep-docs-section-title">Parameters</div>
                    <table class="ep-params-table">
                        <thead><tr><th>Name</th><th>In</th><th>Type</th><th>Req</th><th>Default</th><th>Description</th></tr></thead>
                        <tbody>`;
                params.forEach(p => {
                    const pSchema = resolveSchema(p.schema, spec);
                    const typeStr = getTypeString(pSchema);
                    const req = p.required ? '<span class="param-required">Yes</span>' : 'No';
                    const def = pSchema?.default !== undefined ? escHtml(JSON.stringify(pSchema.default)) : '-';
                    let descHtml = escHtml(p.description || pSchema?.description || '');
                    if (pSchema?.enum) {
                        descHtml += `<br><span class="ep-enum-values">enum: [${pSchema.enum.map(v => `"${v}"`).join(', ')}]</span>`;
                    }
                    if (pSchema?.minimum !== undefined || pSchema?.maximum !== undefined) {
                        const range = [];
                        if (pSchema.minimum !== undefined) range.push(`min: ${pSchema.minimum}`);
                        if (pSchema.maximum !== undefined) range.push(`max: ${pSchema.maximum}`);
                        descHtml += `<br><span class="ep-enum-values">${range.join(', ')}</span>`;
                    }
                    html += `<tr>
                        <td class="param-name">${escHtml(p.name)}</td>
                        <td>${p.in}</td>
                        <td class="param-type">${escHtml(typeStr)}</td>
                        <td>${req}</td>
                        <td>${def}</td>
                        <td>${descHtml}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }

            // Request Body
            const bodyContent = op.requestBody?.content?.['application/json'];
            if (bodyContent?.schema) {
                const reqLabel = op.requestBody?.required === false ? 'Request Body (optional, application/json)' : 'Request Body (application/json)';
                html += `<div class="ep-docs-section">
                    <div class="ep-docs-section-title">${reqLabel}</div>
                    <div class="ep-schema-block">${renderSchemaAsBlock(bodyContent.schema, spec)}</div>
                </div>`;
            }

            // All Responses
            const responseCodes = Object.keys(op.responses || {}).sort();
            if (responseCodes.length > 0) {
                html += `<div class="ep-docs-section">
                    <div class="ep-docs-section-title">Responses</div>`;
                responseCodes.forEach(code => {
                    const resp = op.responses[code];
                    const codeClass = code.startsWith('2') ? 'c2xx' : code.startsWith('4') ? 'c4xx' : code.startsWith('5') ? 'c5xx' : 'c4xx';
                    const respSchema = resp.content?.['application/json']?.schema;
                    html += `<div class="ep-response-block">
                        <span class="ep-response-code ${codeClass}">${code}</span>
                        <span style="font-size:0.8rem;color:var(--text-muted);">${escHtml(resp.description || '')}</span>`;
                    if (respSchema) {
                        html += `<div class="ep-schema-block" style="margin-top:0.375rem;">${renderSchemaAsBlock(respSchema, spec)}</div>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // Curl example
            html += `<div class="ep-docs-section">
                <div class="ep-docs-section-title">Example</div>
                <div class="ep-curl-block">${escHtml(buildCurlExample(method, path, op, spec))}</div>
            </div>`;

            return html;
        }

        async function toggleEndpointDocs(method, path) {
            const key = `${method} ${path}`;
            if (expandedEndpointKey === key) {
                expandedEndpointKey = null;
                renderDetailView();
                return;
            }
            expandedEndpointKey = key;
            if (!openApiSpec) {
                endpointDocsLoading = true;
                renderDetailView();
                const spec = await getOpenApiSpec();
                endpointDocsLoading = false;
                if (expandedEndpointKey !== key) return; // user clicked something else
            }
            renderDetailView();
        }

        // ===== Trigger Form Rendering Helpers =====

        function renderFormField(field, prefix) {
            const id = `${prefix}-${field.name}`;
            const req = field.required ? ' <span style="color:var(--error);">*</span>' : '';
            let input = '';
            if (field.type === 'select') {
                input = `<select id="${id}">` +
                    field.options.map(o => `<option value="${o.value}">${o.label}</option>`).join('') +
                    `</select>`;
            } else if (field.type === 'checkbox-group') {
                return `<div class="tf-field" style="min-width:100%;"><label>${field.label}${req}</label>
                    <div class="tf-checkbox-group">
                        ${field.options.map(o => `<label><input type="checkbox" name="${id}" value="${o.value}" checked> ${o.label}</label>`).join('')}
                    </div></div>`;
            } else if (field.type === 'textarea') {
                input = `<textarea id="${id}" rows="4" style="width:100%;font-family:monospace;font-size:0.8rem;" placeholder="${field.placeholder || ''}"></textarea>`;
            } else if (field.type === 'date') {
                input = `<input type="date" id="${id}" value="${field.default || ''}">`;
            } else if (field.type === 'number') {
                input = `<input type="number" id="${id}" placeholder="${field.placeholder || ''}" value="${field.default || ''}">`;
            } else {
                input = `<input type="text" id="${id}" placeholder="${field.placeholder || ''}" value="${field.default || ''}">`;
            }
            return `<div class="tf-field"><label>${field.label}${req}</label>${input}</div>`;
        }

        function renderTriggerForm(formDef, triggerId) {
            if (!formDef) return `<div class="tf-field" style="min-width:100%;">
                <label>Request Body (JSON)</label>
                <textarea id="tf-json-${triggerId}" rows="3" style="width:100%;font-family:monospace;font-size:0.8rem;" placeholder='{}'></textarea>
            </div>`;
            const prefix = `tf-${triggerId}`;
            let html = '';
            if (formDef.pathParams?.length) {
                html += '<div class="tf-row">';
                formDef.pathParams.forEach(p => { html += renderFormField(p, prefix + '-pp'); });
                html += '</div>';
            }
            if (formDef.fields?.length) {
                html += '<div class="tf-row">';
                formDef.fields.forEach(f => { html += renderFormField(f, prefix); });
                html += '</div>';
            }
            return html;
        }

        function collectFormValues(formDef, triggerPath, triggerBody, triggerId) {
            const prefix = `tf-${triggerId}`;
            // Separate query string so path param replacement doesn't break it
            const qIdx = triggerPath.indexOf('?');
            let resolvedPath = qIdx >= 0 ? triggerPath.substring(0, qIdx) : triggerPath;
            let queryString = qIdx >= 0 ? triggerPath.substring(qIdx) : '';
            let body = triggerBody ? { ...triggerBody } : {};

            if (formDef) {
                if (formDef.pathParams) {
                    for (const p of formDef.pathParams) {
                        const el = document.getElementById(`${prefix}-pp-${p.name}`);
                        const val = el?.value?.trim();
                        if (p.required && !val) return { error: `${p.label} is required` };
                        if (val) resolvedPath = resolvedPath.replace(`{${p.name}}`, val);
                    }
                }
                if (formDef.fields) {
                    for (const f of formDef.fields) {
                        if (f.type === 'checkbox-group') {
                            const vals = [...document.querySelectorAll(`input[name="${prefix}-${f.name}"]:checked`)].map(c => c.value);
                            if (vals.length > 0) body[f.name] = vals;
                        } else {
                            const el = document.getElementById(`${prefix}-${f.name}`);
                            let val = el?.value?.trim();
                            if (f.required && !val) return { error: `${f.label} is required` };
                            if (val) {
                                if (f.type === 'textarea') {
                                    // Parse JSON textarea (e.g. salaries array)
                                    try { body[f.name] = JSON.parse(val); }
                                    catch { return { error: `${f.label}: invalid JSON` }; }
                                } else if (f.name === 'bounding_box') {
                                    // Comma-separated floats => array of numbers
                                    body[f.name] = val.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
                                } else if (f.type === 'text' && val.includes(',') && ['filing_types','ciks','categories','years','family_office_names','series_ids','company_names','indicators','countries','state_codes','county_fips_codes','states','variables','places','locations','offenses','subjects','sources','top_pros','top_cons','lp_types','regions','datasets','seed_urls','subsidiary_names','allowed_domains','firm_ids','company_ids','map_functions'].includes(f.name)) {
                                    // comma-separated text => array for known array fields
                                    body[f.name] = val.split(',').map(s => s.trim()).filter(Boolean);
                                } else if (f.type === 'number') {
                                    body[f.name] = parseInt(val) || val;
                                } else if (val === 'true' || val === 'false') {
                                    body[f.name] = val === 'true';
                                } else {
                                    body[f.name] = val;
                                }
                            }
                        }
                    }
                }
            } else {
                // JSON textarea fallback
                const ta = document.getElementById(`tf-json-${triggerId}`);
                if (ta?.value?.trim()) {
                    try { body = { ...body, ...JSON.parse(ta.value) }; }
                    catch { return { error: 'Invalid JSON' }; }
                }
            }
            // Handle queryParams ‚Äî append to URL instead of body
            if (formDef?.queryParams) {
                const qp = [];
                for (const f of formDef.queryParams) {
                    if (f.type === 'checkbox-group') {
                        const vals = [...document.querySelectorAll(`input[name="${prefix}-${f.name}"]:checked`)].map(c => c.value);
                        vals.forEach(v => qp.push(`${f.name}=${encodeURIComponent(v)}`));
                    } else {
                        const el = document.getElementById(`${prefix}-${f.name}`);
                        let val = el?.value?.trim();
                        if (f.required && !val) return { error: `${f.label} is required` };
                        if (val) qp.push(`${f.name}=${encodeURIComponent(val)}`);
                    }
                }
                if (qp.length) queryString += (queryString ? '&' : '?') + qp.join('&');
            }
            return { resolvedPath: resolvedPath + queryString, body };
        }

        // ===== Unified New Collection Flow =====

        function findBestDefaultTrigger(triggers) {
            // Prefer "all", "batch", or "Ingest all" triggers
            const keywords = ['all', 'batch', 'bulk'];
            for (let i = 0; i < triggers.length; i++) {
                const lbl = triggers[i].label.toLowerCase();
                if (keywords.some(k => lbl.includes(k))) return i;
            }
            return 0;
        }

        function renderNewCollectionSection(src) {
            const flow = src.collectionFlow;
            const triggers = flow.triggers;
            // Initialize state if needed
            if (collectionState.selectedTriggerIndex === null) {
                collectionState.selectedTriggerIndex = flow.defaultTriggerIndex || 0;
            }
            if (collectionState.executionMode === null) {
                collectionState.executionMode = 'run-once';
            }
            const selIdx = collectionState.selectedTriggerIndex;
            const mode = collectionState.executionMode;
            const trigger = triggers[selIdx];
            const basePath = trigger.path.split('?')[0];
            const formDef = TRIGGER_FORMS[trigger.path] || TRIGGER_FORMS[basePath] || null;

            let html = `<div class="ds-detail-tables" style="padding-bottom:1.25rem;">
                <h3>New Collection</h3>`;

            // Row 1: Endpoint picker + mode toggle (side by side)
            html += `<div class="nc-controls-row">
                <div class="tf-field">
                    <label>Endpoint</label>
                    <select id="nc-endpoint-select" onchange="onCollectionTriggerChanged()">
                        ${triggers.map((t, i) => `<option value="${i}"${i === selIdx ? ' selected' : ''}>${escapeHtml(t.label)}</option>`).join('')}
                    </select>
                </div>
                <div style="display:flex;flex-direction:column;gap:0.35rem;">
                    <label style="font-size:0.75rem;color:var(--text-muted);font-weight:500;">Mode</label>
                    <div class="exec-mode-group">
                        <div class="exec-mode-btn${mode === 'run-once' ? ' active' : ''}" onclick="onExecutionModeChanged('run-once')">Run Once</div>
                        <div class="exec-mode-btn${mode === 'schedule' ? ' active' : ''}" onclick="onExecutionModeChanged('schedule')">Schedule</div>
                    </div>
                </div>
            </div>`;

            // Form fields (adapted for mode)
            html += `<div class="nc-form-section">`;
            html += renderCollectionForm(formDef, 'nc-form', mode, trigger.body);
            html += `</div>`;

            // Schedule-specific: info note + config
            if (mode === 'schedule') {
                const classification = classifyFormFields(formDef);
                if (classification.temporalType === 'date-range') {
                    html += `<div class="collection-info-note">Each scheduled run collects data from the start date forward. End date is omitted for recurring runs.</div>`;
                } else if (classification.temporalType === 'year-range') {
                    html += `<div class="collection-info-note">Each scheduled run collects data from the start year forward. End year is omitted for recurring runs.</div>`;
                }

                const schedOpts = src.scheduleOptions || ['daily','weekly','monthly'];
                const rec = src.recommendedCadence || schedOpts[0] || 'daily';

                html += `<div class="nc-sched-config">
                    <div class="tf-row">
                        <div class="tf-field" style="flex:1;">
                            <label>Schedule Name</label>
                            <input type="text" id="nc-sched-name" placeholder="e.g. ${escapeHtml(src.label)} ${rec.charAt(0).toUpperCase() + rec.slice(1)}">
                        </div>
                        <div class="tf-field" style="flex:1;">
                            <label>Description (optional)</label>
                            <input type="text" id="nc-sched-desc" placeholder="What this schedule does">
                        </div>
                    </div>
                    <div class="tf-row">
                        <div class="tf-field">
                            <label>Frequency</label>
                            <select id="nc-sched-freq" onchange="schedNewCollFreqChanged()">
                                ${schedOpts.map(o => `<option value="${o}"${o === rec ? ' selected' : ''}>${o.charAt(0).toUpperCase() + o.slice(1)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="tf-field">
                            <label>Hour (UTC)</label>
                            <input type="number" id="nc-sched-hour" value="6" min="0" max="23">
                        </div>
                        <div class="tf-field${rec !== 'weekly' ? ' hidden' : ''}" id="nc-sched-dow-wrap">
                            <label>Day of Week</label>
                            <select id="nc-sched-dow">
                                <option value="0">Monday</option><option value="1">Tuesday</option>
                                <option value="2">Wednesday</option><option value="3">Thursday</option>
                                <option value="4">Friday</option><option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                        </div>
                        <div class="tf-field${rec !== 'monthly' && rec !== 'quarterly' ? ' hidden' : ''}" id="nc-sched-dom-wrap">
                            <label>Day of Month</label>
                            <input type="number" id="nc-sched-dom" value="1" min="1" max="31">
                        </div>
                    </div>
                </div>`;
            }

            // Submit button
            const btnLabel = mode === 'schedule' ? 'Create Schedule' : 'Run Collection';
            html += `<div class="nc-submit-row">
                <button class="btn" style="padding:0.5rem 1.5rem;font-size:0.85rem;" onclick="submitCollection()">${btnLabel}</button>
                <div id="nc-result" style="flex:1;"></div>
            </div>`;

            // Active Schedules
            html += renderExistingSchedules(src);

            html += `</div>`;
            return html;
        }

        function renderCollectionForm(formDef, triggerId, mode, triggerBody) {
            if (!formDef) {
                const hasBody = triggerBody && Object.keys(triggerBody).length > 0;
                if (hasBody) {
                    // Pre-built body: show read-only summary instead of editable textarea
                    return `<div style="font-size:0.8rem;color:var(--text-muted);padding:0.25rem 0;">
                        <span style="font-family:monospace;background:var(--bg-input);padding:0.2rem 0.5rem;border-radius:4px;">${escapeHtml(JSON.stringify(triggerBody))}</span>
                    </div>`;
                }
                return `<div class="tf-field" style="min-width:100%;">
                    <label>Request Body (JSON)</label>
                    <textarea id="tf-json-${triggerId}" rows="3" style="width:100%;font-family:monospace;font-size:0.8rem;" placeholder='{}'></textarea>
                </div>`;
            }

            const prefix = `tf-${triggerId}`;
            const classification = classifyFormFields(formDef);
            const isSchedule = mode === 'schedule';
            let html = '';

            // Path params
            if (formDef.pathParams?.length) {
                html += '<div class="tf-row">';
                formDef.pathParams.forEach(p => { html += renderFormField(p, prefix + '-pp'); });
                html += '</div>';
            }

            // Body fields ‚Äî adapt date/year fields based on mode
            if (formDef.fields?.length) {
                html += '<div class="tf-row">';
                formDef.fields.forEach(f => {
                    const isEndField = classification.endField && f.name === classification.endField.name;
                    const isStartField = classification.startField && f.name === classification.startField.name;

                    if (isSchedule && isEndField) {
                        // Hide end date/year in schedule mode
                        return;
                    }

                    if (isSchedule && isStartField) {
                        // Adapt start field label and default for schedule mode
                        const adaptedField = { ...f };
                        if (classification.temporalType === 'date-range') {
                            adaptedField.label = 'Collect from (initial lookback)';
                            adaptedField.default = getSmartStartDefault(f.name);
                        } else if (classification.temporalType === 'year-range') {
                            adaptedField.label = 'Collect from year';
                            adaptedField.default = getSmartStartDefault(f.name);
                        }
                        html += renderFormField(adaptedField, prefix);
                        return;
                    }

                    html += renderFormField(f, prefix);
                });
                html += '</div>';
            }

            // Query params ‚Äî rendered same as body fields but sent as URL params
            if (formDef.queryParams?.length) {
                html += '<div class="tf-row">';
                formDef.queryParams.forEach(f => {
                    html += renderFormField(f, prefix);
                });
                html += '</div>';
            }

            // Inline note (helpful guidance for no-param endpoints)
            if (formDef._note) {
                html += `<div style="font-size:0.78rem;color:var(--text-muted);padding:0.35rem 0 0.1rem;line-height:1.4;">${escapeHtml(formDef._note)}</div>`;
            }

            return html;
        }

        function onCollectionTriggerChanged() {
            const sel = document.getElementById('nc-endpoint-select');
            if (sel) {
                collectionState.selectedTriggerIndex = parseInt(sel.value);
            }
            renderDetailView();
        }

        function onExecutionModeChanged(mode) {
            collectionState.executionMode = mode;
            renderDetailView();
        }

        function schedNewCollFreqChanged() {
            const freq = document.getElementById('nc-sched-freq')?.value;
            const dowWrap = document.getElementById('nc-sched-dow-wrap');
            const domWrap = document.getElementById('nc-sched-dom-wrap');
            if (dowWrap) dowWrap.classList.toggle('hidden', freq !== 'weekly');
            if (domWrap) domWrap.classList.toggle('hidden', freq !== 'monthly' && freq !== 'quarterly');
        }

        async function submitCollection() {
            if (collectionState.executionMode === 'schedule') {
                return submitNewSchedule();
            }
            return submitRunOnce();
        }

        async function submitRunOnce() {
            if (!selectedSource?.collectionFlow) return;
            const flow = selectedSource.collectionFlow;
            const trigger = flow.triggers[collectionState.selectedTriggerIndex];
            const resultEl = document.getElementById('nc-result');
            const basePath = trigger.path.split('?')[0];
            const formDef = TRIGGER_FORMS[trigger.path] || TRIGGER_FORMS[basePath] || null;

            const collected = collectFormValues(formDef, trigger.path, trigger.body || {}, 'nc-form');
            if (collected.error) {
                if (resultEl) resultEl.innerHTML = `<div class="tf-result error">${escapeHtml(collected.error)}</div>`;
                return;
            }

            if (resultEl) resultEl.innerHTML = '<span style="color:var(--text-muted);font-size:0.8rem;">Submitting...</span>';
            try {
                const opts = { method: trigger.method, headers: { 'Content-Type': 'application/json' } };
                if (Object.keys(collected.body).length > 0) opts.body = JSON.stringify(collected.body);
                const res = await fetch(collected.resolvedPath, opts);
                const data = await res.json();
                if (res.ok) {
                    const jobId = data.job_id || data.id || '';
                    showToast(`Collection started!${jobId ? ` Job ID: ${jobId}` : ''}`, 'success');
                    if (resultEl) resultEl.innerHTML = `<div class="tf-result success">Started${jobId ? ` (Job ${jobId})` : ''}</div>`;
                    // Reload source jobs to show the new running job
                    if (selectedSource) setTimeout(() => loadSourceJobs(selectedSource.key), 1000);
                } else {
                    showToast(`Failed: ${data.detail || JSON.stringify(data)}`, 'error');
                    if (resultEl) resultEl.innerHTML = `<div class="tf-result error">${escapeHtml(data.detail || JSON.stringify(data))}</div>`;
                }
            } catch (e) {
                showToast(`Request failed: ${e.message}`, 'error');
                if (resultEl) resultEl.innerHTML = `<div class="tf-result error">${escapeHtml(e.message)}</div>`;
            }
        }

        async function submitNewSchedule() {
            if (!selectedSource?.collectionFlow) return;
            const flow = selectedSource.collectionFlow;
            const trigger = flow.triggers[collectionState.selectedTriggerIndex];
            const resultEl = document.getElementById('nc-result');
            const basePath = trigger.path.split('?')[0];
            const formDef = TRIGGER_FORMS[trigger.path] || TRIGGER_FORMS[basePath] || null;

            const name = document.getElementById('nc-sched-name')?.value?.trim();
            const description = document.getElementById('nc-sched-desc')?.value?.trim() || null;
            const frequency = document.getElementById('nc-sched-freq')?.value || 'daily';
            const hour = parseInt(document.getElementById('nc-sched-hour')?.value) || 6;
            const dayOfWeekEl = document.getElementById('nc-sched-dow');
            const dayOfMonthEl = document.getElementById('nc-sched-dom');
            const dayOfWeek = (frequency === 'weekly' && dayOfWeekEl) ? parseInt(dayOfWeekEl.value) : null;
            const dayOfMonth = ((frequency === 'monthly' || frequency === 'quarterly') && dayOfMonthEl) ? parseInt(dayOfMonthEl.value) : null;

            if (!name) {
                if (resultEl) resultEl.innerHTML = '<div class="tf-result error">Schedule name is required</div>';
                return;
            }

            const collected = collectFormValues(formDef, trigger.path, trigger.body || {}, 'nc-form');
            if (collected.error) {
                if (resultEl) resultEl.innerHTML = `<div class="tf-result error">${escapeHtml(collected.error)}</div>`;
                return;
            }

            const config = { ...collected.body };
            config._trigger_path = collected.resolvedPath;
            config._trigger_method = trigger.method;

            if (resultEl) resultEl.innerHTML = '<span style="color:var(--text-muted);font-size:0.8rem;">Creating schedule...</span>';
            try {
                const schedBody = {
                    name,
                    source: selectedSource.key,
                    config,
                    frequency,
                    hour,
                    is_active: true,
                    priority: 5,
                };
                if (description) schedBody.description = description;
                if (dayOfWeek !== null) schedBody.day_of_week = dayOfWeek;
                if (dayOfMonth !== null) schedBody.day_of_month = dayOfMonth;
                const res = await fetch(`${API}/schedules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(schedBody),
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(`Schedule "${name}" created!`, 'success');
                    schedulesData = await fetch(`${API}/schedules`).then(r => r.ok ? r.json() : schedulesData).catch(() => schedulesData);
                    collectionState = { selectedTriggerIndex: null, executionMode: null };
                    renderDetailView();
                } else {
                    showToast(`Schedule creation failed: ${data.detail || JSON.stringify(data)}`, 'error');
                    if (resultEl) resultEl.innerHTML = `<div class="tf-result error">${escapeHtml(data.detail || JSON.stringify(data))}</div>`;
                }
            } catch (e) {
                showToast(`Schedule creation failed: ${e.message}`, 'error');
                if (resultEl) resultEl.innerHTML = `<div class="tf-result error">${escapeHtml(e.message)}</div>`;
            }
        }

        function renderExistingSchedules(src) {
            const sourceSchedules = (schedulesData || []).filter(s => s.source === src.key);
            let html = `<div style="margin-top:0.75rem;">
                <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;">Active Schedules</div>`;
            if (sourceSchedules.length > 0) {
                sourceSchedules.forEach(sched => {
                    const isActive = sched.is_active !== false;
                    const statusCls = isActive ? 'active' : 'paused';
                    const statusLabel = isActive ? 'Active' : 'Paused';
                    const lastRun = sched.last_run_at ? timeAgo(new Date(sched.last_run_at)) : 'Never';
                    const nextRun = sched.next_run_at ? new Date(sched.next_run_at).toLocaleString() : 'N/A';
                    const isEditing = _editingScheduleId === sched.id;
                    if (isEditing) {
                        html += renderScheduleEditForm(sched);
                    } else {
                        html += `<div class="schedule-list-item" style="flex-wrap:wrap;">
                            <span class="sched-name">${escapeHtml(sched.name || sched.source)}</span>
                            <span class="sched-freq">${sched.frequency || ''}</span>
                            <span style="font-size:0.7rem;color:var(--text-muted);">Last: ${lastRun}</span>
                            <span style="font-size:0.7rem;color:var(--text-muted);">Next: ${nextRun}</span>
                            <span class="schedule-badge ${statusCls}">${statusLabel}</span>
                            <button class="btn-sm" onclick="toggleScheduleActive(${sched.id}, ${!isActive})">${isActive ? 'Pause' : 'Activate'}</button>
                            <button class="btn-sm primary" onclick="runScheduleNow(${sched.id})">Run Now</button>
                            <button class="btn-sm" onclick="startEditSchedule(${sched.id})">Edit</button>
                            <button class="btn-sm" onclick="deleteSchedule(${sched.id}, '${escapeHtml(sched.name || sched.source)}')" style="color:var(--error);">Delete</button>
                            <button class="btn-sm" onclick="toggleScheduleHistory(${sched.id})">${_scheduleHistoryOpen === sched.id ? 'Hide History' : 'History'}</button>
                        </div>`;
                        if (_scheduleHistoryOpen === sched.id) {
                            html += renderScheduleHistoryPanel(sched.id);
                        }
                    }
                });
            } else {
                html += `<div style="font-size:0.8rem;color:var(--text-muted);padding:0.5rem 0;">
                    No schedules configured. Select <strong>Schedule</strong> above to create one.
                </div>`;
            }
            html += `</div>`;
            return html;
        }

        let _editingScheduleId = null;
        let _scheduleHistoryOpen = null;
        let _scheduleHistoryData = {};

        function renderScheduleEditForm(sched) {
            const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
            const freqOpts = ['daily','weekly','monthly','quarterly'];
            return `<div class="schedule-list-item" style="flex-direction:column;align-items:stretch;">
                <div class="sched-edit-form">
                    <div class="tf-field"><label>Name</label>
                        <input type="text" id="sched-edit-name-${sched.id}" value="${escapeHtml(sched.name || '')}">
                    </div>
                    <div class="tf-field"><label>Description</label>
                        <input type="text" id="sched-edit-desc-${sched.id}" value="${escapeHtml(sched.description || '')}">
                    </div>
                    <div class="tf-field" style="max-width:120px;"><label>Frequency</label>
                        <select id="sched-edit-freq-${sched.id}" onchange="schedEditFreqChanged(${sched.id})">
                            ${freqOpts.map(f => `<option value="${f}"${f === sched.frequency ? ' selected' : ''}>${f.charAt(0).toUpperCase() + f.slice(1)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="tf-field" style="max-width:80px;"><label>Hour (UTC)</label>
                        <input type="number" id="sched-edit-hour-${sched.id}" value="${sched.hour != null ? sched.hour : 6}" min="0" max="23">
                    </div>
                    <div class="tf-field${sched.frequency !== 'weekly' ? ' hidden' : ''}" id="sched-edit-dow-wrap-${sched.id}" style="max-width:120px;">
                        <label>Day of Week</label>
                        <select id="sched-edit-dow-${sched.id}">
                            ${days.map((d,i) => `<option value="${i}"${sched.day_of_week === i ? ' selected' : ''}>${d}</option>`).join('')}
                        </select>
                    </div>
                    <div class="tf-field${sched.frequency !== 'monthly' && sched.frequency !== 'quarterly' ? ' hidden' : ''}" id="sched-edit-dom-wrap-${sched.id}" style="max-width:100px;">
                        <label>Day of Month</label>
                        <input type="number" id="sched-edit-dom-${sched.id}" value="${sched.day_of_month || 1}" min="1" max="31">
                    </div>
                    <div class="sched-edit-actions">
                        <button class="btn-sm primary" onclick="saveEditSchedule(${sched.id})">Save</button>
                        <button class="btn-sm" onclick="cancelEditSchedule()">Cancel</button>
                    </div>
                </div>
            </div>`;
        }

        function schedEditFreqChanged(schedId) {
            const freq = document.getElementById('sched-edit-freq-' + schedId)?.value;
            const dowWrap = document.getElementById('sched-edit-dow-wrap-' + schedId);
            const domWrap = document.getElementById('sched-edit-dom-wrap-' + schedId);
            if (dowWrap) dowWrap.classList.toggle('hidden', freq !== 'weekly');
            if (domWrap) domWrap.classList.toggle('hidden', freq !== 'monthly' && freq !== 'quarterly');
        }

        function startEditSchedule(schedId) {
            _editingScheduleId = schedId;
            renderDetailView();
        }

        function cancelEditSchedule() {
            _editingScheduleId = null;
            renderDetailView();
        }

        async function saveEditSchedule(schedId) {
            const name = document.getElementById('sched-edit-name-' + schedId)?.value?.trim();
            const description = document.getElementById('sched-edit-desc-' + schedId)?.value?.trim() || null;
            const frequency = document.getElementById('sched-edit-freq-' + schedId)?.value;
            const hour = parseInt(document.getElementById('sched-edit-hour-' + schedId)?.value) || 6;
            const dayOfWeek = frequency === 'weekly' ? parseInt(document.getElementById('sched-edit-dow-' + schedId)?.value) : null;
            const dayOfMonth = (frequency === 'monthly' || frequency === 'quarterly') ? parseInt(document.getElementById('sched-edit-dom-' + schedId)?.value) : null;

            if (!name) { showToast('Schedule name is required', 'error'); return; }

            const body = { name, frequency, hour };
            if (description) body.description = description;
            if (dayOfWeek !== null) body.day_of_week = dayOfWeek;
            if (dayOfMonth !== null) body.day_of_month = dayOfMonth;

            try {
                const resp = await fetch(`${API}/schedules/${schedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (resp.ok) {
                    showToast('Schedule updated', 'success');
                    _editingScheduleId = null;
                    schedulesData = await fetch(`${API}/schedules`).then(r => r.ok ? r.json() : schedulesData).catch(() => schedulesData);
                    renderDetailView();
                } else {
                    const data = await resp.json();
                    showToast('Update failed: ' + (data.detail || resp.status), 'error');
                }
            } catch (err) { showToast('Update error: ' + err.message, 'error'); }
        }

        async function deleteSchedule(schedId, schedName) {
            if (!confirm(`Delete schedule "${schedName}"? This cannot be undone.`)) return;
            try {
                const resp = await fetch(`${API}/schedules/${schedId}`, { method: 'DELETE' });
                if (resp.ok) {
                    showToast('Schedule deleted', 'success');
                    schedulesData = await fetch(`${API}/schedules`).then(r => r.ok ? r.json() : schedulesData).catch(() => schedulesData);
                    renderDetailView();
                } else {
                    const data = await resp.json();
                    showToast('Delete failed: ' + (data.detail || resp.status), 'error');
                }
            } catch (err) { showToast('Delete error: ' + err.message, 'error'); }
        }

        async function toggleScheduleHistory(schedId) {
            if (_scheduleHistoryOpen === schedId) {
                _scheduleHistoryOpen = null;
                renderDetailView();
                return;
            }
            _scheduleHistoryOpen = schedId;
            try {
                const resp = await fetch(`${API}/schedules/${schedId}/history`);
                if (resp.ok) {
                    _scheduleHistoryData[schedId] = await resp.json();
                } else {
                    _scheduleHistoryData[schedId] = [];
                }
            } catch {
                _scheduleHistoryData[schedId] = [];
            }
            renderDetailView();
        }

        function renderScheduleHistoryPanel(schedId) {
            const jobs = (_scheduleHistoryData[schedId] || []).slice(0, 5);
            if (jobs.length === 0) {
                return `<div class="sched-history" style="padding-left:0.75rem;font-size:0.75rem;color:var(--text-muted);">No history for this schedule.</div>`;
            }
            let html = `<div class="sched-history" style="padding-left:0.75rem;">`;
            for (const job of jobs) {
                const statusCls = (job.status || '').toLowerCase();
                const dur = job.started_at && job.completed_at
                    ? Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000)
                    : null;
                const when = job.created_at ? new Date(job.created_at).toLocaleString() : '-';
                html += `<div class="sched-history-item">
                    <span class="job-status-badge ${statusCls}" style="font-size:0.65rem;">${job.status}</span>
                    <span>${formatDuration(dur)}</span>
                    <span>${job.rows_inserted != null ? job.rows_inserted.toLocaleString() + ' records' : ''}</span>
                    <span style="color:var(--text-muted);">${when}</span>
                </div>`;
            }
            html += `</div>`;
            return html;
        }

        // ==== Source Detail Job Activity ====
        let _sourceJobs = [];
        let _sourceJobsLoading = false;
        let _sourceJobPollTimer = null;
        let _sourceJobFilter = '';
        let _sourceJobOffset = 0;
        const _sourceJobLimit = 20;

        async function loadSourceJobs(sourceKey, append) {
            if (!sourceKey) return;
            _sourceJobsLoading = true;
            try {
                let url = `${API}/jobs?source=${encodeURIComponent(sourceKey)}&limit=${_sourceJobLimit}&offset=${_sourceJobOffset}`;
                if (_sourceJobFilter) url += `&status=${encodeURIComponent(_sourceJobFilter)}`;
                const resp = await fetch(url);
                if (resp.ok) {
                    const data = await resp.json();
                    if (append) {
                        _sourceJobs = _sourceJobs.concat(data);
                    } else {
                        _sourceJobs = data;
                    }
                } else if (!append) {
                    _sourceJobs = [];
                }
            } catch {
                if (!append) _sourceJobs = [];
            }
            _sourceJobsLoading = false;
            const el = document.getElementById('source-jobs-container');
            if (el && selectedSource && selectedSource.key === sourceKey) {
                el.innerHTML = renderSourceJobsInner(selectedSource);
            }
        }

        function onSourceJobFilterChanged() {
            const sel = document.getElementById('source-job-filter');
            _sourceJobFilter = sel ? sel.value : '';
            _sourceJobOffset = 0;
            if (selectedSource) loadSourceJobs(selectedSource.key);
        }

        function loadMoreSourceJobs() {
            _sourceJobOffset += _sourceJobLimit;
            if (selectedSource) loadSourceJobs(selectedSource.key, true);
        }

        function renderSourceJobActivity(src) {
            return `<div class="ds-detail-tables" id="source-jobs-section">
                <h3>Job Activity</h3>
                <div id="source-jobs-container">${renderSourceJobsInner(src)}</div>
            </div>`;
        }

        function renderSourceJobsInner(src) {
            let html = '';

            // Summary badges
            const counts = { running: 0, pending: 0, success: 0, failed: 0 };
            for (const j of _sourceJobs) {
                const s = (j.status || '').toLowerCase();
                if (counts[s] !== undefined) counts[s]++;
            }

            // Toolbar: filter + badges + retry all
            html += `<div class="source-jobs-toolbar">
                <select id="source-job-filter" onchange="onSourceJobFilterChanged()">
                    <option value=""${!_sourceJobFilter ? ' selected' : ''}>All Statuses</option>
                    <option value="success"${_sourceJobFilter === 'success' ? ' selected' : ''}>Success</option>
                    <option value="failed"${_sourceJobFilter === 'failed' ? ' selected' : ''}>Failed</option>
                    <option value="running"${_sourceJobFilter === 'running' ? ' selected' : ''}>Running</option>
                    <option value="pending"${_sourceJobFilter === 'pending' ? ' selected' : ''}>Pending</option>
                </select>
                <div class="source-jobs-badges">
                    ${counts.running ? `<span class="source-jobs-badge running">Running: ${counts.running}</span>` : ''}
                    ${counts.pending ? `<span class="source-jobs-badge pending">Pending: ${counts.pending}</span>` : ''}
                    ${counts.success ? `<span class="source-jobs-badge success">Success: ${counts.success}</span>` : ''}
                    ${counts.failed ? `<span class="source-jobs-badge failed">Failed: ${counts.failed}</span>` : ''}
                </div>
                ${counts.failed > 0 ? `<button class="btn-sm" onclick="retryAllFailedSource()" style="color:var(--error);border-color:var(--error);">Retry All Failed</button>` : ''}
            </div>`;

            // Active/running jobs for this source (from SSE-powered global map)
            const activeForSource = [];
            for (const [id, job] of _activeJobs) {
                if ((job.job_type || '').toLowerCase() === src.key.toLowerCase()) {
                    activeForSource.push({ id, ...job });
                }
            }

            // Also include pending/running jobs from _sourceJobs that aren't in activeForSource
            const activeIds = new Set(activeForSource.map(j => j.id));
            const runningFromHistory = _sourceJobs.filter(j =>
                (j.status === 'running' || j.status === 'pending') && !activeIds.has(j.id)
            );

            if (activeForSource.length > 0 || runningFromHistory.length > 0) {
                html += `<div class="source-jobs-active">`;
                for (const job of activeForSource) {
                    const pct = job.progress_pct || 0;
                    html += `<div class="source-jobs-active-item">
                        <span class="job-status-badge running">${job.status || 'running'}</span>
                        <div class="job-progress-bar"><div class="job-progress-fill" style="width:${pct}%"></div></div>
                        <span style="font-size:0.8rem;color:var(--text-muted);">${escapeHtml(job.progress_message || 'Processing...')}</span>
                        <span class="jobs-elapsed" data-started="${job.started_at || ''}">${job.started_at ? formatElapsed(job.started_at) : ''}</span>
                        <button class="btn-sm" onclick="event.stopPropagation();cancelSourceJob(${job.id})" style="color:var(--error);font-size:0.7rem;">Cancel</button>
                    </div>`;
                }
                for (const job of runningFromHistory) {
                    html += `<div class="source-jobs-active-item">
                        <span class="job-status-badge ${job.status}">${job.status}</span>
                        <div class="job-progress-bar"><div class="job-progress-fill" style="width:0%"></div></div>
                        <span style="font-size:0.8rem;color:var(--text-muted);">Job #${job.id}${job.config?.dataset ? ' &mdash; ' + job.config.dataset : ''}</span>
                        <span class="jobs-elapsed" data-started="${job.started_at || ''}">${job.started_at ? formatElapsed(job.started_at) : ''}</span>
                        <button class="btn-sm" onclick="event.stopPropagation();cancelSourceJob(${job.id})" style="color:var(--error);font-size:0.7rem;">Cancel</button>
                    </div>`;
                }
                html += `</div>`;
            }

            // Loading state
            if (_sourceJobsLoading && _sourceJobs.length === 0) {
                html += `<div class="source-jobs-empty">Loading job history...</div>`;
                return html;
            }

            // History table
            if (_sourceJobs.length === 0) {
                html += `<div class="source-jobs-empty">No jobs have run for this source yet.</div>`;
                return html;
            }

            html += `<table class="source-jobs-table">
                <thead><tr>
                    <th>ID</th><th>Status</th><th>Config</th><th>Duration</th><th>Records</th><th>Error</th><th>Started</th><th></th>
                </tr></thead><tbody>`;

            for (const job of _sourceJobs) {
                const statusCls = (job.status || '').toLowerCase();
                const started = job.started_at ? new Date(job.started_at).toLocaleString() : '-';
                const dur = job.started_at && job.completed_at
                    ? Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000)
                    : null;
                const configSnip = job.config ? Object.entries(job.config).filter(([k,v]) => v != null && k !== 'dataset').map(([k,v]) => `${k}=${v}`).join(', ') : '-';
                const errorSnip = job.error_message ? escapeHtml(job.error_message.substring(0, 60)) + (job.error_message.length > 60 ? '...' : '') : '-';

                // Action button logic: Re-run for success, Retry for failed, Restart for pending, Cancel for running
                let actionBtn = '';
                if (job.status === 'running') {
                    actionBtn = `<button class="btn-sm" onclick="event.stopPropagation();cancelSourceJob(${job.id})" style="white-space:nowrap;color:var(--error);">Cancel</button>`;
                } else if (job.status === 'failed') {
                    actionBtn = `<button class="btn-sm primary" onclick="event.stopPropagation();sourceJobRestart(${job.id})" style="white-space:nowrap;">Retry</button>`;
                } else if (job.status === 'pending') {
                    actionBtn = `<button class="btn-sm primary" onclick="event.stopPropagation();sourceJobRestart(${job.id})" style="white-space:nowrap;">Restart</button>`;
                } else if (job.status === 'success') {
                    actionBtn = `<button class="btn-sm" onclick="event.stopPropagation();sourceJobRestart(${job.id})" style="white-space:nowrap;">Re-run</button>`;
                }

                html += `<tr onclick="toggleSourceJobDetail(${job.id})">
                    <td>${job.id}</td>
                    <td><span class="job-status-badge ${statusCls}">${escapeHtml(job.status)}</span></td>
                    <td style="font-size:0.78rem;color:var(--text-muted);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(configSnip) || '-'}</td>
                    <td>${formatDuration(dur)}</td>
                    <td>${job.rows_inserted != null ? job.rows_inserted.toLocaleString() : '-'}</td>
                    <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:${job.error_message ? 'var(--error)' : 'var(--text-muted)'};">${errorSnip}</td>
                    <td style="font-size:0.78rem;color:var(--text-muted);">${started}</td>
                    <td>${actionBtn}</td>
                </tr>
                <tr class="source-jobs-detail hidden" id="src-job-detail-${job.id}">
                    <td colspan="8">
                        <div class="source-jobs-detail-inner">
                            <div class="detail-row"><span class="detail-label">Created:</span>${job.created_at ? new Date(job.created_at).toLocaleString() : '-'}</div>
                            <div class="detail-row"><span class="detail-label">Started:</span>${job.started_at ? new Date(job.started_at).toLocaleString() : '-'}</div>
                            <div class="detail-row"><span class="detail-label">Completed:</span>${job.completed_at ? new Date(job.completed_at).toLocaleString() : '-'}</div>
                            <div class="detail-row"><span class="detail-label">Records:</span>${job.rows_inserted != null ? job.rows_inserted.toLocaleString() : '-'}</div>
                            ${job.error_message ? `<div class="detail-row"><span class="detail-label">Error:</span><span style="color:var(--error);">${escapeHtml(job.error_message)}</span></div>` : ''}
                            <div class="detail-row"><span class="detail-label">Config:</span></div>
                            <pre>${escapeHtml(JSON.stringify(job.config, null, 2))}</pre>
                        </div>
                    </td>
                </tr>`;
            }
            html += '</tbody></table>';

            // Load More button
            if (_sourceJobs.length >= _sourceJobOffset + _sourceJobLimit) {
                html += `<div style="text-align:center;padding:0.75rem;">
                    <button class="btn-sm" onclick="loadMoreSourceJobs()">Load More</button>
                </div>`;
            }

            return html;
        }

        function toggleSourceJobDetail(jobId) {
            const el = document.getElementById('src-job-detail-' + jobId);
            if (el) el.classList.toggle('hidden');
        }

        async function sourceJobRetry(jobId) {
            try {
                const resp = await fetch(`${API}/jobs/${jobId}/retry`, { method: 'POST' });
                if (resp.ok) {
                    showToast('Retry submitted', 'success');
                    setTimeout(() => { if (selectedSource) loadSourceJobs(selectedSource.key); }, 500);
                } else {
                    const data = await resp.json();
                    showToast('Retry failed: ' + (data.detail || resp.status), 'error');
                }
            } catch (err) { showToast('Retry error: ' + err.message, 'error'); }
        }

        async function sourceJobRestart(jobId) {
            try {
                const resp = await fetch(`${API}/jobs/${jobId}/restart`, { method: 'POST' });
                if (resp.ok) {
                    showToast('Job restarted', 'success');
                    _sourceJobOffset = 0;
                    setTimeout(() => { if (selectedSource) loadSourceJobs(selectedSource.key); }, 1000);
                } else {
                    const data = await resp.json();
                    showToast('Restart failed: ' + (data.detail || resp.status), 'error');
                }
            } catch (err) { showToast('Restart error: ' + err.message, 'error'); }
        }

        async function cancelSourceJob(jobId) {
            if (!confirm('Cancel this job?')) return;
            try {
                const resp = await fetch(`${API}/jobs/${jobId}/cancel`, { method: 'POST' });
                if (resp.ok) {
                    showToast('Job cancelled', 'success');
                    setTimeout(() => { if (selectedSource) loadSourceJobs(selectedSource.key); }, 500);
                } else {
                    const data = await resp.json();
                    showToast('Cancel failed: ' + (data.detail || resp.status), 'error');
                }
            } catch (err) { showToast('Cancel error: ' + err.message, 'error'); }
        }

        async function retryAllFailedSource() {
            if (!selectedSource) return;
            if (!confirm('Retry all failed jobs for this source?')) return;
            try {
                const resp = await fetch(`${API}/jobs/retry/all?source=${encodeURIComponent(selectedSource.key)}`, { method: 'POST' });
                if (resp.ok) {
                    const data = await resp.json();
                    showToast(data.message || 'Retrying failed jobs', 'success');
                    _sourceJobOffset = 0;
                    setTimeout(() => { if (selectedSource) loadSourceJobs(selectedSource.key); }, 1000);
                } else {
                    const data = await resp.json();
                    showToast('Retry all failed: ' + (data.detail || resp.status), 'error');
                }
            } catch (err) { showToast('Retry all error: ' + err.message, 'error'); }
        }

        function startSourceJobPolling() {
            stopSourceJobPolling();
            if (selectedSource) {
                _sourceJobOffset = 0;
                loadSourceJobs(selectedSource.key);
                _sourceJobPollTimer = setInterval(() => {
                    if (selectedSource && currentView === 'detail') {
                        loadSourceJobs(selectedSource.key);
                    } else {
                        stopSourceJobPolling();
                    }
                }, 10000);
            }
        }

        function stopSourceJobPolling() {
            if (_sourceJobPollTimer) {
                clearInterval(_sourceJobPollTimer);
                _sourceJobPollTimer = null;
            }
        }

        function renderDetailView() {
            const src = selectedSource;
            if (!src) { backToList(); return; }

            const st = getSourceStatus(src.key);
            const catLabel = SOURCE_REGISTRY[selectedCatKey]?.label || '';
            const sourceTables = getTablesForSource(src);
            const totalRows = sourceTables.reduce((sum, t) => sum + (t.row_count || 0), 0);

            let html = '';

            // Back button
            html += `<button class="ds-detail-back" onclick="backToList()">&larr; Back to Sources</button>`;

            // Header card
            html += `<div class="ds-detail-header">
                <div class="ds-detail-title">
                    <span class="ds-dot ${st}" style="width:12px;height:12px;"></span>
                    ${src.label}
                    <span class="ds-status-text ${st}" style="font-size:0.9rem;">${st}</span>
                </div>
                <div style="color:var(--text-muted);font-size:0.85rem;margin-top:0.25rem;">${catLabel}${src.domain ? ' &mdash; ' + src.domain.replace(/_/g,' ') : ''}</div>
                <div class="ds-detail-meta">
                    <span class="ds-detail-chip">Last run: ${getLastRun(src.key)}</span>
                    <span class="ds-detail-chip">Records: ${getRecords(src.key)}</span>
                    <span class="ds-detail-chip">Frequency: ${getFrequency(src.key)}</span>
                    <span class="ds-detail-chip">${sourceTables.length} table${sourceTables.length !== 1 ? 's' : ''} &middot; ${fmtNum(totalRows)} total rows</span>
                </div>
                ${src.recommendedCadence && getFrequency(src.key) === 'Manual' ? `<div style="color:var(--text-muted);font-size:0.8rem;margin-top:0.5rem;">Recommended cadence: <strong>${src.recommendedCadence}</strong></div>` : ''}
            </div>`;

            // ---- Collection section ----
            const triggers = src.triggers || [];
            if (triggers.length > 0) {
                // Auto-build collectionFlow from triggers if not explicitly defined
                if (!src.collectionFlow) {
                    src.collectionFlow = {
                        triggers: triggers,
                        defaultTriggerIndex: findBestDefaultTrigger(triggers),
                    };
                }
                html += renderNewCollectionSection(src);
            }

            // ---- Job Activity section ----
            html += renderSourceJobActivity(src);

            // ---- Available Endpoints section ----
            const endpoints = src.endpoints || [];
            const allEndpoints = [...triggers, ...endpoints];
            if (allEndpoints.length > 0) {
                html += `<div class="ds-detail-tables">
                    <h3>Available API Endpoints</h3>`;
                allEndpoints.forEach(ep => {
                    const methodColor = ep.method === 'POST' ? 'var(--success)' : ep.method === 'GET' ? 'var(--accent)' : 'var(--warning)';
                    const epKey = `${ep.method} ${ep.path}`;
                    const isExpanded = expandedEndpointKey === epKey;
                    html += `<div class="ds-detail-table-row" style="cursor:default;margin-bottom:${isExpanded ? '0' : '0.375rem'};">
                        <div style="display:flex;align-items:center;gap:0.75rem;flex:1;">
                            <span style="background:${methodColor};color:white;padding:0.125rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:700;font-family:monospace;min-width:40px;text-align:center;">${ep.method}</span>
                            <div>
                                <div style="font-size:0.85rem;font-weight:500;">${ep.label}</div>
                                <div style="font-family:monospace;font-size:0.75rem;color:var(--text-muted);">${ep.path}</div>
                            </div>
                        </div>
                        <span class="btn-sm ep-docs-toggle" onclick="toggleEndpointDocs('${ep.method}','${ep.path}')" style="text-decoration:none;">${isExpanded ? '&#9660; Docs' : '&#9654; Docs'}</span>
                    </div>`;
                    if (isExpanded) {
                        html += `<div class="ep-docs-panel">`;
                        if (endpointDocsLoading) {
                            html += `<div class="ep-loading">Loading documentation...</div>`;
                        } else {
                            html += renderEndpointDocs(ep.method, ep.path);
                        }
                        html += `</div>`;
                    }
                });
                html += `</div>`;
            }

            // ---- Tables section ----
            html += `<div class="ds-detail-tables">
                <h3>Database Tables</h3>`;

            if (sourceTables.length === 0) {
                html += `<div class="empty">No tables found for this source. Tables may use a different naming convention or haven't been created yet.</div>`;
            } else {
                sourceTables.forEach(t => {
                    const isActive = expandedTable === t.table_name;
                    html += `<div class="ds-detail-table-row${isActive ? ' active' : ''}" onclick="toggleTablePreview('${t.table_name}')">
                        <div>
                            <div class="ds-detail-table-name">${isActive ? '&#9660;' : '&#9654;'} ${t.table_name}</div>
                        </div>
                        <div class="ds-detail-table-stats">
                            <span>${t.columns.length} columns</span>
                            <span>${fmtNum(t.row_count)} rows</span>
                        </div>
                    </div>`;

                    // Expanded table: schema + preview
                    if (isActive) {
                        // Schema
                        html += `<div class="ds-detail-schema">`;
                        if (tablePreview?.column_types) {
                            html += t.columns.map(c =>
                                `<span>${c}</span> <span style="color:var(--text-muted)">(${tablePreview.column_types[c] || 'unknown'})</span>`
                            ).join(', ');
                        } else {
                            html += t.columns.map(c => `<span>${c}</span>`).join(', ');
                        }
                        html += `</div>`;

                        // Preview data
                        if (previewLoading) {
                            html += `<div class="ds-preview-loading">Loading preview...</div>`;
                        } else if (tablePreview && tablePreview.rows) {
                            html += renderPreviewTable(tablePreview, t);
                        }
                    }
                });
            }
            html += `</div>`;

            // ---- Quick Actions footer ----
            html += `<div class="ds-detail-actions">
                <h3>Quick Actions</h3>`;
            html += `<a class="btn btn-secondary" href="http://localhost:8001/docs" target="_blank" style="text-decoration:none;">API Docs</a>`;
            if (sourceTables.length > 0) {
                html += `<button class="btn btn-secondary" onclick="exportSourceTable()">Export CSV</button>`;
            }
            html += `</div>`;

            document.getElementById('sources-content').innerHTML = html;
        }

        function renderPreviewTable(preview, tableInfo) {
            const cols = preview.columns || [];
            const rows = preview.rows || [];
            const total = preview.total_rows || 0;
            const currentPage = Math.floor(previewPage / PREVIEW_PAGE_SIZE) + 1;
            const totalPages = Math.max(1, Math.ceil(total / PREVIEW_PAGE_SIZE));

            let html = `<div class="ds-detail-preview">
                <table><thead><tr>`;
            cols.forEach(c => { html += `<th>${c}</th>`; });
            html += `</tr></thead><tbody>`;

            if (rows.length === 0) {
                html += `<tr><td colspan="${cols.length}" style="text-align:center;color:var(--text-muted);">No data</td></tr>`;
            } else {
                rows.forEach(row => {
                    html += '<tr>';
                    cols.forEach(c => {
                        const val = row[c];
                        const display = val === null ? '<span style="color:var(--text-muted)">null</span>' : String(val);
                        html += `<td title="${String(val ?? '')}">${display}</td>`;
                    });
                    html += '</tr>';
                });
            }

            html += `</tbody></table></div>`;

            // Pagination
            html += `<div class="ds-detail-pagination">
                <div>
                    <button onclick="prevPreviewPage()" ${previewPage === 0 ? 'disabled' : ''}>&#8592; Prev</button>
                    <button onclick="nextPreviewPage()" ${previewPage + PREVIEW_PAGE_SIZE >= total ? 'disabled' : ''}>Next &#8594;</button>
                </div>
                <span>Page ${currentPage} of ${fmtNum(totalPages)} &middot; ${fmtNum(total)} rows</span>
                <button class="btn btn-secondary" style="padding:0.375rem 0.75rem;font-size:0.8rem;" onclick="exportSourceTable()">Export CSV</button>
            </div>`;

            return html;
        }

        async function toggleTablePreview(tableName) {
            if (expandedTable === tableName) {
                // Collapse
                expandedTable = null;
                tablePreview = null;
                previewPage = 0;
                renderSources();
                return;
            }
            expandedTable = tableName;
            previewPage = 0;
            tablePreview = null;
            previewLoading = true;
            renderSources();
            await loadPreview(tableName, 0);
        }

        async function loadPreview(tableName, offset) {
            previewLoading = true;
            try {
                const res = await fetch(`${API}/export/tables/${encodeURIComponent(tableName)}/preview?limit=${PREVIEW_PAGE_SIZE}&offset=${offset}`);
                if (res.ok) {
                    tablePreview = await res.json();
                } else {
                    tablePreview = { columns: [], rows: [], total_rows: 0, column_types: {} };
                }
            } catch (e) {
                console.error('Preview load failed:', e);
                tablePreview = { columns: [], rows: [], total_rows: 0, column_types: {} };
            }
            previewLoading = false;
            renderSources();
        }

        async function nextPreviewPage() {
            if (!expandedTable || !tablePreview) return;
            previewPage += PREVIEW_PAGE_SIZE;
            await loadPreview(expandedTable, previewPage);
        }

        async function prevPreviewPage() {
            if (!expandedTable || previewPage <= 0) return;
            previewPage = Math.max(0, previewPage - PREVIEW_PAGE_SIZE);
            await loadPreview(expandedTable, previewPage);
        }

        async function exportSourceTable() {
            const tableName = expandedTable || (getTablesForSource(selectedSource)?.[0]?.table_name);
            if (!tableName) return;
            try {
                const res = await fetch(`${API}/export/jobs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_name: tableName, format: 'csv' })
                });
                if (res.ok) {
                    const job = await res.json();
                    showToast(`Export job #${job.id} created for ${tableName}. Check API docs to download when complete.`, 'success', 6000);
                } else {
                    const err = await res.json();
                    showToast(`Export failed: ${err.detail || 'Unknown error'}`, 'error');
                }
            } catch (e) {
                showToast(`Export failed: ${e.message}`, 'error');
            }
        }

        // ===== Schedule Management Helpers =====
        async function toggleScheduleActive(schedId, activate) {
            const action = activate ? 'activate' : 'pause';
            try {
                const res = await fetch(`${API}/schedules/${schedId}/${action}`, { method: 'POST' });
                if (res.ok) {
                    showToast(`Schedule ${activate ? 'activated' : 'paused'}`, 'success');
                    schedulesData = await fetch(`${API}/schedules`).then(r => r.ok ? r.json() : schedulesData).catch(() => schedulesData);
                    renderDetailView();
                } else {
                    const data = await res.json();
                    showToast(`Failed: ${data.detail || res.status}`, 'error');
                }
            } catch (e) {
                showToast(`Error: ${e.message}`, 'error');
            }
        }

        function runScheduleNow(schedId) {
            showConfirm('Run this schedule immediately?', async () => {
                try {
                    const res = await fetch(`${API}/schedules/${schedId}/run`, { method: 'POST' });
                    if (res.ok) {
                        showToast('Schedule triggered!', 'success');
                    } else {
                        const data = await res.json();
                        showToast(`Failed: ${data.detail || res.status}`, 'error');
                    }
                } catch (e) {
                    showToast(`Error: ${e.message}`, 'error');
                }
            });
        }

        function toggleSourceCategory(catKey) {
            expandedCategories[catKey] = !expandedCategories[catKey];
            if (expandedCategories[catKey] && !detailLoaded) {
                loadPhase2().then(() => renderSources());
            }
            renderSources();
        }

        // Phase 1: core data on page load
        async function loadPhase1() {
            try {
                const [dashRes, siteRes, schedRes, tablesRes, freshRes] = await Promise.all([
                    fetch(`${API}/jobs/monitoring/dashboard`).then(r => r.ok ? r.json() : null).catch(() => null),
                    fetch(`${API}/site-intel/sites/collect/status`).then(r => r.ok ? r.json() : null).catch(() => null),
                    fetch(`${API}/schedules`).then(r => r.ok ? r.json() : null).catch(() => null),
                    fetch(`${API}/export/tables`).then(r => r.ok ? r.json() : null).catch(() => null),
                    fetch(`${API}/datasets/freshness`).then(r => r.ok ? r.json() : null).catch(() => null),
                ]);
                dashboardData = dashRes;
                siteIntelData = siteRes;
                schedulesData = schedRes;
                allTablesCache = tablesRes;
                freshnessData = freshRes;
            } catch (e) { console.error('Phase 1 load error:', e); }

            document.getElementById('sources-loading').classList.add('hidden');
            document.getElementById('sources-content').classList.remove('hidden');
            renderSources();
        }

        // Phase 2: detail data (lazy)
        async function loadPhase2() {
            if (detailLoaded) return;
            try {
                const [auditRes, wmRes, cfgRes, actRes] = await Promise.all([
                    fetch(`${API}/audit-trail/summary`).then(r => r.ok ? r.json() : null).catch(() => null),
                    fetch(`${API}/site-intel/sites/watermarks`).then(r => r.ok ? r.json() : null).catch(() => null),
                    fetch(`${API}/source-configs`).then(r => r.ok ? r.json() : null).catch(() => null),
                    fetch(`${API}/audit-trail?limit=15`).then(r => r.ok ? r.json() : null).catch(() => null),
                ]);
                auditData = auditRes;
                watermarksData = wmRes;
                sourceConfigsData = cfgRes;
                activityData = actRes;
                detailLoaded = true;
            } catch (e) { console.error('Phase 2 load error:', e); }
        }

        function refreshSources() {
            detailLoaded = false;
            watermarksData = null;
            auditData = null;
            activityData = null;
            sourceConfigsData = null;
            freshnessData = null;
            document.getElementById('sources-loading').classList.remove('hidden');
            document.getElementById('sources-content').classList.add('hidden');
            loadPhase1();
        }

        // Start loading sources immediately
        loadPhase1();

        // ===================================================================
        //  SETTINGS TAB (API Key Management)
        // ===================================================================
        let apiKeysData = [];
        let editingSource = null;
        const collapsedCategories = {};

        async function loadApiKeys() {
            const container = document.getElementById('api-keys-container');
            if (!container) return;
            container.innerHTML = '<div class="loading">Loading API keys...</div>';
            try {
                const res = await fetch(`${API}/settings/api-keys`);
                apiKeysData = await res.json();
                renderApiKeys();
            } catch (err) {
                container.innerHTML = `<p style="color: var(--error);">Failed to load API keys: ${err.message}</p>`;
            }
        }

        function renderApiKeys(filterText) {
            const container = document.getElementById('api-keys-container');
            if (!container) return;
            const filter = (filterText || '').toLowerCase().trim();
            const visibleKeys = filter
                ? apiKeysData.filter(k => k.source.toLowerCase().includes(filter) || k.description.toLowerCase().includes(filter) || k.category.toLowerCase().includes(filter))
                : apiKeysData;

            const groups = {};
            visibleKeys.forEach(k => { if (!groups[k.category]) groups[k.category] = []; groups[k.category].push(k); });

            const allGroups = {};
            apiKeysData.forEach(k => { if (!allGroups[k.category]) allGroups[k.category] = []; allGroups[k.category].push(k); });

            const categoryOrder = ['Government Data','LLM / AI','Financial & Market Data','Location & Foot Traffic','Search & Web Data','Business Intelligence','Enrichment','Other'];
            const sortedCategories = categoryOrder.filter(c => groups[c]);

            let html = '';
            const configured = apiKeysData.filter(k => k.configured).length;
            const total = apiKeysData.length;
            html += `<div class="stats-grid" style="margin-bottom:1.5rem;">
                <div class="stat-card"><div class="stat-value" style="color:var(--success);">${configured}</div><div class="stat-label">Configured</div></div>
                <div class="stat-card"><div class="stat-value" style="color:var(--text-muted);">${total - configured}</div><div class="stat-label">Missing</div></div>
                <div class="stat-card"><div class="stat-value">${total}</div><div class="stat-label">Total Sources</div></div>
            </div>`;

            if (visibleKeys.length === 0) {
                html += '<div class="empty">No keys match your filter.</div>';
                container.innerHTML = html;
                return;
            }

            sortedCategories.forEach(cat => {
                const catKeys = groups[cat];
                const allCatKeys = allGroups[cat] || catKeys;
                const catConfigured = allCatKeys.filter(k => k.configured).length;
                const catTotal = allCatKeys.length;
                const isCollapsed = (collapsedCategories[cat] !== false) && !filter;
                const chevronClass = isCollapsed ? 'chevron collapsed' : 'chevron';

                html += `<div class="key-category" data-category="${cat}">`;
                html += `<div class="key-category-header" onclick="toggleSettingsCategory('${cat}')">`;
                html += `<span class="key-category-title"><span class="${chevronClass}">‚ñº</span> ${cat}</span>`;
                html += `<span class="key-category-count"><span class="configured-num">${catConfigured}</span> / ${catTotal} configured</span>`;
                html += `</div>`;
                html += `<div class="key-category-body${isCollapsed ? ' collapsed' : ''}" id="cat-body-${cat.replace(/[^a-zA-Z]/g, '')}">`;
                catKeys.forEach(k => { html += renderKeyRow(k); });
                html += `</div></div>`;
            });

            container.innerHTML = html;
        }

        function toggleSettingsCategory(cat) {
            collapsedCategories[cat] = collapsedCategories[cat] === false ? true : false;
            renderApiKeys(document.getElementById('key-filter')?.value || '');
        }

        function filterApiKeys(text) { renderApiKeys(text); }

        function renderKeyRow(k) {
            const isEditing = editingSource === k.source;
            const statusClass = k.configured ? 'configured' : 'missing';
            const sourceLabel = k.configured ? k.source_type.toUpperCase() : '';
            const sourceBadge = k.configured ? `<span class="key-source-badge ${k.source_type}">${sourceLabel}</span>` : '';

            let html = `<div class="key-row" id="key-row-${k.source}">`;
            html += `<span class="key-status-dot ${statusClass}"></span>`;
            html += `<div class="key-info">`;
            html += `<div class="key-name">${k.source} ${sourceBadge}</div>`;
            html += `<div class="key-desc">${k.description} &mdash; <a href="${k.signup_url}" target="_blank" style="color:var(--accent);">Get key</a></div>`;

            if (k.configured && !isEditing) html += `<span class="key-masked">${k.masked_key}</span>`;

            if (isEditing) {
                html += `<div class="key-edit-row">
                    <input type="password" class="key-edit-input" id="key-input-${k.source}" placeholder="Paste your API key here..." autofocus onkeydown="if(event.key==='Enter')saveKey('${k.source}');if(event.key==='Escape')cancelEdit();">
                    <button class="btn-sm primary" onclick="saveKey('${k.source}')">Save</button>
                    <button class="btn-sm" onclick="cancelEdit()">Cancel</button>
                </div>`;
            }

            html += `<div id="test-result-${k.source}"></div>`;
            html += `</div>`;

            if (!isEditing) {
                html += `<div class="key-actions">`;
                html += `<button class="btn-sm" onclick="editKey('${k.source}')">Edit</button>`;
                if (k.configured) {
                    html += `<button class="btn-sm" onclick="testKey('${k.source}')">Test</button>`;
                    if (k.source_type === 'db') html += `<button class="btn-sm danger" onclick="deleteKey('${k.source}')">Remove</button>`;
                }
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function editKey(source) {
            editingSource = source;
            renderApiKeys();
            setTimeout(() => { const i = document.getElementById(`key-input-${source}`); if (i) i.focus(); }, 50);
        }

        function cancelEdit() { editingSource = null; renderApiKeys(); }

        async function saveKey(source) {
            const input = document.getElementById(`key-input-${source}`);
            if (!input || !input.value.trim()) return;
            input.disabled = true;
            try {
                const res = await fetch(`${API}/settings/api-keys`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({source, key: input.value.trim()})
                });
                if (res.ok) { editingSource = null; await loadApiKeys(); }
                else { const d = await res.json(); showTestResult(source, false, d.detail || 'Failed to save'); input.disabled = false; }
            } catch (err) { showTestResult(source, false, err.message); input.disabled = false; }
        }

        function deleteKey(source) {
            showConfirm(`Remove the stored key for "${escapeHtml(source)}"?`, async () => {
                try {
                    const res = await fetch(`${API}/settings/api-keys/${source}`, {method:'DELETE'});
                    if (res.ok) { showToast(`Key for "${source}" removed`, 'success'); await loadApiKeys(); }
                    else showTestResult(source, false, 'Failed to remove key');
                } catch (err) { showTestResult(source, false, err.message); }
            });
        }

        async function testKey(source) {
            showTestResult(source, null, 'Testing...');
            try { const res = await fetch(`${API}/settings/api-keys/${source}/test`, {method:'POST'}); const d = await res.json(); showTestResult(source, d.success, d.message); }
            catch (err) { showTestResult(source, false, err.message); }
        }

        function showTestResult(source, success, message) {
            const el = document.getElementById(`test-result-${source}`);
            if (!el) return;
            if (success === null) el.innerHTML = `<div class="test-result" style="color:var(--text-muted);">${message}</div>`;
            else el.innerHTML = `<div class="test-result ${success ? 'success' : 'failure'}">${success ? '‚úì' : '‚úó'} ${message}</div>`;
            setTimeout(() => { if (el) el.innerHTML = ''; }, 5000);
        }

        // ==================================================================
        // Active Jobs Panel ‚Äî SSE live updates
        // ==================================================================
        const _activeJobs = new Map(); // job_id -> job data

        function _renderActiveJobs() {
            const panel = document.getElementById('active-jobs-panel');
            const list = document.getElementById('active-jobs-list');
            const countEl = document.getElementById('active-jobs-count');
            if (!panel || !list) return;

            if (_activeJobs.size === 0) {
                panel.classList.remove('visible');
                return;
            }
            panel.classList.add('visible');
            countEl.textContent = `(${_activeJobs.size})`;

            list.innerHTML = '';
            for (const [id, job] of _activeJobs) {
                const pct = job.progress_pct || 0;
                const row = document.createElement('div');
                row.className = 'active-job-item';
                row.id = `active-job-${id}`;
                row.innerHTML = `
                    <span class="job-type-badge">${job.job_type || '?'}</span>
                    <div class="job-progress-bar">
                        <div class="job-progress-fill" style="width:${pct}%"></div>
                    </div>
                    <span class="job-message">${job.progress_message || job.status || ''}</span>
                    ${job.worker_id ? `<span class="job-worker-badge">${job.worker_id}</span>` : ''}
                `;
                list.appendChild(row);
            }
            // Also update Jobs tab active panel if visible
            if (_currentTab === 'jobs') jobsRenderActiveJobs();
        }

        function _removeJobWithFade(jobId) {
            const el = document.getElementById(`active-job-${jobId}`);
            if (el) {
                el.classList.add('job-fade-out');
                setTimeout(() => {
                    _activeJobs.delete(jobId);
                    _renderActiveJobs();
                }, 600);
            } else {
                _activeJobs.delete(jobId);
                _renderActiveJobs();
            }
        }

        // Fetch currently active jobs on page load
        function _loadActiveJobs() {
            fetch('/api/v1/job-queue/active')
                .then(r => r.ok ? r.json() : [])
                .then(jobs => {
                    jobs.forEach(j => _activeJobs.set(j.id, j));
                    _renderActiveJobs();
                })
                .catch(() => {}); // silent fail
        }

        // Connect SSE for live updates
        function _connectJobStream() {
            const es = new EventSource('/api/v1/job-queue/stream');

            es.addEventListener('job_started', e => {
                const d = JSON.parse(e.data);
                _activeJobs.set(d.job_id, {
                    job_type: d.job_type,
                    worker_id: d.worker_id,
                    status: 'running',
                    progress_pct: 0,
                    progress_message: 'Started',
                    started_at: new Date().toISOString(),
                });
                _renderActiveJobs();
                if (currentView === 'detail' && selectedSource) loadSourceJobs(selectedSource.key);
            });

            es.addEventListener('job_progress', e => {
                const d = JSON.parse(e.data);
                const existing = _activeJobs.get(d.job_id) || {};
                _activeJobs.set(d.job_id, {
                    ...existing,
                    progress_pct: d.progress_pct,
                    progress_message: d.progress_message,
                    status: 'running',
                });
                _renderActiveJobs();
            });

            es.addEventListener('job_completed', e => {
                const d = JSON.parse(e.data);
                const existing = _activeJobs.get(d.job_id) || {};
                _activeJobs.set(d.job_id, {
                    ...existing,
                    progress_pct: 100,
                    progress_message: 'Completed',
                    status: 'success',
                });
                _renderActiveJobs();
                setTimeout(() => _removeJobWithFade(d.job_id), 2000);
                if (_currentTab === 'jobs') setTimeout(() => jobsLoadHistory(), 1500);
                if (currentView === 'detail' && selectedSource) setTimeout(() => loadSourceJobs(selectedSource.key), 1500);
            });

            es.addEventListener('job_failed', e => {
                const d = JSON.parse(e.data);
                const existing = _activeJobs.get(d.job_id) || {};
                _activeJobs.set(d.job_id, {
                    ...existing,
                    progress_message: d.error_message || 'Failed',
                    status: 'failed',
                });
                _renderActiveJobs();
                setTimeout(() => _removeJobWithFade(d.job_id), 5000);
                if (_currentTab === 'jobs') setTimeout(() => jobsLoadHistory(), 1500);
                if (currentView === 'detail' && selectedSource) setTimeout(() => loadSourceJobs(selectedSource.key), 1500);
            });

            es.onerror = () => {
                // Reconnect after a delay
                es.close();
                setTimeout(_connectJobStream, 5000);
            };
        }

        // Initialize active jobs on page load
        _loadActiveJobs();
        _connectJobStream();

        // ==================================================================
        // Jobs Dashboard
        // ==================================================================
        let _jobsHistory = [];
        let _jobsHistoryTotal = 0;
        let _jobsHistoryOffset = 0;
        let _jobsElapsedTimers = [];
        let _jobsInitialized = false;

        function jobsInitialize() {
            jobsRenderActiveJobs();
            if (!_jobsInitialized) {
                jobsLoadHistory();
                _jobsInitialized = true;
            }
        }

        function formatDuration(seconds) {
            if (seconds == null) return '-';
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${m}m`;
        }

        function formatElapsed(startedAt) {
            if (!startedAt) return '0:00';
            const elapsed = Math.floor((Date.now() - new Date(startedAt).getTime()) / 1000);
            const m = Math.floor(elapsed / 60);
            const s = elapsed % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function getCheckedValues(name) {
            return [...document.querySelectorAll(`input[name="${name}"]:checked`)].map(c => c.value);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        // ---- Run Collection ----
        function jobsTypeChanged() {
            const type = document.getElementById('jobs-type-select').value;
            const panel = document.getElementById('jobs-options-panel');
            const runBtn = document.getElementById('jobs-run-btn');
            document.getElementById('jobs-run-result').innerHTML = '';
            runBtn.disabled = !type;
            if (!type) { panel.innerHTML = ''; return; }

            const opts = {
                site_intel: `
                    <label style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.25rem;display:block;">Domains</label>
                    <div class="jobs-checkbox-grid">
                        ${['power','telecom','transport','labor','risk','incentives','logistics','water'].map(d =>
                            `<label><input type="checkbox" name="si-domain" value="${d}" checked> ${d}</label>`
                        ).join('')}
                    </div>`,
                people: `
                    <div class="jobs-launcher-row">
                        <div class="jobs-launcher-field" style="flex:1;">
                            <label>Company ID</label>
                            <input type="number" id="jobs-people-company" placeholder="Enter company ID">
                        </div>
                    </div>
                    <div class="jobs-radio-group">
                        <label><input type="radio" name="people-mode" value="test" checked> Test</label>
                        <label><input type="radio" name="people-mode" value="deep"> Deep Collect</label>
                        <label><input type="radio" name="people-mode" value="recursive"> Recursive</label>
                    </div>`,
                pe: `
                    <label style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.25rem;display:block;">Modules</label>
                    <div class="jobs-checkbox-grid">
                        ${['firms','funds','deals','portfolio','people','13f'].map(m =>
                            `<label><input type="checkbox" name="pe-module" value="${m}" checked> ${m}</label>`
                        ).join('')}
                    </div>`,
                lp: `<p style="font-size:0.8rem;color:var(--text-muted);">Runs full LP intelligence collection.</p>`,
                fo: `<p style="font-size:0.8rem;color:var(--text-muted);">Runs full Family Office collection.</p>`,
                agentic: `
                    <div class="jobs-launcher-row">
                        <div class="jobs-launcher-field">
                            <label>Investor ID</label>
                            <input type="number" id="jobs-agentic-investor" placeholder="Investor ID">
                        </div>
                        <div class="jobs-launcher-field">
                            <label>Research Type</label>
                            <select id="jobs-agentic-type">
                                <option value="portfolio">Portfolio Discovery</option>
                                <option value="deep_dive">Deep Dive</option>
                            </select>
                        </div>
                        <div class="jobs-launcher-field" style="display:flex;align-items:center;gap:0.5rem;padding-top:1.25rem;">
                            <input type="checkbox" id="jobs-agentic-headed" style="width:auto;">
                            <label for="jobs-agentic-headed" style="margin:0;cursor:pointer;">Headed Browser (visible)</label>
                        </div>
                    </div>`,
                ingestion: `
                    <div class="jobs-launcher-row">
                        <div class="jobs-launcher-field" style="flex:1;">
                            <label>Source</label>
                            <select id="jobs-ingest-source" onchange="jobsIngestSourceChanged()">
                                <option value="">Select source...</option>
                                ${Object.keys(INGEST_SOURCE_TRIGGERS).sort().map(s =>
                                    `<option value="${s}">${s.replace(/_/g,' ').toUpperCase()}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div id="jobs-ingest-fields" style="margin-top:0.5rem;"></div>
                    ${`<div style="margin-top:0.5rem;">
                        <label style="display:flex;align-items:center;gap:0.35rem;font-size:0.8rem;color:var(--text-muted);cursor:pointer;">
                            <input type="checkbox" id="jobs-ingest-incremental" style="accent-color:var(--primary);"> Incremental pull
                        </label>
                    </div>`}`,
            };
            panel.innerHTML = opts[type] || '';
        }

        // Source-to-trigger mapping for Jobs ingestion form
        const INGEST_SOURCE_TRIGGERS = {
            fred: '/api/v1/fred/ingest',
            bea: '/api/v1/bea/nipa/ingest',
            bls: '/api/v1/bls/{dataset}/ingest',
            census: '/api/v1/census/{level}',
            treasury: '/api/v1/treasury/{type}/ingest',
            eia: '/api/v1/eia/{category}/ingest',
            sec: '/api/v1/sec/ingest/company',
            fdic: '/api/v1/fdic/{type}/ingest',
            cms: '/api/v1/cms/ingest/{dataset}',
            usda: '/api/v1/usda/{dataset}/ingest',
            noaa: '/api/v1/noaa/ingest',
            fbi_crime: '/api/v1/fbi-crime/{dataset}/ingest',
            kaggle: '/api/v1/kaggle/m5/ingest',
            yelp: '/api/v1/yelp/businesses/ingest',
            uspto: '/api/v1/uspto/ingest/{method}',
            fema: '/api/v1/fema/{dataset}/ingest',
            bts: '/api/v1/bts/{dataset}/ingest',
            data_commons: '/api/v1/data-commons/{dataset}/ingest',
            prediction_markets: '/api/v1/prediction-markets/monitor/all',
            international_econ: '/api/v1/international/{dataset}/ingest',
            us_trade: '/api/v1/us-trade/{dataset}/ingest',
            cftc_cot: '/api/v1/cftc-cot/ingest',
            irs_soi: '/api/v1/irs-soi/{dataset}/ingest',
            fcc_broadband: '/api/v1/fcc-broadband/{dataset}/ingest',
            realestate: '/api/v1/realestate/{dataset}/ingest',
            foot_traffic: '/api/v1/foot-traffic/collect',
            form_d: '/api/v1/form-d/ingest',
            form_adv: '/api/v1/form-adv/ingest',
            opencorporates: '/api/v1/opencorporates/ingest',
            app_stores: '/api/v1/app-stores/ingest',
            github: '/api/v1/github/org/{org}/fetch',
            glassdoor: '/api/v1/glassdoor/company',
        };

        function jobsIngestSourceChanged() {
            const source = document.getElementById('jobs-ingest-source')?.value;
            const container = document.getElementById('jobs-ingest-fields');
            const incrCheckbox = document.getElementById('jobs-ingest-incremental');
            if (!container) return;

            // Show/hide incremental based on source
            if (incrCheckbox) {
                incrCheckbox.parentElement.style.display = (source && INCREMENTAL_SOURCES.has(source)) ? 'flex' : 'none';
                incrCheckbox.checked = false;
            }

            if (!source) { container.innerHTML = ''; return; }

            const triggerPath = INGEST_SOURCE_TRIGGERS[source];
            const formDef = triggerPath ? TRIGGER_FORMS[triggerPath] : null;

            if (formDef && ((formDef.pathParams?.length) || (formDef.fields?.length))) {
                container.innerHTML = `<div class="trigger-form-panel" style="animation:none;">` +
                    renderTriggerForm(formDef, 'jobs-ingest') + `</div>`;
            } else {
                container.innerHTML = `<div class="jobs-launcher-field" style="margin-top:0.25rem;">
                    <label>Config (JSON, optional)</label>
                    <textarea id="jobs-ingest-config" rows="2" style="width:100%;font-family:monospace;font-size:0.8rem;" placeholder='{"category": "GDP"}'></textarea>
                </div>`;
            }
        }

        async function jobsRunCollection() {
            const type = document.getElementById('jobs-type-select').value;
            if (!type) return;
            const resultEl = document.getElementById('jobs-run-result');
            resultEl.innerHTML = '<span style="color:var(--text-muted);">Submitting...</span>';

            try {
                let url, body, method = 'POST';
                switch (type) {
                    case 'site_intel': {
                        const domains = getCheckedValues('si-domain');
                        url = '/api/v1/site-intel/sites/collect';
                        body = { domains };
                        break;
                    }
                    case 'people': {
                        const companyId = document.getElementById('jobs-people-company')?.value;
                        if (!companyId) { resultEl.innerHTML = '<div class="jobs-run-result error">Company ID required</div>'; return; }
                        const mode = document.querySelector('input[name="people-mode"]:checked')?.value || 'test';
                        if (mode === 'deep') url = `/api/v1/people-jobs/deep-collect/${companyId}`;
                        else if (mode === 'recursive') url = `/api/v1/people-jobs/recursive-collect/${companyId}`;
                        else url = `/api/v1/people-jobs/test/${companyId}?sources=website`;
                        body = {};
                        break;
                    }
                    case 'pe': {
                        const modules = getCheckedValues('pe-module');
                        url = '/api/v1/pe/collection/collect';
                        body = { modules };
                        break;
                    }
                    case 'lp': { url = '/api/v1/lp-collection/jobs'; body = {}; break; }
                    case 'fo': { url = '/api/v1/fo-collection/jobs'; body = {}; break; }
                    case 'agentic': {
                        const investorId = document.getElementById('jobs-agentic-investor')?.value;
                        const resType = document.getElementById('jobs-agentic-type')?.value || 'portfolio';
                        const headed = document.getElementById('jobs-agentic-headed')?.checked || false;
                        url = '/api/v1/agentic/portfolio/collect';
                        body = { investor_id: parseInt(investorId) || 0, investor_type: 'lp', headed: headed };
                        break;
                    }
                    case 'ingestion': {
                        const source = document.getElementById('jobs-ingest-source')?.value;
                        if (!source) { resultEl.innerHTML = '<div class="jobs-run-result error">Select a source</div>'; return; }
                        const triggerPath = INGEST_SOURCE_TRIGGERS[source];
                        const formDef = triggerPath ? TRIGGER_FORMS[triggerPath] : null;
                        if (formDef && ((formDef.pathParams?.length) || (formDef.fields?.length))) {
                            const collected = collectFormValues(formDef, triggerPath || `/api/v1/${source}/ingest`, {}, 'jobs-ingest');
                            if (collected.error) { resultEl.innerHTML = `<div class="jobs-run-result error">${escapeHtml(collected.error)}</div>`; return; }
                            url = collected.resolvedPath;
                            body = collected.body;
                        } else {
                            let config = {};
                            const configText = document.getElementById('jobs-ingest-config')?.value?.trim();
                            if (configText) { try { config = JSON.parse(configText); } catch { resultEl.innerHTML = '<div class="jobs-run-result error">Invalid JSON config</div>'; return; } }
                            url = `/api/v1/${source}/ingest`;
                            body = config;
                        }
                        const incrEl = document.getElementById('jobs-ingest-incremental');
                        if (incrEl?.checked) body.incremental = true;
                        break;
                    }
                    default: resultEl.innerHTML = '<div class="jobs-run-result error">Unknown type</div>'; return;
                }

                const resp = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await resp.json();
                if (resp.ok) {
                    const jobId = data.job_id || data.id || data.queue_job_id || JSON.stringify(data).substring(0, 80);
                    resultEl.innerHTML = `<div class="jobs-run-result success">Submitted! Job: ${escapeHtml(String(jobId))}</div>`;
                } else {
                    resultEl.innerHTML = `<div class="jobs-run-result error">${resp.status}: ${escapeHtml(data.detail || JSON.stringify(data))}</div>`;
                }
            } catch (err) {
                resultEl.innerHTML = `<div class="jobs-run-result error">${escapeHtml(err.message)}</div>`;
            }
        }

        // ---- Active Jobs (Jobs tab full panel) ----
        function jobsRenderActiveJobs() {
            const list = document.getElementById('jobs-active-list');
            const countEl = document.getElementById('jobs-active-count');
            if (!list) return;

            // Clear old elapsed timers
            _jobsElapsedTimers.forEach(t => clearInterval(t));
            _jobsElapsedTimers = [];

            if (_activeJobs.size === 0) {
                countEl.textContent = '';
                list.innerHTML = '<div class="jobs-active-empty">No active jobs</div>';
                return;
            }
            countEl.textContent = `(${_activeJobs.size})`;
            list.innerHTML = '';

            for (const [id, job] of _activeJobs) {
                const pct = job.progress_pct || 0;
                const row = document.createElement('div');
                row.className = 'active-job-row';
                const typeCls = (job.job_type || '').toLowerCase().replace(/[^a-z_]/g, '');
                row.innerHTML = `
                    <span class="job-type-pill ${typeCls}">${escapeHtml(job.job_type || '?')}</span>
                    <div class="job-progress-bar" style="flex:1;">
                        <div class="job-progress-fill" style="width:${pct}%;${job.status === 'failed' ? 'background:var(--error);' : ''}"></div>
                    </div>
                    <span style="font-size:0.8rem;min-width:35px;text-align:right;">${Math.round(pct)}%</span>
                    <span class="job-message" style="flex:1;">${escapeHtml(job.progress_message || job.status || '')}</span>
                    ${job.worker_id ? `<span class="job-worker-badge">${escapeHtml(job.worker_id)}</span>` : ''}
                    <span class="jobs-elapsed" data-started="${job.started_at || job.claimed_at || ''}">${formatElapsed(job.started_at || job.claimed_at)}</span>
                `;
                list.appendChild(row);
            }

            // Tick elapsed timers every second
            const timer = setInterval(() => {
                if (_currentTab !== 'jobs') return;
                document.querySelectorAll('.jobs-elapsed[data-started]').forEach(el => {
                    const s = el.getAttribute('data-started');
                    if (s) el.textContent = formatElapsed(s);
                });
            }, 1000);
            _jobsElapsedTimers.push(timer);
        }

        // ---- Job History ----
        async function jobsLoadHistory() {
            _jobsHistoryOffset = 0;
            _jobsHistory = [];
            const statusFilter = document.getElementById('jobs-hist-status')?.value || '';
            const typeFilter = document.getElementById('jobs-hist-type')?.value || '';
            let url = `${API}/job-queue/history?limit=50&offset=0`;
            if (statusFilter) url += `&status=${statusFilter}`;
            if (typeFilter) url += `&job_type=${typeFilter}`;

            try {
                const resp = await fetch(url);
                const data = await resp.json();
                _jobsHistory = data.jobs || [];
                _jobsHistoryTotal = data.total || 0;
                _jobsHistoryOffset = _jobsHistory.length;
                jobsRenderHistorySummary(data.summary || {});
                jobsRenderHistoryTable();
                const loadMore = document.getElementById('jobs-load-more');
                if (loadMore) loadMore.classList.toggle('hidden', _jobsHistoryOffset >= _jobsHistoryTotal);
            } catch (err) {
                document.getElementById('jobs-history-body').innerHTML = `<div class="empty">Failed to load history: ${escapeHtml(err.message)}</div>`;
            }
        }

        async function jobsLoadMore() {
            const statusFilter = document.getElementById('jobs-hist-status')?.value || '';
            const typeFilter = document.getElementById('jobs-hist-type')?.value || '';
            let url = `${API}/job-queue/history?limit=50&offset=${_jobsHistoryOffset}`;
            if (statusFilter) url += `&status=${statusFilter}`;
            if (typeFilter) url += `&job_type=${typeFilter}`;

            try {
                const resp = await fetch(url);
                const data = await resp.json();
                const newJobs = data.jobs || [];
                _jobsHistory = _jobsHistory.concat(newJobs);
                _jobsHistoryOffset += newJobs.length;
                jobsRenderHistoryTable();
                const loadMore = document.getElementById('jobs-load-more');
                if (loadMore) loadMore.classList.toggle('hidden', _jobsHistoryOffset >= _jobsHistoryTotal);
            } catch {}
        }

        function jobsRenderHistorySummary(summary) {
            const el = document.getElementById('jobs-summary');
            if (!el) return;
            el.innerHTML = `<div class="jobs-summary">
                <span class="jobs-summary-item running">Running: ${summary.running || 0}</span>
                <span class="jobs-summary-item pending">Pending: ${summary.pending || 0}</span>
                <span class="jobs-summary-item success">Success: ${summary.success || 0}</span>
                <span class="jobs-summary-item failed">Failed: ${summary.failed || 0}</span>
            </div>`;
        }

        function jobsRenderHistoryTable() {
            const body = document.getElementById('jobs-history-body');
            if (!body) return;
            if (_jobsHistory.length === 0) {
                body.innerHTML = '<div class="empty">No jobs found</div>';
                return;
            }

            let html = `<table class="jobs-history-table">
                <thead><tr>
                    <th>ID</th><th>Source</th><th>Type</th><th>Status</th><th>Duration</th><th>Records</th><th>Error</th><th>Started</th>
                </tr></thead><tbody>`;

            for (const job of _jobsHistory) {
                const typeCls = (job.job_type || '').toLowerCase().replace(/[^a-z_]/g, '');
                const statusCls = (job.status || '').toLowerCase();
                const started = job.started_at ? new Date(job.started_at).toLocaleString() : '-';
                const errorSnip = job.error_message ? escapeHtml(job.error_message.substring(0, 50)) + (job.error_message.length > 50 ? '...' : '') : '-';
                html += `<tr onclick="jobsToggleDetail('${job.table}-${job.id}')">
                    <td>${job.id}</td>
                    <td><span class="job-type-pill ${typeCls}">${escapeHtml(job.job_type)}</span></td>
                    <td style="font-size:0.75rem;color:var(--text-muted);">${escapeHtml(job.table)}</td>
                    <td><span class="job-status-badge ${statusCls}">${escapeHtml(job.status)}</span></td>
                    <td>${formatDuration(job.duration_seconds)}</td>
                    <td>${job.rows_inserted != null ? job.rows_inserted.toLocaleString() : '-'}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:${job.error_message ? 'var(--error)' : 'var(--text-muted)'};">${errorSnip}</td>
                    <td style="font-size:0.8rem;color:var(--text-muted);">${started}</td>
                </tr>
                <tr class="jobs-detail-row hidden" id="detail-${job.table}-${job.id}">
                    <td colspan="8">
                        <div class="jobs-detail-content">
                            <div class="detail-row"><span class="detail-label">Created:</span>${job.created_at ? new Date(job.created_at).toLocaleString() : '-'}</div>
                            <div class="detail-row"><span class="detail-label">Started:</span>${job.started_at ? new Date(job.started_at).toLocaleString() : '-'}</div>
                            <div class="detail-row"><span class="detail-label">Completed:</span>${job.completed_at ? new Date(job.completed_at).toLocaleString() : '-'}</div>
                            <div class="detail-row"><span class="detail-label">Duration:</span>${formatDuration(job.duration_seconds)}</div>
                            ${job.worker_id ? `<div class="detail-row"><span class="detail-label">Worker:</span>${escapeHtml(job.worker_id)}</div>` : ''}
                            ${job.progress_message ? `<div class="detail-row"><span class="detail-label">Progress:</span>${escapeHtml(job.progress_message)}</div>` : ''}
                            ${job.error_message ? `<div class="detail-row"><span class="detail-label">Error:</span><span style="color:var(--error);">${escapeHtml(job.error_message)}</span></div>` : ''}
                            <div class="detail-row"><span class="detail-label">Payload:</span></div>
                            <pre>${escapeHtml(JSON.stringify(job.payload, null, 2))}</pre>
                            ${job.status === 'failed' && job.table === 'ingestion_jobs' ? `<button class="btn" style="margin-top:0.5rem;padding:0.35rem 1rem;font-size:0.75rem;" onclick="event.stopPropagation();jobsRetry(${job.id})">Retry</button>` : ''}
                        </div>
                    </td>
                </tr>`;
            }
            html += '</tbody></table>';
            body.innerHTML = html;
        }

        function jobsToggleDetail(key) {
            const el = document.getElementById('detail-' + key);
            if (el) el.classList.toggle('hidden');
        }

        async function jobsRetry(jobId) {
            try {
                const resp = await fetch(`${API}/jobs/${jobId}/retry`, { method: 'POST' });
                if (resp.ok) {
                    showToast('Job retry submitted', 'success');
                    setTimeout(() => jobsLoadHistory(), 500);
                } else {
                    const data = await resp.json();
                    showToast('Retry failed: ' + (data.detail || resp.status), 'error');
                }
            } catch (err) { showToast('Retry error: ' + err.message, 'error'); }
        }

        // ==================================================================
        // Nightly Batch Dashboard
        // ==================================================================
        let _nightlyBatchId = null;
        let _nightlyPollTimer = null;

        async function nightlyLaunch() {
            const btn = document.getElementById('nightly-launch-btn');
            btn.disabled = true;
            btn.textContent = 'Launching...';
            try {
                const resp = await fetch(`${API}/jobs/nightly/launch`, { method: 'POST' });
                if (!resp.ok) { showToast('Launch failed: ' + resp.status, 'error'); return; }
                const data = await resp.json();
                _nightlyBatchId = data.batch_id;
                showToast(`Nightly batch #${data.batch_id} launched (${data.total_jobs} jobs)`, 'success');
                nightlyStartPolling();
            } catch (err) { showToast('Launch error: ' + err.message, 'error'); }
            finally { btn.disabled = false; btn.textContent = 'Launch Batch'; }
        }

        function nightlyStartPolling() {
            if (_nightlyPollTimer) clearInterval(_nightlyPollTimer);
            nightlyRefresh();
            _nightlyPollTimer = setInterval(nightlyRefresh, 5000);
        }

        async function nightlyRefresh() {
            // If no active batch, load history to find the latest
            if (!_nightlyBatchId) {
                try {
                    const resp = await fetch(`${API}/jobs/nightly?limit=5`);
                    if (!resp.ok) return;
                    const batches = await resp.json();
                    nightlyRenderHistory(batches);
                    if (batches.length > 0 && batches[0].status === 'running') {
                        _nightlyBatchId = batches[0].batch_id;
                        nightlyStartPolling();
                    }
                } catch (e) { /* ignore */ }
                return;
            }
            // Poll active batch
            try {
                const resp = await fetch(`${API}/jobs/nightly/${_nightlyBatchId}`);
                if (!resp.ok) return;
                const data = await resp.json();
                nightlyRenderStatus(data);
                nightlyRenderTiers(data);
                if (data.status !== 'running') {
                    clearInterval(_nightlyPollTimer);
                    _nightlyPollTimer = null;
                    _nightlyBatchId = null;
                    // Refresh history
                    const hr = await fetch(`${API}/jobs/nightly?limit=5`);
                    if (hr.ok) nightlyRenderHistory(await hr.json());
                }
            } catch (e) { /* ignore */ }
        }

        function nightlyRenderStatus(data) {
            const el = document.getElementById('nightly-status');
            const statusColors = { running: '#f0ad4e', completed: '#5cb85c', failed: '#d9534f', partial_success: '#f0ad4e' };
            const elapsed = data.elapsed_seconds ? `${Math.round(data.elapsed_seconds / 60)}m ${Math.round(data.elapsed_seconds % 60)}s` : '‚Äî';
            el.innerHTML = `
                <div style="display:flex;gap:1.5rem;align-items:center;flex-wrap:wrap;margin-bottom:0.5rem;">
                    <div><span style="color:var(--text-muted);font-size:0.8rem;">Batch</span><br><strong>#${data.batch_id}</strong></div>
                    <div><span style="color:var(--text-muted);font-size:0.8rem;">Status</span><br><span style="color:${statusColors[data.status] || 'inherit'};font-weight:600;">${data.status.toUpperCase()}</span></div>
                    <div><span style="color:var(--text-muted);font-size:0.8rem;">Progress</span><br><strong>${data.completed_jobs + data.failed_jobs}/${data.total_jobs}</strong></div>
                    <div><span style="color:var(--text-muted);font-size:0.8rem;">Success</span><br><span style="color:#5cb85c;font-weight:600;">${data.successful_jobs}</span></div>
                    <div><span style="color:var(--text-muted);font-size:0.8rem;">Failed</span><br><span style="color:${data.failed_jobs > 0 ? '#d9534f' : 'inherit'};font-weight:600;">${data.failed_jobs}</span></div>
                    <div><span style="color:var(--text-muted);font-size:0.8rem;">Running</span><br><strong>${data.running_jobs}</strong></div>
                    <div><span style="color:var(--text-muted);font-size:0.8rem;">Elapsed</span><br><strong>${elapsed}</strong></div>
                </div>
                <div style="background:var(--bg-card);border-radius:4px;height:8px;overflow:hidden;margin-top:0.25rem;">
                    <div style="height:100%;width:${data.total_jobs ? Math.round(((data.completed_jobs + data.failed_jobs) / data.total_jobs) * 100) : 0}%;background:linear-gradient(90deg,#5cb85c,#4cae4c);transition:width 0.3s;"></div>
                </div>`;
        }

        function nightlyRenderTiers(data) {
            const el = document.getElementById('nightly-tiers');
            if (!data.tier_status || Object.keys(data.tier_status).length === 0) { el.innerHTML = ''; return; }
            const tierNames = { tier_1: 'Tier 1 ‚Äî Fast Gov APIs', tier_2: 'Tier 2 ‚Äî Medium APIs', tier_3: 'Tier 3 ‚Äî Complex/SEC', tier_4: 'Tier 4 ‚Äî Agentic/LLM' };
            let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:0.75rem;margin-top:0.75rem;">';
            for (const [key, t] of Object.entries(data.tier_status).sort()) {
                const done = t.completed + t.failed;
                const pct = t.total ? Math.round((done / t.total) * 100) : 0;
                const status = done === t.total ? (t.failed === 0 ? '‚úÖ' : '‚ö†Ô∏è') : (t.running > 0 ? 'üîÑ' : '‚è≥');
                html += `<div style="background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:8px;padding:0.75rem;">
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.25rem;">${status} ${tierNames[key] || key}</div>
                    <div style="font-weight:600;margin-bottom:0.35rem;">${done}/${t.total} <span style="color:var(--text-muted);font-weight:400;font-size:0.8rem;">(${t.running} running)</span></div>
                    <div style="background:var(--bg-body);border-radius:3px;height:6px;overflow:hidden;">
                        <div style="height:100%;width:${pct}%;background:${t.failed > 0 ? '#f0ad4e' : '#5cb85c'};transition:width 0.3s;"></div>
                    </div>
                </div>`;
            }
            html += '</div>';
            el.innerHTML = html;
        }

        function nightlyRenderHistory(batches) {
            const el = document.getElementById('nightly-history');
            if (!batches || batches.length === 0) {
                el.innerHTML = '<div style="color:var(--text-muted);font-size:0.85rem;">No batch runs yet. Click "Launch Batch" to start.</div>';
                return;
            }
            let html = '<div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:0.35rem;">Recent Batches</div>';
            html += '<div style="display:flex;flex-direction:column;gap:0.35rem;">';
            for (const b of batches) {
                const colors = { completed: '#5cb85c', failed: '#d9534f', running: '#f0ad4e', partial_success: '#f0ad4e' };
                const ts = b.started_at ? new Date(b.started_at).toLocaleString() : '‚Äî';
                html += `<div style="display:flex;align-items:center;gap:1rem;font-size:0.85rem;padding:0.35rem 0;border-bottom:1px solid var(--border-subtle);cursor:pointer;" onclick="_nightlyBatchId=${b.batch_id};nightlyStartPolling();">
                    <span style="font-weight:600;">#${b.batch_id}</span>
                    <span style="color:${colors[b.status] || 'inherit'};">${b.status}</span>
                    <span>${b.completed_jobs}/${b.total_jobs} jobs</span>
                    <span style="color:var(--text-muted);">${ts}</span>
                </div>`;
            }
            html += '</div>';
            el.innerHTML = html;
        }

        // Load nightly status when Jobs tab is shown
        const _origJobsInit = typeof jobsInitialize === 'function' ? jobsInitialize : null;
        jobsInitialize = function() {
            if (_origJobsInit) _origJobsInit();
            nightlyRefresh();
        };

        // ==================================================================
        // Hash-based URL routing ‚Äî e.g. #/cms navigates to CMS detail
        // ==================================================================
        function handleHashRoute() {
            const hash = location.hash.replace(/^#\/?/, '');
            if (!hash) return;
            const found = findSourceByKey(hash);
            if (found) {
                openSourceDetail(hash, found.catKey);
            }
        }

        window.addEventListener('hashchange', handleHashRoute);

        // On initial page load, navigate to hash route if present
        handleHashRoute();

    </script>
</body>
</html>
